#cloud-config

# ===== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê –°–ï–†–í–ï–†–ê –î–õ–Ø FITNESSBOTAI =====
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç Ubuntu 24.04 —Å–µ—Ä–≤–µ—Ä –¥–ª—è –¥–µ–ø–ª–æ—è Telegram –±–æ—Ç–∞

# –û—Ç–∫–ª—é—á–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ubuntu –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
users: []

# –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã
package_update: true
package_upgrade: true

packages:
  # Node.js –∏ npm
  - nodejs
  - npm
  # Git –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
  - git
  # Nginx –¥–ª—è reverse proxy –∏ SSL
  - nginx
  # Certbot –¥–ª—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
  - certbot
  - python3-certbot-nginx
  # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  - htop
  - curl
  - wget
  - unzip
  # Firewall
  - ufw
  # PM2 process manager (–±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ npm)
  - build-essential

# –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤
runcmd:
  # ===== –ù–ê–°–¢–†–û–ô–ö–ê NODE.JS =====
  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é LTS –≤–µ—Ä—Å–∏—é Node.js
  - curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
  - apt-get install -y nodejs
  
  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –≥–ª–æ–±–∞–ª—å–Ω–æ
  - npm install -g pm2
  
  # ===== –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –î–õ–Ø –ë–û–¢–ê =====
  - useradd -m -s /bin/bash botuser
  - usermod -aG sudo botuser
  - mkdir -p /home/botuser/.ssh
  - chown botuser:botuser /home/botuser/.ssh
  - chmod 700 /home/botuser/.ssh
  
  # ===== –ö–õ–û–ù–ò–†–û–í–ê–ù–ò–ï –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø =====
  - cd /home/botuser
  - sudo -u botuser git clone https://github.com/Dmitry140340/GymMindAI.git
  - chown -R botuser:botuser /home/botuser/GymMindAI
  
  # ===== –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–û–ï–ö–¢–ê =====
  - cd /home/botuser/GymMindAI
  - sudo -u botuser npm install
  - sudo -u botuser mkdir -p data
  - sudo -u botuser chmod 755 data
  
  # ===== –ù–ê–°–¢–†–û–ô–ö–ê NGINX =====
  - systemctl enable nginx
  - systemctl start nginx
  
  # –£–¥–∞–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
  - rm -f /etc/nginx/sites-enabled/default
  
  # ===== –ù–ê–°–¢–†–û–ô–ö–ê FIREWALL =====
  - ufw --force enable
  - ufw allow ssh
  - ufw allow http
  - ufw allow https
  - ufw allow 3004/tcp
  
  # ===== –ù–ê–°–¢–†–û–ô–ö–ê –ê–í–¢–û–ó–ê–ü–£–°–ö–ê =====
  - sudo -u botuser pm2 startup
  - env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u botuser --hp /home/botuser
  
  # ===== –°–û–ó–î–ê–ù–ò–ï –î–ò–†–ï–ö–¢–û–†–ò–ô –î–õ–Ø –õ–û–ì–û–í =====
  - mkdir -p /var/log/fitnessbotai
  - chown botuser:botuser /var/log/fitnessbotai
  
  # ===== –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´ =====
  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è Node.js
  - echo "botuser soft nofile 65536" >> /etc/security/limits.conf
  - echo "botuser hard nofile 65536" >> /etc/security/limits.conf
  
  # ===== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò =====
  - apt install -y unattended-upgrades
  - dpkg-reconfigure -plow unattended-upgrades

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
write_files:
  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –¥–ª—è –±–æ—Ç–∞
  - path: /etc/nginx/sites-available/fitnessbotai
    owner: root:root
    permissions: '0644'
    content: |
      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –¥–ª—è FitnessBotAI
      
      # Rate limiting
      limit_req_zone $binary_remote_addr zone=webhook:10m rate=10r/s;
      limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;
      
      server {
          listen 80;
          server_name _;
          
          # Webhook endpoint —Å rate limiting
          location /webhook {
              limit_req zone=webhook burst=5 nodelay;
              
              proxy_pass http://localhost:3004;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_cache_bypass $http_upgrade;
              
              # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º timeout –¥–ª—è webhook
              proxy_connect_timeout 60s;
              proxy_send_timeout 60s;
              proxy_read_timeout 60s;
          }
          
          # Payment webhook
          location /webhook/payment {
              limit_req zone=webhook burst=3 nodelay;
              
              proxy_pass http://localhost:3004;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
          
          # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          location /health {
              limit_req zone=api burst=10 nodelay;
              proxy_pass http://localhost:3004;
          }
          
          # –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ —Å–ª—É–∂–µ–±–Ω—ã–º —Ñ–∞–π–ª–∞–º
          location ~ /\. {
              deny all;
              access_log off;
              log_not_found off;
          }
      }

  # Ecosystem —Ñ–∞–π–ª –¥–ª—è PM2
  - path: /home/botuser/GymMindAI/ecosystem.production.config.js
    owner: botuser:botuser
    permissions: '0644'
    content: |
      module.exports = {
        apps: [{
          name: 'fitnessbotai',
          script: 'src/index.js',
          instances: 1,
          exec_mode: 'fork',
          max_memory_restart: '1G',
          node_args: '--max-old-space-size=1024',
          env: {
            NODE_ENV: 'production',
            PORT: 3004
          },
          log_file: '/var/log/fitnessbotai/combined.log',
          out_file: '/var/log/fitnessbotai/out.log',
          error_file: '/var/log/fitnessbotai/error.log',
          log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
          merge_logs: true,
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
          watch: false,
          ignore_watch: ['node_modules', 'data', 'logs'],
          
          // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
          restart_delay: 1000,
          max_restarts: 10,
          min_uptime: '10s'
        }]
      };

  # –®–∞–±–ª–æ–Ω .env —Ñ–∞–π–ª–∞
  - path: /home/botuser/GymMindAI/.env.template
    owner: botuser:botuser
    permissions: '0600'
    content: |
      # ===== –ù–ê–°–¢–†–û–ô–ö–ò TELEGRAM –ë–û–¢–ê =====
      TELEGRAM_BOT_TOKEN=YOUR_BOT_TOKEN_HERE
      TELEGRAM_BOT_USERNAME=YOUR_BOT_USERNAME_HERE
      
      # ===== –ù–ê–°–¢–†–û–ô–ö–ò COZE API =====
      COZE_API_KEY=YOUR_COZE_API_KEY_HERE
      COZE_BOT_ID=YOUR_COZE_BOT_ID_HERE
      COZE_WORKFLOW_ID=YOUR_WORKFLOW_ID_HERE
      
      # –û—Ç–¥–µ–ª—å–Ω—ã–µ Workflow ID
      COZE_DEEP_RESEARCH_WORKFLOW_ID=YOUR_WORKFLOW_ID_HERE
      COZE_TRAINING_PROGRAM_WORKFLOW_ID=YOUR_WORKFLOW_ID_HERE
      COZE_NUTRITION_PLAN_WORKFLOW_ID=YOUR_WORKFLOW_ID_HERE
      COZE_COMPOSITION_ANALYSIS_WORKFLOW_ID=YOUR_WORKFLOW_ID_HERE
      
      # ===== –ù–ê–°–¢–†–û–ô–ö–ò YOOKASSA =====
      PAYMENT_MODE=production
      YOOKASSA_PROD_SHOP_ID=YOUR_SHOP_ID_HERE
      YOOKASSA_PROD_SECRET_KEY=YOUR_SECRET_KEY_HERE
      
      # ===== –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–†–í–ï–†–ê =====
      PORT=3004
      WEBHOOK_URL=https://YOUR_DOMAIN.com/webhook
      
      # ===== –ë–ê–ó–ê –î–ê–ù–ù–´–• =====
      DATABASE_PATH=./data/subscriptions.db
      
      # ===== –¶–ï–ù–´ –ü–û–î–ü–ò–°–û–ö =====
      BASIC_PRICE=150
      STANDARD_PRICE=300
      PREMIUM_PRICE=450
      
      # ===== –ê–î–ú–ò–ù =====
      ADMIN_IDS=YOUR_TELEGRAM_ID_HERE

  # –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è
  - path: /home/botuser/GymMindAI/deploy-production.sh
    owner: botuser:botuser
    permissions: '0755'
    content: |
      #!/bin/bash
      
      echo "üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è FitnessBotAI –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ..."
      
      # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
      cd /home/botuser/GymMindAI
      
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª
      if [ ! -f .env ]; then
          echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–∫–æ–ø–∏—Ä—É–π—Ç–µ .env.template –≤ .env –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ."
          exit 1
      fi
      
      # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
      npm install --production
      
      # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–∞)
      echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏..."
      pm2 stop fitnessbotai || true
      pm2 delete fitnessbotai || true
      
      # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
      echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
      pm2 start ecosystem.production.config.js
      
      # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
      pm2 save
      
      # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
      ln -sf /etc/nginx/sites-available/fitnessbotai /etc/nginx/sites-enabled/
      nginx -t && systemctl reload nginx
      
      echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
      echo "üìä –°—Ç–∞—Ç—É—Å: pm2 status"
      echo "üìÑ –õ–æ–≥–∏: pm2 logs fitnessbotai"
      
      pm2 status

  # –°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  - path: /home/botuser/monitor.sh
    owner: botuser:botuser
    permissions: '0755'
    content: |
      #!/bin/bash
      
      echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ FitnessBotAI"
      echo "=========================="
      
      # –°—Ç–∞—Ç—É—Å PM2
      echo "üîÑ PM2 —Å—Ç–∞—Ç—É—Å:"
      pm2 status
      
      echo ""
      echo "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:"
      free -h
      
      echo ""
      echo "üíΩ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞:"
      df -h
      
      echo ""
      echo "‚ö° –ó–∞–≥—Ä—É–∑–∫–∞ CPU:"
      top -bn1 | grep "Cpu(s)" | awk '{print $2 + $4}'
      
      echo ""
      echo "üåê –°–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
      netstat -tuln | grep :3004
      
      echo ""
      echo "üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞:"
      tail -n 10 /var/log/fitnessbotai/combined.log

# –§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
final_message: |
  ===== –°–ï–†–í–ï–† FITNESSBOTAI –ù–ê–°–¢–†–û–ï–ù! =====
  
  –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
  1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É: ssh root@YOUR_SERVER_IP
  2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env: cp /home/botuser/GymMindAI/.env.template /home/botuser/GymMindAI/.env
  3. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
  4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: sudo -u botuser /home/botuser/GymMindAI/deploy-production.sh
  
  –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
  - –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: sudo -u botuser pm2 status
  - –õ–æ–≥–∏: sudo -u botuser pm2 logs fitnessbotai
  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: sudo -u botuser /home/botuser/monitor.sh
  - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: sudo -u botuser pm2 restart fitnessbotai
  
  –§–∞–π–ª—ã –ª–æ–≥–æ–≤: /var/log/fitnessbotai/
  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx: /etc/nginx/sites-available/fitnessbotai
