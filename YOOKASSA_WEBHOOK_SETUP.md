# Руководство по настройке webhook ЮКассы

## 🎯 Цель
Настроить автоматическую обработку платежей через ЮКассу для фитнес-бота.

## 📋 Предварительные требования

1. **Сервер запущен** на `http://85.198.80.51:3000`
2. **Nginx прокси настроен** для HTTPS на порту 443
3. **SSL сертификат** настроен (ЮКасса работует только с HTTPS)
4. **Бот активен** и отвечает на команды
5. **База данных** инициализирована

⚠️ **КРИТИЧЕСКИ ВАЖНО**: ЮКасса принимает webhook только на порты 443 или 8443!

## 🔧 Шаги настройки

### 1. Проверка готовности системы

Убедитесь, что сервер отвечает:
```bash
# Проверка локального приложения
curl http://85.198.80.51:3000/health

# Проверка через HTTPS (после настройки прокси)
curl https://85.198.80.51/health
```

Должен вернуть:
```json
{
  "status": "OK",
  "timestamp": "2025-09-20T..."
}
```

### 2. Настройка прокси для webhook (ОБЯЗАТЕЛЬНО!)

ЮКасса принимает webhook только на портах 443 или 8443. Нужно настроить Nginx прокси:

#### 2.1 Проверка текущего состояния
```bash
# Проверьте, работает ли ваше приложение на порту 3000
curl http://85.198.80.51:3000/webhook/payment

# Проверьте, настроен ли Nginx
curl https://85.198.80.51/webhook/payment
```

#### 2.2 Автоматическая настройка сервера (РЕКОМЕНДУЕТСЯ)
Используйте готовый скрипт для автоматической настройки:

```bash
ssh root@85.198.80.51

# Скачайте файлы с GitHub
cd /root/GymMindAI
git pull origin main

# Запустите автоматическую настройку
bash setup_yookassa_webhook.sh
```

Скрипт автоматически:
- ✅ Проверит работу приложения на порту 3000
- ✅ Настроит Nginx прокси на порт 443
- ✅ Настроит SSL сертификат
- ✅ Откроет необходимые порты в файрволле
- ✅ Проверит доступность всех endpoint'ов

#### 2.3 Ручная настройка Nginx (если автоскрипт не сработал)
```bash
# Создайте конфигурацию вручную
cat > /etc/nginx/sites-available/gymmind-webhook << 'EOF'
server {
    listen 443 ssl http2;
    server_name 85.198.80.51;
    
    ssl_certificate /etc/letsencrypt/live/85.198.80.51/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/85.198.80.51/privkey.pem;
    
    location /webhook/payment {
        proxy_pass http://127.0.0.1:3000/webhook/payment;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Yookassa-Signature $http_x_yookassa_signature;
    }
    
    location /health {
        proxy_pass http://127.0.0.1:3000/health;
    }
}

server {
    listen 80;
    server_name 85.198.80.51;
    return 301 https://$server_name$request_uri;
}
EOF

# Активируйте конфигурацию
ln -s /etc/nginx/sites-available/gymmind-webhook /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx
```

### 3. Настройка в личном кабинете ЮКассы

#### 3.1 Войти в личный кабинет
- Перейдите на https://yookassa.ru
- Войдите в личный кабинет магазина

#### 3.2 Настройка HTTP-уведомлений
1. В боковом меню найдите **"Настройки"** → **"Уведомления"**
2. Выберите **"HTTP-уведомления"**
3. Нажмите **"Добавить endpoint"**

#### 3.3 Параметры webhook
- **URL:** `https://85.198.80.51/webhook/payment`
- **События:** 
  - ✅ `payment.succeeded` (ОБЯЗАТЕЛЬНО)
  - ⚪ `payment.waiting_for_capture` (опционально)
  - ⚪ `payment.canceled` (опционально)
- **Статус:** ✅ Включено
- **Формат:** JSON
- **HTTP метод:** POST

⚠️ **КРИТИЧЕСКИ ВАЖНО:** 
- ✅ URL должен быть HTTPS
- ✅ Порт только 443 или 8443
- ✅ Сервер должен отвечать кодом 200

#### 3.4 Пример успешной настройки
```
HTTP-уведомления
URL для уведомлений: https://85.198.80.51/webhook/payment
Адрес для получения уведомлений

Выбранные события:
✅ payment.succeeded - Успешный платёж
```

#### 3.5 Проверка в ЮКассе
После сохранения ЮКасса автоматически проверит доступность URL. Убедитесь что:
- ✅ Статус проверки: "Успешно"
- ✅ Последняя проверка: недавняя дата
- ✅ Ошибок нет
- ✅ URL принят без ошибок портов

#### 3.4 Дополнительные события (опционально)
Можно также подписаться на:
- `payment.waiting_for_capture`
- `payment.canceled`
- `refund.succeeded`

### 4. Настройка SSL сертификата (если не настроен)

#### 4.1 Let's Encrypt (рекомендуется)
```bash
# Установка certbot
apt update && apt install certbot python3-certbot-nginx

# Получение сертификата
certbot --nginx -d 85.198.80.51 --non-interactive --agree-tos -m your-email@example.com

# Автообновление
echo "0 12 * * * /usr/bin/certbot renew --quiet" | crontab -
```

#### 4.2 Самоподписанный сертификат (для тестирования)
```bash
# Создание самоподписанного сертификата
mkdir -p /etc/ssl/private
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/ssl/private/server.key \
  -out /etc/ssl/certs/server.crt \
  -subj "/C=RU/ST=Moscow/L=Moscow/O=GymMind/CN=85.198.80.51"
```

### 5. Проверка секретного ключа

Убедитесь, что в `.env` файле на сервере указан правильный секретный ключ:

**Для тестового режима:**
```env
YOOKASSA_TEST_SHOP_ID=1139867
YOOKASSA_TEST_SECRET_KEY=test_hczBNmYmZ4vs8QaSMsyGHFdtU_3X039YoTcFS4L7DMo
PAYMENT_MODE=test
```

**Для продакшн режима:**
```env
YOOKASSA_PROD_SHOP_ID=1048732
YOOKASSA_PROD_SECRET_KEY=live_E2dE-ecYsexDzsBT-AzkDNeZ2HWPCBGQ52yPO6LdnIs
PAYMENT_MODE=production
```

### 5. Альтернативные решения для портов

#### Вариант 1: Изменить порт приложения на 8443
```bash
# В .env файле измените:
PORT=8443

# Перезапустите приложение
systemctl restart gymmind-bot

# URL для ЮКассы будет: https://85.198.80.51:8443/webhook/payment
```

#### Вариант 2: Использовать ngrok (для тестирования)
```bash
# Установите ngrok
npm install -g ngrok

# Запустите туннель
ngrok http 3000

# Используйте предоставленный HTTPS URL в ЮКассе
# Например: https://abc123.ngrok.io/webhook/payment
```

#### Вариант 3: Cloudflare Tunnel (бесплатно)
```bash
# Установите cloudflared
# Настройте туннель на порт 3000
cloudflared tunnel --url http://localhost:3000

# Получите публичный HTTPS URL
```

### 6. Тестирование настроенного webhook

#### 6.1 Автоматический тест
Запустите тестовый скрипт (URL уже обновлен):
```bash
node test_webhook_payment.js
```

#### 6.2 Тест через ЮКассу
1. В личном кабинете ЮКассы перейдите в **"Настройки" → "Уведомления"**
2. Найдите ваш webhook `https://85.198.80.51/webhook/payment`
3. Нажмите **"Проверить"** или **"Отправить тестовое уведомление"**
4. ЮКасса пошлет тестовый webhook на ваш сервер

#### 6.3 Тест реальным платежом
Создайте тестовый платеж:
1. Запустите бота в Telegram
2. Выберите любой план подписки
3. Используйте тестовую карту: `4111 1111 1111 1111`
4. CVC: `123`, срок: любой будущий месяц/год
5. После оплаты должно прийти уведомление с кнопками

#### 6.4 Мониторинг логов
На сервере отслеживайте логи:
```bash
# Логи бота
journalctl -u gymmind-bot -f

# Или если используется PM2
pm2 logs gymmind-bot --lines 50

# Логи Nginx
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

## 🔍 Проверка работы системы

### 1. Проверка логов на сервере
```bash
# Подключение к серверу
ssh root@85.198.80.51

# Просмотр логов бота
journalctl -u gymmind-bot -f

# Или если используется PM2
pm2 logs gymmind-bot
```

### 2. Проверка в Telegram
1. Создайте тестовый платеж через бота
2. Оплатите тестовой картой: `4111 1111 1111 1111`
3. Проверьте, что приходит уведомление об успешной оплате
4. Убедитесь, что подписка активирована

### 3. Проверка базы данных
```bash
# На сервере
sqlite3 /root/GymMindAI/data/subscriptions.db

# Проверить активные подписки
SELECT * FROM subscriptions WHERE status = 'active';

# Проверить последние платежи
SELECT * FROM subscriptions ORDER BY created_at DESC LIMIT 5;
```

## 📊 Мониторинг и отладка

### Типичные ошибки и решения

#### 1. Webhook не получает уведомления
- ✅ Проверьте, что URL доступен извне
- ✅ Убедитесь, что используется HTTPS
- ✅ Проверьте настройки файрволла
- ✅ Убедитесь, что порт 3000 открыт

#### 2. Ошибки обработки платежей
- ✅ Проверьте логи сервера
- ✅ Убедитесь, что база данных инициализирована
- ✅ Проверьте переменные окружения

#### 3. Уведомления не приходят в Telegram
- ✅ Проверьте токен бота в `.env`
- ✅ Убедитесь, что бот не заблокирован
- ✅ Проверьте правильность Telegram ID

### Полезные команды для отладки

#### Проверка webhook в ЮКассе
```bash
# Получить список webhooks
curl -X GET https://api.yookassa.ru/v3/webhooks \
  -H "Authorization: Basic <base64(shopId:secretKey)>"
```

#### Тест подключения к базе данных
```bash
# На сервере
node -e "
import('./src/services/database.js').then(async (db) => {
  await db.initDatabase();
  console.log('Database OK');
});
"
```

## ✅ Быстрая проверка готовности

### Автоматическая проверка всех компонентов
```bash
# На сервере запустите полную проверку:
bash check_yookassa_ready.sh
```

Скрипт проверит:
- ✅ Работу приложения на порту 3000  
- ✅ Доступность HTTPS endpoints
- ✅ Статус Nginx и бота
- ✅ Наличие базы данных
- ✅ Действительность SSL сертификата
- ✅ Настройки ЮКассы в .env

### Ручная проверка (если нужно)
- [ ] **Сервер отвечает**: `curl https://85.198.80.51/health`
- [ ] **Webhook доступен**: `curl https://85.198.80.51/webhook/payment` 
- [ ] **ЮКасса настроена**: URL `https://85.198.80.51/webhook/payment` принят
- [ ] **События выбраны**: `payment.succeeded` включено
- [ ] **SSL работает**: сайт открывается по HTTPS без ошибок
- [ ] **Тест проходит**: `node test_webhook_payment.js` работает без ошибок
- [ ] **Бот отвечает**: команда `/start` работает в Telegram
- [ ] **База данных**: подключена и инициализирована

## 🎉 Готово!

После выполнения всех шагов:

1. **Система готова** принимать реальные платежи
2. **Webhook настроен** на правильный порт 443
3. **ЮКасса принимает** уведомления без ошибок портов  
4. **Пользователи получают** уведомления об оплате
5. **Подписки активируются** автоматически

## 📞 Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Запустите тестовый скрипт
3. Убедитесь в доступности всех сервисов
4. Проверьте настройки в ЮКассе

---

**Важно:** Перед переходом в продакшн режим обязательно протестируйте всю цепочку на тестовых данных!