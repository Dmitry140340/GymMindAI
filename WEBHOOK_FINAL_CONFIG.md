# ‚úÖ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê WEBHOOK YOOKASSA

## üîß –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!

YooKassa —Ç—Ä–µ–±—É–µ—Ç webhook URL:
- ‚úÖ –ü—Ä–æ—Ç–æ–∫–æ–ª: `https://` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- ‚úÖ –ü–æ—Ä—Ç: —Ç–æ–ª—å–∫–æ **443** (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTTPS) –∏–ª–∏ **8443**
- ‚ùå –ü–æ—Ä—Ç 3004 - **–ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢–°–Ø**

## üìã –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Webhook URL –¥–ª—è YooKassa:
```
https://85.198.80.51/webhook/payment
```

**–ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –ø–æ—Ä—Ç–∞!** Nginx –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –ø–æ—Ä—Ç–∞ 443 –Ω–∞ –ø–æ—Ä—Ç 3004.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```
YooKassa ‚Üí https://85.198.80.51/webhook/payment (–ø–æ—Ä—Ç 443)
    ‚Üì
Nginx (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ) –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç ‚Üí
    ‚Üì
Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (localhost:3004)
```

## ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ YooKassa

1. –ó–∞–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç: https://yookassa.ru/
2. –í—ã–±–µ—Ä–∏—Ç–µ **–ø—Ä–æ–¥–∞–∫—à–Ω –º–∞–≥–∞–∑–∏–Ω** (Shop ID: 1158662)
3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** (HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
4. –î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ webhook:

   **URL:**
   ```
   https://85.198.80.51/webhook/payment
   ```
   
   **–°–æ–±—ã—Ç–∏–µ:**
   - ‚úÖ `payment.succeeded` (–£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂)

5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ endpoint
```bash
curl https://85.198.80.51/webhook/payment
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "message": "Payment webhook endpoint is ready",
  "method": "Use POST to send payment notifications",
  "timestamp": "...",
  "server_ip": "..."
}
```

### –¢–µ—Å—Ç 2: –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂

1. –í –±–æ—Ç–µ: **üíé –ü–æ–¥–ø–∏—Å–∫–∞** ‚Üí **üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É**
2. –í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–π –ø–ª–∞–Ω
3. –ù–∞–∂–º–∏—Ç–µ **üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å**
4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ
5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã YooKassa –æ—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ webhook
6. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å `npm start` –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:

```
üîî Payment webhook received at: 2025-10-08T...
üì® Headers: {...}
üì¶ Body: {"event":"payment.succeeded",...}
‚úÖ Payment successful for user 659874549, plan: premium
üí∞ Payment successfully processed...
```

## üìä –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### .env —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω:
```env
# Webhook URL (–ë–ï–ó –ü–û–†–¢–ê –¥–ª—è YooKassa!)
YOOKASSA_WEBHOOK_URL=https://85.198.80.51/webhook/payment
WEBHOOK_DOMAIN=https://85.198.80.51

# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3004 (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)
PORT=3004
```

### YooKassa –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
- **Shop ID:** 1158662
- **–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á:** live_K3s91l3KmJ0dmefZPQbsp2f9SOB6Yz458N0xR1krHKg
- **Webhook URL:** https://85.198.80.51/webhook/payment
- **–°–æ–±—ã—Ç–∏–µ:** payment.succeeded

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### 1. Nginx –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω
–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç:
```nginx
location /webhook/payment {
    proxy_pass http://localhost:3004/webhook/payment;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 2. SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º
YooKassa —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
```bash
curl -v https://85.198.80.51/webhook/payment 2>&1 | grep "SSL certificate"
```

–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Let's Encrypt:
```bash
sudo certbot --nginx -d yourdomain.com
```

### 3. Firewall –¥–æ–ª–∂–µ–Ω —Ä–∞–∑—Ä–µ—à–∞—Ç—å HTTPS
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
sudo ufw allow 443/tcp
sudo ufw status
```

## üéØ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è:
- ‚úÖ Webhook URL –±–µ–∑ –ø–æ—Ä—Ç–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ nginx –Ω–∞ 443)
- ‚úÖ –ù–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- ‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º–µ
- ‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –Ω–∞ –º–µ—Å—Ç–µ (100% –ø–æ–∫—Ä—ã—Ç–∏–µ)

## üí≥ –ú–æ–∂–µ—Ç–µ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É!

–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ webhook.

---

**–î–∞—Ç–∞:** 08.10.2025  
**Webhook URL:** https://85.198.80.51/webhook/payment  
**–ü–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:** 3004 (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É –ø–ª–∞—Ç–µ–∂–µ–π
