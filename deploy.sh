#!/bin/bash

# ๐ Deploy Script for GymMindAI Bot
# ะะฒัะพะผะฐัะธัะตัะบะธะน ะดะตะฟะปะพะน ัะธัะฝะตั-ะฑะพัะฐ ั ะะ

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน GymMindAI Bot..."

# ะัะพะฒะตัะบะฐ Node.js
if ! command -v node &> /dev/null; then
    echo "โ Node.js ะฝะต ะฝะฐะนะดะตะฝ. ะฃััะฐะฝะพะฒะธัะต Node.js ะดะปั ะฟัะพะดะพะปะถะตะฝะธั."
    exit 1
fi

echo "โ Node.js ะฒะตััะธั: $(node --version)"

# ะัะพะฒะตัะบะฐ npm
if ! command -v npm &> /dev/null; then
    echo "โ npm ะฝะต ะฝะฐะนะดะตะฝ. ะฃััะฐะฝะพะฒะธัะต npm ะดะปั ะฟัะพะดะพะปะถะตะฝะธั."
    exit 1
fi

echo "โ npm ะฒะตััะธั: $(npm --version)"

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
npm install

if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ัััะฐะฝะพะฒะบะธ ะทะฐะฒะธัะธะผะพััะตะน"
    exit 1
fi

echo "โ ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"

# ะัะพะฒะตัะบะฐ .env ัะฐะนะปะฐ
if [ ! -f ".env" ]; then
    echo "โ ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ. ะกะบะพะฟะธััะนัะต .env.example ะฒ .env ะธ ะฝะฐัััะพะนัะต ะฟะตัะตะผะตะฝะฝัะต."
    exit 1
fi

echo "โ ะคะฐะนะป .env ะฝะฐะนะดะตะฝ"

# ะัะพะฒะตัะบะฐ ะบัะธัะธัะตัะบะธั ะฟะตัะตะผะตะฝะฝัั
required_vars=("TELEGRAM_BOT_TOKEN" "COZE_API_KEY" "COZE_BOT_ID" "YOOKASSA_PROD_SHOP_ID" "YOOKASSA_PROD_SECRET_KEY")

for var in "${required_vars[@]}"; do
    if ! grep -q "^${var}=" .env; then
        echo "โ ะะตัะตะผะตะฝะฝะฐั ${var} ะฝะต ะฝะฐัััะพะตะฝะฐ ะฒ .env"
        exit 1
    fi
done

echo "โ ะัะต ะบัะธัะธัะตัะบะธะต ะฟะตัะตะผะตะฝะฝัะต ะฝะฐัััะพะตะฝั"

# ะะฝะธัะธะฐะปะธะทะฐัะธั ะฑะฐะทั ะดะฐะฝะฝัั
echo "๐๏ธ ะะฝะธัะธะฐะปะธะทะฐัะธั ะฑะฐะทั ะดะฐะฝะฝัั..."
mkdir -p data

# ะะฐะฟััะบ ัะตััะพะฒ
echo "๐งช ะะฐะฟััะบ ัะตััะพะฒ..."
node test_coze.js
if [ $? -ne 0 ]; then
    echo "โ๏ธ ะขะตััั Coze API ะฝะต ะฟัะพัะปะธ, ะฝะพ ะฟัะพะดะพะปะถะฐะตะผ ะดะตะฟะปะพะน"
fi

node test_database.js
if [ $? -ne 0 ]; then
    echo "โ๏ธ ะขะตััั ะฑะฐะทั ะดะฐะฝะฝัั ะฝะต ะฟัะพัะปะธ, ะฝะพ ะฟัะพะดะพะปะถะฐะตะผ ะดะตะฟะปะพะน"
fi

# ะะฐะฟััะบ ะฑะพัะฐ ะฒ ะฟัะพะดะฐะบัะตะฝะต
echo "๐ค ะะฐะฟััะบ ะฑะพัะฐ ะฒ ะฟัะพะดะฐะบัะตะฝะต..."

# ะะปั PM2 (ะตัะปะธ ัััะฐะฝะพะฒะปะตะฝ)
if command -v pm2 &> /dev/null; then
    echo "๐ ะะฐะฟััะบ ัะตัะตะท PM2..."
    pm2 start ecosystem.config.json
    pm2 save
    echo "โ ะะพั ะทะฐะฟััะตะฝ ัะตัะตะท PM2"
else
    echo "๐ ะะฐะฟััะบ ะฝะฐะฟััะผัั..."
    nohup npm start > bot.log 2>&1 &
    echo $! > bot.pid
    echo "โ ะะพั ะทะฐะฟััะตะฝ ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต"
    echo "๐ ะะพะณะธ: tail -f bot.log"
    echo "๐ ะััะฐะฝะพะฒะบะฐ: kill $(cat bot.pid)"
fi

echo ""
echo "๐ ะะะะะะ ะะะะะะจะะ ะฃะกะะะจะะ!"
echo ""
echo "๐ ะะฝัะพัะผะฐัะธั ะพ ะดะตะฟะปะพะต:"
echo "๐ค Telegram Bot: @FitnessTrainerAI_bot"
echo "๐ Webhook: http://localhost:3004/webhook/payment"
echo "๐พ ะะฐะทะฐ ะดะฐะฝะฝัั: ./data/subscriptions.db"
echo ""
echo "๐ ะะปะฐะฝั ะฟะพะดะฟะธัะพะบ:"
echo "โข Basic: 150โฝ (100 ะทะฐะฟัะพัะพะฒ)"
echo "โข Standard: 300โฝ (300 ะทะฐะฟัะพัะพะฒ)"  
echo "โข Premium: 450โฝ (600 ะทะฐะฟัะพัะพะฒ)"
echo ""
echo "๐ ะะพั ะณะพัะพะฒ ะบ ัะฐะฑะพัะต!"
