// –ü—Ä–∏–º–µ—Ä –±–æ—Ç–∞-–ø—Ä–æ–∫—Å–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –æ—Å–Ω–æ–≤–Ω—ã–º Coze-–±–æ—Ç–æ–º
// –≠—Ç–æ—Ç –∫–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–æ–∫–µ–Ω—ã

import TelegramBot from 'node-telegram-bot-api';
import axios from 'axios';

// –¢–æ–∫–µ–Ω –û–¢–î–ï–õ–¨–ù–û–ì–û –±–æ—Ç–∞-–ø—Ä–æ–∫—Å–∏ (–Ω–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ!)
const PROXY_BOT_TOKEN = 'your_proxy_bot_token_here';
const VERIFICATION_API_URL = 'https://your-domain.com/api/verify-token';
const MAIN_COZE_BOT_USERNAME = 'your_main_coze_bot_username';

const bot = new TelegramBot(PROXY_BOT_TOKEN, { polling: true });

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis)
const verifiedUsers = new Map();

// –ö–æ–º–∞–Ω–¥–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
bot.onText(/\/verify (.+)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const token = match[1].trim();

  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ API
    const response = await axios.post(VERIFICATION_API_URL, {
      token: token,
      telegram_id: userId
    });

    if (response.data.success) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      verifiedUsers.set(userId, {
        verified: true,
        plan_type: response.data.plan_type,
        end_date: response.data.end_date,
        verified_at: new Date()
      });

      await bot.sendMessage(chatId, 
        `‚úÖ –¢–æ–∫–µ–Ω –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!\n\n` +
        `üíé –ü–ª–∞–Ω: ${response.data.plan_type === 'monthly' ? '–ú–µ—Å—è—á–Ω—ã–π' : '–ì–æ–¥–æ–≤–æ–π'}\n` +
        `üìÖ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ${new Date(response.data.end_date).toLocaleDateString('ru-RU')}\n\n` +
        `ü§ñ –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–æ–º! –ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å.`
      );
    } else {
      await bot.sendMessage(chatId, 
        `‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${response.data.error}\n\n` +
        `–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n` +
        `‚Ä¢ –¢–æ–∫–µ–Ω –≤–≤–µ–¥–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ\n` +
        `‚Ä¢ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∏—Å—Ç–µ–∫–ª–∞\n` +
        `‚Ä¢ –¢–æ–∫–µ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞—à–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É`
      );
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:', error);
    await bot.sendMessage(chatId, 
      '‚ùå –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–±–æ–π –ø—Ä–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.'
    );
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const text = msg.text;

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
  if (text && text.startsWith('/')) {
    if (text === '/start') {
      await bot.sendMessage(chatId,
        `ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä!\n\n` +
        `–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ò–ò –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É:\n` +
        `/verify –≤–∞—à_—Ç–æ–∫–µ–Ω_–¥–æ—Å—Ç—É–ø–∞\n\n` +
        `üí° –¢–æ–∫–µ–Ω –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –±–æ—Ç–µ.`
      );
    }
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  const userVerification = verifiedUsers.get(userId);
  
  if (!userVerification || !userVerification.verified) {
    await bot.sendMessage(chatId,
      `üîí –î–ª—è –æ–±—â–µ–Ω–∏—è —Å –ò–ò –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è.\n\n` +
      `–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É: /verify –≤–∞—à_—Ç–æ–∫–µ–Ω`
    );
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞
  if (new Date(userVerification.end_date) < new Date()) {
    verifiedUsers.delete(userId);
    await bot.sendMessage(chatId,
      `‚è∞ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞.\n\n` +
      `–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–±—â–µ–Ω–∏—è —Å –ò–ò –ø—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∏ –ø–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω.`
    );
    return;
  }

  // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –±–æ—Ç—É
  await bot.sendMessage(chatId,
    `ü§ñ –í–∞—à –≤–æ–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç! –ü–µ—Ä–µ–∞–¥—Ä–µ—Å–æ–≤—ã–≤–∞—é –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É...\n\n` +
    `üì± –î–ª—è –±–æ–ª–µ–µ —É–¥–æ–±–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –±–æ—Ç—É: @${MAIN_COZE_BOT_USERNAME}\n\n` +
    `üí¨ –í–∞—à –≤–æ–ø—Ä–æ—Å: "${text}"\n\n` +
    `‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...`
  );

  // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä—è–º—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Coze API
  // –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –¥–∞–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
});

console.log('ü§ñ –ë–æ—Ç-–ø—Ä–æ–∫—Å–∏ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');

export default bot;
