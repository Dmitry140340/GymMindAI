
# üöÄ –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –æ–ø–ª–∞—Ç–∏–≤—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üéØ –°–∏—Ç—É–∞—Ü–∏—è
–î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–≤–µ—Ä—à–∏–ª–∏ –æ–ø–ª–∞—Ç—É, –Ω–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É.

## ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## üìã –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô

### –®–∞–≥ 1: –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞
```bash
node diagnosis_payment_system.js
```
–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫"

### –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤—Ä—É—á–Ω—É—é
```bash
node fix_existing_payments.js
```

**–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ–¥–∏—Ç–µ:**
- Telegram ID (–º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å –∏–∑ –ª–æ–≥–æ–≤ –±–æ—Ç–∞ –∏–ª–∏ YooKassa)
- –¢–∏–ø –ø–ª–∞–Ω–∞ (basic/standard/premium)
- ID –ø–ª–∞—Ç–µ–∂–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∏—Ç–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π `/start`
2. –ù–∞–∂–∞—Ç—å "üìä –ú–æ–π —Å—Ç–∞—Ç—É—Å" 
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

## üîç –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± (—á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö)

–ï—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

```sql
-- –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT * FROM users WHERE telegram_id = 'TELEGRAM_ID_–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏
SELECT s.* FROM subscriptions s 
JOIN users u ON s.user_id = u.id 
WHERE u.telegram_id = 'TELEGRAM_ID_–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø';

-- –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
INSERT INTO subscriptions 
(user_id, plan_type, status, start_date, end_date, payment_id, requests_limit, requests_used, created_at, updated_at)
SELECT u.id, 'standard', 'active', datetime('now'), datetime('now', '+1 month'), 'manual_fix_' || datetime('now'), 300, 0, datetime('now'), datetime('now')
FROM users u WHERE u.telegram_id = 'TELEGRAM_ID_–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø';
```

## üì® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–æ–æ–±—â–µ–Ω–∏–µ:

```
üéâ –î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!

‚úÖ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å: /start ‚Üí "üìä –ú–æ–π —Å—Ç–∞—Ç—É—Å"  
üöÄ –¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞

–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞!
```

## üîß –ú–û–ù–ò–¢–û–†–ò–ù–ì (–¥–ª—è –±—É–¥—É—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π)

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook URL –≤ YooKassa:
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: `https://–≤–∞—à-–¥–æ–º–µ–Ω.com/webhook/payment`
- –°—Ç–∞—Ç—É—Å: –∞–∫—Ç–∏–≤–µ–Ω

### 2. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:
```bash
# –õ–æ–≥–∏ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
tail -f logs/server.log | grep "Payment webhook"

# –õ–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫  
tail -f logs/server.log | grep "subscription"
```

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∞–¥–º–∏–Ω–∞:
```env
ADMIN_TELEGRAM_ID=–≤–∞—à_telegram_id
```

## üéØ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã

–¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ curl:
```bash
curl -X POST http://localhost:3004/webhook/payment \
  -H "Content-Type: application/json" \
  -d '{
    "event": "payment.succeeded",
    "object": {
      "id": "test_' $(date +%s) '",
      "status": "succeeded", 
      "paid": true,
      "amount": {"value": "300.00", "currency": "RUB"},
      "metadata": {
        "telegram_id": "–í–ê–®_TELEGRAM_ID",
        "plan_type": "standard"  
      }
    }
  }'
```

## ‚ö° –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–æ—á–Ω–æ –¥–∞—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
1. –£–∑–Ω–∞–π—Ç–µ –µ–≥–æ Telegram ID
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
node -e "
import('./src/services/database.js').then(async (db) => {
  await db.initDatabase();
  const result = await db.updateUserSubscription(TELEGRAM_ID, {
    subscription_type: 'standard',
    subscription_end: new Date(Date.now() + 30*24*60*60*1000).toISOString(),
    requests_limit: 300,
    requests_used: 0,
    payment_id: 'manual_' + Date.now()
  });
  console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
  process.exit(0);
});
"
```

## ‚úÖ –ü–†–û–í–ï–†–û–ß–ù–´–ô –°–ü–ò–°–û–ö

- [ ] –°–∏—Å—Ç–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
- [ ] –ù–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞  
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –¥–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ `fix_existing_payments.js`
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω—ã –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–∞
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –¥–æ—Å—Ç—É–ø –≤ –±–æ—Ç–µ
- [ ] Webhook URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ YooKassa
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–†–µ–∑—É–ª—å—Ç–∞—Ç: –í—Å–µ –æ–ø–ª–∞—Ç–∏–≤—à–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É! üöÄ**