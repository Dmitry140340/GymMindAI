# üéØ –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `INSERT OR REPLACE` –∫–æ—Ç–æ—Ä—ã–π –º–æ–≥ –∑–∞—Ç–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
- **–†–µ—à–µ–Ω–∏–µ**: –¢–µ–ø–µ—Ä—å —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `expired`, –∞ –Ω–æ–≤—ã–µ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `active`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è –∏ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è

### 2. **–£–ª—É—á—à–µ–Ω webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫**
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ YooKassa (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è)
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ù–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 3. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `CURRENT_TIMESTAMP` –≤ SQL
- **–†–µ—à–µ–Ω–∏–µ**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `start_date` –∏ `end_date` –≤ JavaScript
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–¥–ø–∏—Å–∫–∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è

### 4. **–£–ª—É—á—à–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–Ω–µ, –ª–∏–º–∏—Ç–∞—Ö, –¥–∞—Ç–∞—Ö
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –Ω–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö
- **–î–æ–±–∞–≤–ª–µ–Ω–æ**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## üîß –î–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–≤—É–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```bash
node fix_existing_payments.js
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ YooKassa** - –Ω–∞–π–¥–∏—Ç–µ ID –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**:
```sql
-- –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
SELECT u.telegram_id, u.id, s.* 
FROM users u 
LEFT JOIN subscriptions s ON u.id = s.user_id 
WHERE u.telegram_id IN (ID_–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø_1, ID_–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø_2);

-- –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é:
-- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
INSERT INTO subscriptions 
(user_id, plan_type, status, start_date, end_date, payment_id, requests_limit, requests_used, created_at, updated_at)
VALUES 
([USER_ID], 'standard', 'active', datetime('now'), datetime('now', '+1 month'), '[PAYMENT_ID]', 300, 0, datetime('now'), datetime('now'));
```

## üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã:
```bash
# –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞—Ç–µ–∂–µ–π
node test_payment_system_fixed.js

# –¢–µ—Å—Ç webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞  
node test_webhook_handler_fixed.js
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook endpoint:
```bash
curl -X POST http://localhost:3004/webhook/payment \
  -H "Content-Type: application/json" \
  -d '{
    "event": "payment.succeeded",
    "object": {
      "id": "test_payment_123",
      "status": "succeeded", 
      "paid": true,
      "amount": {"value": "300.00", "currency": "RUB"},
      "metadata": {
        "telegram_id": "TEST_USER_ID",
        "plan_type": "standard"
      }
    }
  }'
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
1. **Webhook –ø–æ–ª—É—á–µ–Ω**: `üîî Payment webhook received`
2. **–ü–æ–¥–ø–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞**: `‚úÖ New subscription created successfully`
3. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ**: `üì® Success notification sent to user`

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
```env
ADMIN_TELEGRAM_ID=YOUR_TELEGRAM_ID  # –î–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
YOOKASSA_SECRET_KEY=your_secret     # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook –ø–æ–¥–ø–∏—Å–∏
PAYMENT_MODE=test|production        # –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞** —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø** —É –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø–ª–∞—Ç–∏–ª–∏
3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
4. **–î–æ–±–∞–≤—å—Ç–µ –≤ YooKassa** –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL webhook: `https://your-domain.com/webhook/payment`

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

–ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ metadata –ø–ª–∞—Ç–µ–∂–∞ –µ—Å—Ç—å `telegram_id` –∏ `plan_type`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–æ—Ç –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã:
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –±–µ–∑ —Å–±–æ–µ–≤

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—Ç –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã!** üöÄ