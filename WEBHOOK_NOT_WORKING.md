# ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: Webhook YooKassa –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

## üî¥ –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ

–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã 150‚ÇΩ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

**Payment ID:** `30787ba1-000f-5001-9000-1466f59e17bb`  
**–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞:** `paid: true` (–¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–Ω—ã)  
**–°—Ç–∞—Ç—É—Å –≤ –±–æ—Ç–µ:** –ü–æ–¥–ø–∏—Å–∫–∞ –ù–ï –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞  
**–ü—Ä–∏—á–∏–Ω–∞:** Webhook –æ—Ç YooKassa –Ω–µ –ø—Ä–∏—à–µ–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä

## ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –≤—Ä—É—á–Ω—É—é

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞:
```bash
node activate_subscription_manual.js
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ ID: 43
- ‚úÖ –ü–ª–∞–Ω: –ë–∞–∑–æ–≤—ã–π (100 –∑–∞–ø—Ä–æ—Å–æ–≤)
- ‚úÖ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: 08.11.2025
- ‚úÖ –°—Ç–∞—Ç—É—Å: active

## üîß –ù–ï–û–ë–•–û–î–ò–ú–û –ò–°–ü–†–ê–í–ò–¢–¨ WEBHOOK!

### –ü—Ä–æ–±–ª–µ–º–∞

YooKassa **–ù–ï –û–¢–ü–†–ê–í–õ–Ø–ï–¢** —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞:
```
https://85.198.80.51/webhook/payment
```

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

1. **Webhook –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ YooKassa**
   - –ó–∞–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å webhook –Ω–∞ `https://85.198.80.51/webhook/payment`

2. **–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
   curl https://85.198.80.51/webhook/payment
   ```
   
   **–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å:**
   ```json
   {
     "message": "Payment webhook endpoint is ready",
     "method": "Use POST to send payment notifications"
   }
   ```

3. **Nginx –Ω–µ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã**
   - –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ nginx
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥: `/etc/nginx/sites-available/default`

4. **SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ–≤–∞–ª–∏–¥–µ–Ω**
   - YooKassa —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π SSL
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: `curl -v https://85.198.80.51/webhook/payment`

5. **Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã**
   - –ü–æ—Ä—Ç 443 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: `sudo ufw status`

## üìã –®–∞–≥–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ YooKassa

1. –ó–∞–π–¥–∏—Ç–µ –≤ https://yookassa.ru/
2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥–∞–∫—à–Ω –º–∞–≥–∞–∑–∏–Ω (Shop ID: 1158662)
3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)**
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook:

   **URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:**
   ```
   https://85.198.80.51/webhook/payment
   ```
   
   **–°–æ–±—ã—Ç–∏–µ:**
   - ‚úÖ `payment.succeeded`

5. –ï—Å–ª–∏ webhook –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ!

---

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞

**–° –≤–∞—à–µ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞:**
```bash
curl https://85.198.80.51/webhook/payment
```

**–ò–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:**
```
https://85.198.80.51/webhook/payment
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "message": "Payment webhook endpoint is ready",
  "method": "Use POST to send payment notifications",
  "timestamp": "2025-10-08T...",
  "server_ip": "..."
}
```

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞:**
- –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- –ü–æ—Ä—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
- SSL –ø—Ä–æ–±–ª–µ–º—ã

---

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Nginx

**–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@85.198.80.51

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥ nginx
cat /etc/nginx/sites-available/default | grep -A 10 webhook
```

**–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```nginx
location /webhook/payment {
    proxy_pass http://localhost:3004/webhook/payment;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

**–ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –¥–æ–±–∞–≤—å—Ç–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ nginx:**
```bash
sudo nginx -t
sudo systemctl reload nginx
```

---

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL
curl -v https://85.198.80.51/webhook/payment 2>&1 | grep -i ssl

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: SSL certificate verify ok
```

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ SSL - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Let's Encrypt:**
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com
```

---

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
sudo ufw status

# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç 443
# –ï—Å–ª–∏ –Ω–µ—Ç - –æ—Ç–∫—Ä–æ–π—Ç–µ:
sudo ufw allow 443/tcp
sudo ufw reload
```

---

### –®–∞–≥ 6: –¢–µ—Å—Ç–æ–≤—ã–π webhook

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ webhook –≤—Ä—É—á–Ω—É—é:

```bash
# –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π POST –∑–∞–ø—Ä–æ—Å
curl -X POST https://85.198.80.51/webhook/payment \
  -H "Content-Type: application/json" \
  -d '{
    "event": "payment.succeeded",
    "object": {
      "id": "test-payment-id",
      "status": "succeeded",
      "paid": true,
      "metadata": {
        "telegram_id": "659874549",
        "plan_type": "basic",
        "requests_limit": "100"
      },
      "amount": {
        "value": "150.00",
        "currency": "RUB"
      }
    }
  }'
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞:**
–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
üîî Payment webhook received
‚úÖ Payment successful for user 659874549
```

---

## üö® –í–†–ï–ú–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï

–ü–æ–∫–∞ webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤—Ä—É—á–Ω—É—é:

### –î–ª—è —Å–µ–±—è:
–í –±–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:
```
/admin_premium
```

### –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
1. –ü–æ–ª—É—á–∏—Ç–µ Payment ID –∏–∑ –ª–æ–≥–æ–≤ –±–æ—Ç–∞
2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `activate_subscription_manual.js`:
   ```javascript
   const PAYMENT_ID = '–ò–ó_–õ–û–ì–û–í';
   const TELEGRAM_ID = ID_–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø;
   const PLAN_TYPE = 'basic'; // –∏–ª–∏ 'standard', 'premium'
   const AMOUNT = 150; // –∏–ª–∏ 300, 450
   ```
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ:
   ```bash
   node activate_subscription_manual.js
   ```

---

## üìä –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–±–ª–µ–º—ã

### –ü–ª–∞—Ç–µ–∂ ‚Ññ1
- **Date:** 08.10.2025 13:32
- **Payment ID:** 30787ba1-000f-5001-9000-1466f59e17bb
- **Amount:** 150‚ÇΩ
- **Status:** ‚úÖ paid
- **Webhook:** ‚ùå –ù–ï –ø–æ–ª—É—á–µ–Ω
- **–†–µ—à–µ–Ω–∏–µ:** –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤—Ä—É—á–Ω—É—é —Å–∫—Ä–∏–ø—Ç–æ–º

---

## ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫

–ü–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –ø–ª–∞—Ç–µ–∂–æ–º —É–±–µ–¥–∏—Ç–µ—Å—å:

- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ YooKassa (https://85.198.80.51/webhook/payment)
- [ ] –°–æ–±—ã—Ç–∏–µ `payment.succeeded` –≤–∫–ª—é—á–µ–Ω–æ
- [ ] –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (curl –ø—Ä–æ–≤–µ—Ä–∫–∞)
- [ ] Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç /webhook/payment –Ω–∞ localhost:3004
- [ ] SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞–ª–∏–¥–µ–Ω
- [ ] Firewall —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ—Ä—Ç 443
- [ ] –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3004
- [ ] –í –ª–æ–≥–∞—Ö –±–æ—Ç–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è "üîî Payment webhook received" –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

---

## üìû –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è

1. **–°–†–û–ß–ù–û:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –≤ YooKassa (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤—ã—à–µ)
2. **–í–ê–ñ–ù–û:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
3. **–¢–ï–°–¢:** –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π webhook (curl –∫–æ–º–∞–Ω–¥–∞ –≤—ã—à–µ)
4. **–ü–†–û–í–ï–†–ö–ê:** –°–¥–µ–ª–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

**–î–∞—Ç–∞:** 08.10.2025  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è Webhook –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞  
**–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
