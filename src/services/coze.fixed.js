import axios from 'axios';
import dotenv from 'dotenv';

dotenv.config();

const COZE_API_BASE_URL = 'https://api.coze.com';

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ workflow
export async function runWorkflow(workflowId, parameters) {
  try {
    console.log('üöÄ –ó–∞–ø—É—Å–∫ workflow:', { workflowId, parameters });
    console.log('üîë API Key –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç:', !!process.env.COZE_API_KEY);

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–æ—Ä–∫—Ñ–ª–æ—É –ø–æ ID
    const interactiveWorkflows = [
      process.env.COZE_TRAINING_PROGRAM_WORKFLOW_ID,
      process.env.COZE_NUTRITION_PLAN_WORKFLOW_ID
    ];
    
    const isInteractive = interactiveWorkflows.includes(workflowId);
    
    if (isInteractive) {
      console.log('üîÑ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow - –∏—Å–ø–æ–ª—å–∑—É–µ–º Chatflow API');
      // –î–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ—Ä–∫—Ñ–ª–æ—É –∏—Å–ø–æ–ª—å–∑—É–µ–º Chatflow API
      return await runInteractiveWorkflow(workflowId, parameters);
    } else {
      console.log('‚ö° –ü—Ä–æ—Å—Ç–æ–π workflow - –∏—Å–ø–æ–ª—å–∑—É–µ–º Workflow API');
      // –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ—Ä–∫—Ñ–ª–æ—É –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Workflow API
      return await runSimpleWorkflow(workflowId, parameters);
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ç–∏–ø–∞ workflow:', error.message);
    return {
      success: false,
      error: `–û—à–∏–±–∫–∞ workflow: ${error.message}`
    };
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ—Ä–∫—Ñ–ª–æ—É (deepresearch, composition_analysis)
async function runSimpleWorkflow(workflowId, parameters) {
  try {
    console.log('üåê API URL:', `${COZE_API_BASE_URL}/v1/workflow/run`);

    const requestData = {
      workflow_id: workflowId,
      parameters: parameters,
      is_async: false
    };

    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Coze Workflow API:', JSON.stringify(requestData, null, 2));

    const response = await axios.post(
      `${COZE_API_BASE_URL}/v1/workflow/run`,
      requestData,
      {
        headers: {
          'Authorization': `Bearer ${process.env.COZE_API_KEY}`,
          'Content-Type': 'application/json'
        },
        timeout: 300000 // 5 –º–∏–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç
      }
    );

    console.log('üì• –û—Ç–≤–µ—Ç workflow API:', {
      status: response.status,
      code: response.data?.code,
      data: response.data
    });

    if (response.data && response.data.code === 0) {
      let workflowData = response.data.data;
      let resultMessage = null;
      
      console.log('üîç –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ workflow:', typeof workflowData, workflowData);
      
      // –ï—Å–ª–∏ data —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ JSON, –ø–∞—Ä—Å–∏–º –µ—ë
      if (typeof workflowData === 'string') {
        try {
          workflowData = JSON.parse(workflowData);
          console.log('üìã –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ workflow:', workflowData);
        } catch (e) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –¥–∞–Ω–Ω—ã–µ workflow:', e.message);
        }
      }
      
      // –ò—â–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–ª—è—Ö
      if (workflowData?.output_final) {
        resultMessage = workflowData.output_final;
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω output_final:', resultMessage.substring(0, 100) + '...');
      } else if (workflowData?.output) {
        resultMessage = workflowData.output;
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω output:', resultMessage.substring(0, 100) + '...');
      } else if (workflowData?.result) {
        resultMessage = workflowData.result;
      } else if (workflowData?.answer) {
        resultMessage = workflowData.answer;
      } else if (typeof workflowData === 'string') {
        resultMessage = workflowData;
      }
      
      console.log('‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç workflow:', resultMessage ? '–ù–∞–π–¥–µ–Ω' : '–ù–µ –Ω–∞–π–¥–µ–Ω');
      
      return {
        success: true,
        data: response.data.data,
        message: resultMessage || 'Workflow –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ'
      };
    } else {
      console.log('‚ùå –û—à–∏–±–∫–∞ workflow:', response.data);
      return {
        success: false,
        error: response.data?.msg || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ workflow'
      };
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ—Å—Ç–æ–≥–æ workflow:', {
      status: error.response?.status,
      statusText: error.response?.statusText,
      data: error.response?.data,
      message: error.message
    });
    
    return {
      success: false,
      error: `–û—à–∏–±–∫–∞ workflow: ${error.response?.data?.msg || error.message}`
    };
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ—Ä–∫—Ñ–ª–æ—É (training_program, nutrition_plan) - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Chatflow API
async function runInteractiveWorkflow(workflowId, parameters) {
  try {
    console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º Chatflow API –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ workflow');
    
    const userInput = parameters.input;
    console.log('üìù –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Chatflow API:', userInput);
    
    const chatflowData = {
      workflow_id: workflowId,
      bot_id: process.env.COZE_BOT_ID,
      additional_messages: [
        {
          role: 'user',
          content: userInput,
          content_type: 'text'
        }
      ]
    };

    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Coze Chatflow API:', JSON.stringify(chatflowData, null, 2));

    const response = await axios.post(
      `${COZE_API_BASE_URL}/v1/workflows/chat`,
      chatflowData,
      {
        headers: {
          'Authorization': `Bearer ${process.env.COZE_API_KEY}`,
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream'
        },
        timeout: 300000, // 5 –º–∏–Ω—É—Ç —Ç–∞–π–º–∞—É—Ç
        responseType: 'stream'
      }
    );

    console.log('üì• –ù–∞—á–∞–ª–æ –ø–æ–ª—É—á–µ–Ω–∏—è streaming –æ—Ç–≤–µ—Ç–∞ –æ—Ç Chatflow API');

    return new Promise((resolve, reject) => {
      let fullResponse = '';
      let isCompleted = false;
      
      response.data.on('data', (chunk) => {
        const chunkString = chunk.toString();
        const lines = chunkString.split('\n');
        
        for (const line of lines) {
          if (line.trim() === '' || !line.startsWith('data: ')) continue;
          
          try {
            const data = line.slice(6).trim(); // –£–±–∏—Ä–∞–µ–º "data: "
            
            if (data === '[DONE]') {
              console.log('‚úÖ Chatflow –∑–∞–≤–µ—Ä—à–µ–Ω');
              isCompleted = true;
              resolve({
                success: true,
                data: { content: fullResponse },
                message: fullResponse || '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ'
              });
              return;
            }
            
            const eventData = JSON.parse(data);
            console.log('üì® –°–æ–±—ã—Ç–∏–µ Chatflow:', eventData.event);
            
            // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏–∑ —Å–æ–±—ã—Ç–∏–π
            if (eventData.event === 'conversation.message.delta' && eventData.data?.content) {
              fullResponse += eventData.data.content;
            } else if (eventData.event === 'conversation.message.completed' && eventData.data?.content) {
              fullResponse = eventData.data.content;
            } else if (eventData.event === 'done') {
              console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ done');
              isCompleted = true;
              resolve({
                success: true,
                data: { content: fullResponse },
                message: fullResponse || '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ'
              });
              return;
            }
            
          } catch (parseError) {
            console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–±—ã—Ç–∏—è:', parseError.message, '–î–∞–Ω–Ω—ã–µ:', line);
          }
        }
      });
      
      response.data.on('end', () => {
        console.log('‚úÖ –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        if (!isCompleted) {
          resolve({
            success: true,
            data: { content: fullResponse },
            message: fullResponse || '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ'
          });
        }
      });
      
      response.data.on('error', (streamError) => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–∞:', streamError);
        reject({
          success: false,
          error: `–û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–∞: ${streamError.message}`
        });
      });
      
      // –¢–∞–π–º–∞—É—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
      setTimeout(() => {
        if (!isCompleted) {
          console.log('‚è∞ –¢–∞–π–º–∞—É—Ç Chatflow');
          resolve({
            success: true,
            data: { content: fullResponse },
            message: fullResponse || '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow –≤—ã–ø–æ–ª–Ω–µ–Ω (—Ç–∞–π–º–∞—É—Ç)'
          });
        }
      }, 120000); // 2 –º–∏–Ω—É—Ç—ã
    });

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ workflow:', {
      status: error.response?.status,
      statusText: error.response?.statusText,
      data: error.response?.data,
      message: error.message
    });
    
    return {
      success: false,
      error: `–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ workflow: ${error.response?.data?.msg || error.message}`
    };
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Coze AI —á–µ—Ä–µ–∑ Chat API
export async function sendMessageToCoze(message, userId, conversationId = null) {
  try {
    // –ï—Å–ª–∏ –µ—Å—Ç—å API –∫–ª—é—á - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ chat API
    if (process.env.COZE_API_KEY && process.env.COZE_BOT_ID && 
        !process.env.COZE_API_KEY.includes('your_')) {
      
      console.log('ü§ñ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Coze Chat API:', {
        botId: process.env.COZE_BOT_ID,
        message: message.substring(0, 50) + '...',
        userId
      });

      const chatData = {
        bot_id: process.env.COZE_BOT_ID,
        user_id: userId.toString(),
        stream: false,
        auto_save_history: true,
        additional_messages: [
          {
            role: 'user',
            content: message,
            content_type: 'text'
          }
        ]
      };

      if (conversationId) {
        chatData.conversation_id = conversationId;
      }

      const response = await axios.post(
        `${COZE_API_BASE_URL}/v3/chat`,
        chatData,
        {
          headers: {
            'Authorization': `Bearer ${process.env.COZE_API_KEY}`,
            'Content-Type': 'application/json'
          },
          timeout: 120000 // 2 –º–∏–Ω—É—Ç—ã —Ç–∞–π–º–∞—É—Ç
        }
      );

      if (response.data && response.data.code === 0) {
        const chatResponse = response.data.data;
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        if (chatResponse?.messages && Array.isArray(chatResponse.messages)) {
          const assistantMessages = chatResponse.messages.filter(msg => msg.role === 'assistant');
          
          if (assistantMessages.length > 0) {
            const fullMessage = assistantMessages
              .map(msg => msg.content || '')
              .join('\n\n')
              .trim();
            
            return {
              success: true,
              data: fullMessage,
              conversationId: chatResponse.conversation_id
            };
          }
        }
        
        return {
          success: false,
          error: '–ù–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞'
        };
      } else {
        return {
          success: false,
          error: response.data?.msg || '–û—à–∏–±–∫–∞ API'
        };
      }
    } else {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é –æ—Ç–≤–µ—Ç–∞
      return await simulateAIResponse(message, userId);
    }
  } catch (error) {
    console.error('Error calling Coze API:', {
      status: error.response?.status,
      statusText: error.response?.statusText,
      data: error.response?.data,
      message: error.message,
      url: error.config?.url
    });
    
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ API –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é
    return await simulateAIResponse(message, userId);
  }
}

// –°–∏–º—É–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ AI (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
async function simulateAIResponse(message, userId) {
  const responses = [
    "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å! –Ø –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ —Å–∫–æ—Ä–æ –¥–∞–º –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç.",
    "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –î–∞–π—Ç–µ –º–Ω–µ –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.",
    "–Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é –∏ –≥–æ—Ç–æ–≤–ª—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.",
    "–û—Ç–ª–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å! –°–µ–π—á–∞—Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –¥–ª—è –≤–∞—Å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω.",
    "–ü–æ–Ω—è–ª –≤–∞—à—É –∑–∞–¥–∞—á—É! –†–∞–±–æ—Ç–∞—é –Ω–∞–¥ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º."
  ];
  
  const randomResponse = responses[Math.floor(Math.random() * responses.length)];
  
  return {
    success: true,
    data: randomResponse + "\n\n‚ö†Ô∏è *–°–µ–π—á–∞—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ-—Ä–µ–∂–∏–º. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö AI-–æ—Ç–≤–µ—Ç–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ API.*"
  };
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ ID —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
export function getConversationId(userId) {
  return null;
}

// –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
export function clearConversation(userId) {
  return true;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Coze
export async function checkCozeConnection() {
  try {
    if (!process.env.COZE_API_KEY || process.env.COZE_API_KEY.includes('your_')) {
      return { success: false, error: 'API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω' };
    }

    const response = await axios.get(`${COZE_API_BASE_URL}/v1/bots`, {
      headers: {
        'Authorization': `Bearer ${process.env.COZE_API_KEY}`,
        'Content-Type': 'application/json'
      },
      timeout: 10000
    });

    return { success: response.status === 200 };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –æ—Ç Coze
export async function getCozeInstructions() {
  return "–Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –∏ –¥–∏–µ—Ç–æ–ª–æ–≥. –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö, –ø–∏—Ç–∞–Ω–∏–∏ –∏ –∑–¥–æ—Ä–æ–≤–æ–º –æ–±—Ä–∞–∑–µ –∂–∏–∑–Ω–∏!";
}

export async function resetUserConversation(accessToken, userId) {
  return clearConversation(userId);
}

export async function runCozeWorkflow(workflowId, parameters, userId) {
  return await runWorkflow(workflowId, parameters);
}
