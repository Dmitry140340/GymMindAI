import { 
  createOrUpdateUser, 
  getUserByTelegramId, 
  getActiveSubscription,
  checkExpiredSubscriptions,
  getUserAccessToken,
  updateUserAgreement,
  // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  addFitnessMetric,
  addWorkout,
  addAchievement,
  getUserMetrics,
  getUserWorkouts,
  getUserAchievements,
  // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  getUserFreeRequests,
  useFreeRequest,
  canUserMakeRequest,
  incrementRequestUsage,
  // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
  saveFitnessMetric,
  setUserGoal,
  getUserGoals,
  saveWorkout,
  getLastWeightRecord,
  updateLastWeightRecord,
  deleteLastWeightRecord,
  getLastWorkoutRecord,
  updateLastWorkoutRecord,
  deleteLastWorkoutRecord,
  deleteUserGoal,
  updateUserGoal,
  clearAllUserData,
  getUserDataSummary,
  // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
  saveDetailedWorkout,
  getDetailedWorkout,
  getUserDetailedWorkouts,
  updateDetailedWorkout,
  getExerciseProgressStats,
  // –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π
  deleteLastWorkout,
  deleteLastWeight,
  deleteAllWorkouts,
  deleteAllWeights
} from '../services/database.js';
import { runWorkflow, getConversationId, clearConversation, continueInteractiveWorkflow } from '../services/coze.js';
import { runCozeChat } from '../services/coze_v3.js';
import { createSubscriptionPayment } from '../services/payment.js';
import { 
  generateWeightChart, 
  generateWorkoutChart, 
  generateProgressChart, 
  generateTextReport 
} from '../services/analytics.js';
import {
  mainKeyboard,
  subscriptionKeyboard,
  confirmPaymentKeyboard,
  paymentLinkKeyboard,
  manageSubscriptionKeyboard,
  noSubscriptionKeyboard,
  helpKeyboard,
  analyticsKeyboard,
  workoutKeyboard,
  userAgreementKeyboard,
  aiToolsKeyboard,
  userDataKeyboard,
  workoutTypesKeyboard,
  detailedWorkoutKeyboard,
  popularExercisesKeyboard,
  viewRecordsKeyboard,
  deleteRecordsKeyboard,
  goalTypesKeyboard,
  subscriptionPlansKeyboard,
  paymentConfirmKeyboard
} from './keyboards.js';

// –•—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userStates = new Map();
// –•—Ä–∞–Ω–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ workflow –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const userWorkflowContext = new Map();
// –•—Ä–∞–Ω–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö workflow
const userInteractiveWorkflow = new Map();
// –•—Ä–∞–Ω–∏–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const activeWorkouts = new Map();

export function setupBotHandlers(bot) {
  // –ö–æ–º–∞–Ω–¥–∞ /start —Å –≤–æ–∑–º–æ–∂–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
  bot.onText(/\/start(?:\s+(.+))?/, async (msg, match) => {
    const chatId = msg.chat.id;
    const user = msg.from;
    const startParam = match ? match[1] : null;

    try {
      // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
      await createOrUpdateUser(user);
      
      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
      const dbUser = await getUserByTelegramId(user.id);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä payment_success
      if (startParam === 'payment_success') {
        await bot.sendMessage(
          chatId,
          'üéâ –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–ø–ª–∞—Ç—É!\n\n' +
          '–ï—Å–ª–∏ –≤–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞, –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–æ–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!\n\n' +
          'ü§ñ –ù–∞–∂–º–∏—Ç–µ "–î–æ—Å—Ç—É–ø –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É" –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ —Ñ–∏—Ç–Ω–µ—Å–µ.',
          mainKeyboard
        );
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–Ω—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ
      if (!dbUser.agreement_accepted) {
        await bot.sendMessage(
          chatId,
          'üìÑ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FitnessBotAI!**\n\n' +
          '–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º.\n\n' +
          'üìã –í –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ–ø–∏—Å–∞–Ω—ã:\n' +
          '‚Ä¢ –£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞\n' +
          '‚Ä¢ –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n' +
          '‚Ä¢ –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏\n' +
          '‚Ä¢ –í–∞—à–∏ –ø—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏\n\n' +
          '‚ö†Ô∏è –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—è.',
          userAgreementKeyboard
        );
        return;
      }
      
      const welcomeMessage = `üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FitnessBotAI!

ü§ñ –Ø –≤–∞—à –ª–∏—á–Ω—ã–π –ò–ò-—Ç—Ä–µ–Ω–µ—Ä, –≥–æ—Ç–æ–≤—ã–π –ø–æ–º–æ—á—å –≤–∞–º –¥–æ—Å—Ç–∏—á—å –≤–∞—à–∏—Ö —Ñ–∏—Ç–Ω–µ—Å-—Ü–µ–ª–µ–π!

‚ú® –ß—Ç–æ —è —É–º–µ—é:
‚Ä¢ –°–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
‚Ä¢ –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é
‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ñ–∏—Ç–Ω–µ—Å–µ –∏ –∑–¥–æ—Ä–æ–≤—å–µ
‚Ä¢ –ú–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–∞—Å

üíé –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –Ω—É–∂–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞.

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:`;

      await bot.sendMessage(chatId, welcomeMessage, mainKeyboard);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /start:', error);
      await bot.sendMessage(chatId, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  bot.on('message', async (msg) => {
    if (msg.text) {
      // –°–ø–∏—Å–æ–∫ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ (–Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º –≤ Coze)
      const systemCommands = ['/start', '/menu', '/reset', '/—Å–±—Ä–æ—Å', '/help', '/admin_test_coze', '/admin_stats', '/admin_users'];
      
      // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å–∏—Å—Ç–µ–º–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (!systemCommands.some(cmd => msg.text.startsWith(cmd))) {
        await handleTextMessage(bot, msg);
      }
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∑–∞–ø—Ä–æ—Å–æ–≤
  bot.on('callback_query', async (callbackQuery) => {
    await handleCallbackQuery(bot, callbackQuery);
  });

  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç—ë–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
  setInterval(async () => {
    try {
      await checkExpiredSubscriptions();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫:', error);
    }
  }, 60 * 60 * 1000); // –∫–∞–∂–¥—ã–π —á–∞—Å
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ñ–∏—Ç–Ω–µ—Å-–≤–æ–ø—Ä–æ—Å–æ–≤
function isFitnessQuestion(text) {
  // –ò—Å–∫–ª—é—á–∞–µ–º –í–°–ï –∫–Ω–æ–ø–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ - —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —Ñ–∏—Ç–Ω–µ—Å-–≤–æ–ø—Ä–æ—Å–æ–º
  const interfaceButtons = [
    // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    'ü§ñ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä', 'üß¨ –ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', 'üíé –ü–æ–¥–ø–∏—Å–∫–∞', 'ÔøΩ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å',
    'üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞', 'üéØ –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ', 'üîÑ –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥', '‚ùì –ü–æ–º–æ—â—å',
    
    // –ö–Ω–æ–ø–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    'üìà –ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞', 'üèãÔ∏è‚Äç‚ôÇÔ∏è –ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', 'üìä –û–±—â–∏–π –æ—Ç—á–µ—Ç', 'üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
    
    // –ö–Ω–æ–ø–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    'üí™ –°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', 'üèÉ‚Äç‚ôÇÔ∏è –ö–∞—Ä–¥–∏–æ', 'üßò‚Äç‚ôÄÔ∏è –ô–æ–≥–∞/–†–∞—Å—Ç—è–∂–∫–∞', 'ü•ä –ï–¥–∏–Ω–æ–±–æ—Ä—Å—Ç–≤–∞',
    'üî• –î–µ—Ç–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å', '‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–ø–∏—Å—å',
    
    // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏
    '‚öñÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å', 'üéØ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–ª—å', 'üèãÔ∏è‚Äç‚ôÇÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É', 'üìä –ú–æ–∏ –∑–∞–ø–∏—Å–∏',
    'üèãÔ∏è‚Äç‚ôÇÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', '‚öñÔ∏è –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Å–∞', 'üéØ –ú–æ–∏ —Ü–µ–ª–∏', 'üìà –ü—Ä–æ–≥—Ä–µ—Å—Å',
    
    // –ö–Ω–æ–ø–∫–∏ —Ü–µ–ª–µ–π
    'üèãÔ∏è‚Äç‚ôÇÔ∏è –ù–∞–±—Ä–∞—Ç—å –º—ã—à–µ—á–Ω—É—é –º–∞—Å—Å—É', '‚öñÔ∏è –°–Ω–∏–∑–∏—Ç—å –≤–µ—Å', 'üí™ –£–≤–µ–ª–∏—á–∏—Ç—å —Å–∏–ª—É', 
    'üèÉ‚Äç‚ôÇÔ∏è –£–ª—É—á—à–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å', 'ü§∏‚Äç‚ôÇÔ∏è –ü–æ–≤—ã—Å–∏—Ç—å –≥–∏–±–∫–æ—Å—Ç—å', '‚ö° –û–±—â–∞—è —Ñ–∏–∑–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞',
    
    // –ö–Ω–æ–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
    'üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É', 'üìã –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏', 'üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É', 
    'üìä –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π', 'üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É', 'üìã –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥–ø–∏—Å–∫–∏',
    
    // –ö–Ω–æ–ø–∫–∏ –ø–æ–º–æ—â–∏
    'üí¨ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º?', '‚ö° –ß—Ç–æ —É–º–µ–µ—Ç –ò–ò-—Ç—Ä–µ–Ω–µ—Ä?',
    
    // –ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏', 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏', 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–µ—Å–∞', 
    'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ü–µ–ª–∏', 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë',
    
    // –ö–Ω–æ–ø–∫–∏ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    '‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ', '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É', 'üèãÔ∏è‚Äç‚ôÇÔ∏è –ñ–∏–º –ª–µ–∂–∞', 
    'üèãÔ∏è‚Äç‚ôÇÔ∏è –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', 'üèãÔ∏è‚Äç‚ôÇÔ∏è –°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞', 'üèãÔ∏è‚Äç‚ôÇÔ∏è –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è', 'üìù –î—Ä—É–≥–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ',
    
    // –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    '‚ùå –û—Ç–º–µ–Ω–∞', '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', '‚úÖ –î–∞', '‚ùå –ù–µ—Ç', '‚è© –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å',
    
    // –ö–Ω–æ–ø–∫–∏ workflow (–æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
    'üèãÔ∏è‚Äç‚ôÇÔ∏è /training_program', 'ü•ó /nutrition_plan', 'üî¨ /deepresearch', 'üß™ /composition_analysis'
  ];
  
  // –ï—Å–ª–∏ —ç—Ç–æ –∫–Ω–æ–ø–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, —Ç–æ —ç—Ç–æ –ù–ï —Ñ–∏—Ç–Ω–µ—Å-–≤–æ–ø—Ä–æ—Å –¥–ª—è –ò–ò
  if (interfaceButtons.includes(text)) {
    return false;
  }

  const fitnessKeywords = [
    '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫', '—É–ø—Ä–∞–∂–Ω–µ–Ω', '–ø—Ä–æ–≥—Ä–∞–º–º', '–∑–∞–Ω—è—Ç', '—Å–ø–æ—Ä—Ç',
    '–ø–∏—Ç–∞–Ω–∏–µ', '–¥–∏–µ—Ç–∞', '–∫–∞–ª–æ—Ä–∏', '–±–µ–ª–æ–∫', '—É–≥–ª–µ–≤–æ–¥', '–∂–∏—Ä',
    '–ø–æ—Ö—É–¥–µ—Ç—å', '–ø–æ—Ö—É–¥–µ–Ω–∏', '–≤–µ—Å', '–∫–∏–ª–æ–≥—Ä–∞–º–º', '—Å–±—Ä–æ—Å–∏—Ç—å',
    '–º—ã—à—Ü', '–º–∞—Å—Å–∞', '–Ω–∞–∫–∞—á–∞—Ç—å', '–Ω–∞–±—Ä–∞—Ç—å', '—Ä–µ–ª—å–µ—Ñ',
    '—Ñ–∏—Ç–Ω–µ—Å', '–∑–∞–ª', '–¥–æ–º–∞', '–∫–∞—Ä–¥–∏–æ', '—Å–∏–ª–æ–≤',
    '–ø—Ä–µ—Å—Å', '–Ω–æ–≥', '—Ä—É–∫', '—Å–ø–∏–Ω', '–≥—Ä—É–¥—å', '–ø–ª–µ—á',
    '–æ—Ç–∂–∏–º–∞–Ω–∏', '–ø—Ä–∏—Å–µ–¥–∞–Ω–∏', '–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏', '–ø–ª–∞–Ω–∫–∞',
    '–±–µ–≥', '—Ö–æ–¥—å–±–∞', '–≤–µ–ª–æ—Å–∏–ø–µ–¥', '–ø–ª–∞–≤–∞–Ω–∏',
    '–∑–¥–æ—Ä–æ–≤—å–µ', '—ç–Ω–µ—Ä–≥–∏—è', '–≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å', '—Å–∏–ª–∞'
  ];
  
  const lowerText = text.toLowerCase();
  return fitnessKeywords.some(keyword => lowerText.includes(keyword));
}

async function handleTextMessage(bot, msg) {
  const chatId = msg.chat.id;
  let text = msg.text; // –ò–∑–º–µ–Ω—è–µ–º const –Ω–∞ let, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å
  const user = msg.from;

  // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –ø–æ–ª—É—á–∞–µ–º—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  console.log(`üì© –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}:`, text);

  try {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await createOrUpdateUser(user);
    const dbUser = await getUserByTelegramId(user.id);

    // === –ü–ï–†–í–û–û–ß–ï–†–ï–î–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö –ò–ù–¢–ï–†–§–ï–ô–°–ê ===
    // –≠—Ç–∏ –∫–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –í–°–ï–ì–î–ê, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–æ–¥–ø–∏—Å–∫–∏
    // –í—Å–µ –∫–Ω–æ–ø–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç —Ä–µ–∂–∏–º –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫—É "–ú–æ–∏ –¥–∞–Ω–Ω—ã–µ" —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–±–ª–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏ —ç–º–æ–¥–∑–∏
    if (text === 'üéØ –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ' || text.includes('–ú–æ–∏ –¥–∞–Ω–Ω—ã–µ')) {
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
      await bot.sendMessage(
        chatId,
        'üéØ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏**\n\n' +
        '–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:\n' +
        '‚Ä¢ ‚öñÔ∏è –ó–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–µ—Å\n' +
        '‚Ä¢ üéØ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –∏ –∏–∑–º–µ–Ω—è—Ç—å —Ü–µ–ª–∏\n' +
        '‚Ä¢ üèãÔ∏è‚Äç‚ôÇÔ∏è –î–æ–±–∞–≤–ª—è—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n' +
        '‚Ä¢ üìä –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏\n' +
        '‚Ä¢ üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ\n' +
        '‚Ä¢ üóëÔ∏è –£–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å–∏\n\n' +
        '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
        { parse_mode: 'Markdown', ...userDataKeyboard }
      );
      return;
    }

    if (text === 'üß¨ –ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã' || text.includes('–ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã')) {
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
      await bot.sendMessage(
        chatId,
        'üß¨ **–ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã**\n\n' +
        'ü§ñ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –≤–æ—Ä–∫—Ñ–ª–æ—É –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò:\n\n' +
        '‚Ä¢ üèãÔ∏è‚Äç‚ôÇÔ∏è `/training_program` - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ ü•ó `/nutrition_plan` - —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è\n' +
        '‚Ä¢ üî¨ `/deepresearch` - –≥–ª—É–±–æ–∫–æ–µ –Ω–∞—É—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ\n' +
        '‚Ä¢ üß™ `/composition_analysis` - –∞–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞ –¥–æ–±–∞–≤–æ–∫\n\n' +
        '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –º–µ–Ω—é:',
        { parse_mode: 'Markdown', ...aiToolsKeyboard }
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ò–ò-–∫–æ–º–∞–Ω–¥
    if (text === 'üèãÔ∏è‚Äç‚ôÇÔ∏è /training_program') {
      text = '/training_program'; // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    }
    
    if (text === 'ü•ó /nutrition_plan') {
      text = '/nutrition_plan'; // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    }
    
    if (text === 'üî¨ /deepresearch') {
      text = '/deepresearch'; // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    }
    
    if (text === 'üß™ /composition_analysis') {
      text = '/composition_analysis'; // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    }

    if (text === '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é' || text.includes('–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é')) {
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      await bot.sendMessage(
        chatId,
        'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
        mainKeyboard
      );
      return;
    }

    if (text === '‚ùå –û—Ç–º–µ–Ω–∞') {
      // –û—Ç–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      activeWorkouts.delete(user.id); // –û—Ç–º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
      await bot.sendMessage(
        chatId,
        '‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ\n\nüè† –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:',
        mainKeyboard
      );
      return;
    }

    if (text === 'üíé –ü–æ–¥–ø–∏—Å–∫–∞' || text.includes('–ü–æ–¥–ø–∏—Å–∫–∞')) {
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
      await showSubscriptionMenu(bot, chatId, dbUser.id);
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏
    if (text === 'üìã –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏') {
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
      await showSubscriptionStatus(bot, chatId, null, dbUser.id);
      return;
    }

    if (text === 'üìä –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π') {
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
      await showPaymentHistory(bot, chatId, dbUser.id);
      return;
    }

    if (text === 'üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É') {
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
      
      const basicPrice = process.env.BASIC_PRICE || '150';
      const standardPrice = process.env.STANDARD_PRICE || '300';
      const premiumPrice = process.env.PREMIUM_PRICE || '450';
      
      await bot.sendMessage(
        chatId,
        `üíé –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω:\n\n` +
        `üíé **–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω** - ${basicPrice}‚ÇΩ/–º–µ—Å\n` +
        `‚Ä¢ 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n` +
        `‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n` +
        `‚Ä¢ –ë–∞–∑–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é\n\n` +
        
        `‚≠ê **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω** - ${standardPrice}‚ÇΩ/–º–µ—Å\n` +
        `‚Ä¢ 300 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n` +
        `‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n` +
        `‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–∏—Ç–∞–Ω–∏—è\n` +
        `‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞ –¥–æ–±–∞–≤–æ–∫\n\n` +
        
        `üöÄ **–ü—Ä–µ–º–∏—É–º –ø–ª–∞–Ω** - ${premiumPrice}‚ÇΩ/–º–µ—Å\n` +
        `‚Ä¢ 600 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n` +
        `‚Ä¢ –í—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞\n` +
        `‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n` +
        `‚Ä¢ –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è\n\n` +
        
        `–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ:`,
        { parse_mode: 'Markdown', ...subscriptionPlansKeyboard }
      );
      return;
    }

    if (text === 'üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É' || text === 'üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É') {
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
      
      const basicPrice = process.env.BASIC_PRICE || '150';
      const standardPrice = process.env.STANDARD_PRICE || '300';
      const premiumPrice = process.env.PREMIUM_PRICE || '450';
      
      await bot.sendMessage(
        chatId,
        `üíé –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏:\n\n` +
        `ÔøΩ **–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω** - ${basicPrice}‚ÇΩ/–º–µ—Å\n` +
        `‚Ä¢ 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n` +
        `‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n` +
        `‚Ä¢ –ë–∞–∑–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é\n\n` +
        
        `‚≠ê **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω** - ${standardPrice}‚ÇΩ/–º–µ—Å\n` +
        `‚Ä¢ 300 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n` +
        `‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n` +
        `‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–∏—Ç–∞–Ω–∏—è\n` +
        `‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞ –¥–æ–±–∞–≤–æ–∫\n\n` +
        
        `üöÄ **–ü—Ä–µ–º–∏—É–º –ø–ª–∞–Ω** - ${premiumPrice}‚ÇΩ/–º–µ—Å\n` +
        `‚Ä¢ 600 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n` +
        `‚Ä¢ –í—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞\n` +
        `‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n` +
        `‚Ä¢ –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è\n\n` +
        
        `–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ:`,
        { parse_mode: 'Markdown', ...subscriptionPlansKeyboard }
      );
      return;
    }

    if (text === 'üìã –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥–ø–∏—Å–∫–∏') {
      await bot.sendMessage(
        chatId,
        '‚ú® **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥–ø–∏—Å–∫–∏:**\n\n' +
        'ü§ñ **–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ —Å –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–æ–º**\n' +
        '‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ —Ñ–∏—Ç–Ω–µ—Å-–≤–æ–ø—Ä–æ—Å—ã\n' +
        '‚Ä¢ –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º\n' +
        '‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–º—É –ø–∏—Ç–∞–Ω–∏—é\n\n' +
        'üß¨ **–î–æ—Å—Ç—É–ø –∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º:**\n' +
        '‚Ä¢ üî¨ –ì–ª—É–±–æ–∫–∏–π –Ω–∞—É—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑\n' +
        '‚Ä¢ üèãÔ∏è‚Äç‚ôÇÔ∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ ü•ó –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–∏—Ç–∞–Ω–∏—è\n' +
        '‚Ä¢ üß™ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–±–∞–≤–æ–∫\n\n' +
        'üìä **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:**\n' +
        '‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n' +
        '‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Ç—á–µ—Ç—ã\n' +
        '‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π\n\n' +
        'üéØ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏:**\n' +
        '‚Ä¢ –í–µ–¥–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω–∏–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–µ—Å–∞ –∏ –º–µ—Ç—Ä–∏–∫\n' +
        '‚Ä¢ –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ª–µ–π',
        { parse_mode: 'Markdown', ...subscriptionKeyboard }
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏
    if (text === 'üíé –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω - 150‚ÇΩ') {
      userStates.set(user.id, { action: 'selected_plan', planType: 'basic' });
      await bot.sendMessage(
        chatId,
        'üíé **–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω** - 150‚ÇΩ/–º–µ—Å—è—Ü\n\n' +
        '‚úÖ **–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:**\n' +
        '‚Ä¢ 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n' +
        '‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n' +
        '‚Ä¢ –ë–∞–∑–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é\n' +
        '‚Ä¢ –í–µ–¥–µ–Ω–∏–µ –¥–Ω–µ–≤–Ω–∏–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n\n' +
        'üí≥ **–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:**\n' +
        '‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ (Visa, MasterCard, –ú–ò–†)\n' +
        '‚Ä¢ –ÆMoney\n' +
        '‚Ä¢ –°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)\n\n' +
        '‚ö†Ô∏è –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!\n\n' +
        'üëá **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É:**',
        { parse_mode: 'Markdown', ...paymentConfirmKeyboard }
      );
      return;
    }

    if (text === '‚≠ê –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω - 300‚ÇΩ') {
      userStates.set(user.id, { action: 'selected_plan', planType: 'standard' });
      await bot.sendMessage(
        chatId,
        '‚≠ê **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω** - 300‚ÇΩ/–º–µ—Å—è—Ü\n\n' +
        '‚úÖ **–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:**\n' +
        '‚Ä¢ 300 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n' +
        '‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–∏—Ç–∞–Ω–∏—è\n' +
        '‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞ –¥–æ–±–∞–≤–æ–∫\n' +
        '‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞\n' +
        '‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n\n' +
        'üí≥ **–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:**\n' +
        '‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ (Visa, MasterCard, –ú–ò–†)\n' +
        '‚Ä¢ –ÆMoney\n' +
        '‚Ä¢ –°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)\n\n' +
        '‚ö†Ô∏è –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!\n\n' +
        'üëá **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É:**',
        { parse_mode: 'Markdown', ...paymentConfirmKeyboard }
      );
      return;
    }

    if (text === 'üöÄ –ü—Ä–µ–º–∏—É–º –ø–ª–∞–Ω - 450‚ÇΩ') {
      userStates.set(user.id, { action: 'selected_plan', planType: 'premium' });
      await bot.sendMessage(
        chatId,
        'üöÄ **–ü—Ä–µ–º–∏—É–º –ø–ª–∞–Ω** - 450‚ÇΩ/–º–µ—Å—è—Ü\n\n' +
        '‚úÖ **–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ:**\n' +
        '‚Ä¢ 600 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n' +
        '‚Ä¢ –í—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞\n' +
        '‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n' +
        '‚Ä¢ –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è\n' +
        '‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏\n' +
        '‚Ä¢ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞\n' +
        '‚Ä¢ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö\n\n' +
        'üí≥ **–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:**\n' +
        '‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ (Visa, MasterCard, –ú–ò–†)\n' +
        '‚Ä¢ –ÆMoney\n' +
        '‚Ä¢ –°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)\n\n' +
        '‚ö†Ô∏è –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!\n\n' +
        'üëá **–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É:**',
        { parse_mode: 'Markdown', ...paymentConfirmKeyboard }
      );
      return;
    }

    if (text === 'üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Å–µ–π—á–∞—Å') {
      const state = userStates.get(user.id);
      if (state && state.action === 'selected_plan') {
        // –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂
        await bot.sendChatAction(chatId, 'typing');
        const loadingMsg = await bot.sendMessage(chatId, 'üí≥ –°–æ–∑–¥–∞—é —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã...');
        
        const paymentResult = await createSubscriptionPayment(user.id, state.planType);
        
        await bot.deleteMessage(chatId, loadingMsg.message_id).catch(() => {});
        
        if (paymentResult.success) {
          const planNames = {
            'basic': 'üíé –ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω',
            'standard': '‚≠ê –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω', 
            'premium': 'üöÄ –ü—Ä–µ–º–∏—É–º –ø–ª–∞–Ω'
          };
          
          await bot.sendMessage(
            chatId,
            `‚úÖ **–°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∞!**\n\n` +
            `üìã **–î–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞:**\n` +
            `‚Ä¢ –ü–ª–∞–Ω: ${planNames[state.planType]}\n` +
            `‚Ä¢ –°—É–º–º–∞: ${paymentResult.amount}‚ÇΩ\n` +
            `‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: ${paymentResult.description}\n\n` +
            `üîó **[–û–ü–õ–ê–¢–ò–¢–¨ –ü–û–î–ü–ò–°–ö–£](${paymentResult.paymentUrl})**\n\n` +
            `üí° **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**\n` +
            `1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É –≤—ã—à–µ\n` +
            `2. –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã\n` +
            `3. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –ÆMoney\n` +
            `4. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–ª–∞—Ç–µ–∂\n` +
            `5. –î–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!\n\n` +
            `‚ö†Ô∏è –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ 15 –º–∏–Ω—É—Ç`,
            { 
              parse_mode: 'Markdown',
              reply_markup: {
                keyboard: [
                  [{ text: 'üìã –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏' }],
                  [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–ª–∞–Ω–∞–º' }],
                  [{ text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é' }]
                ],
                resize_keyboard: true,
                one_time_keyboard: false
              }
            }
          );
          userStates.delete(user.id);
        } else {
          await bot.sendMessage(
            chatId,
            `‚ùå **–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞**\n\n${paymentResult.error}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.`,
            { parse_mode: 'Markdown', ...paymentConfirmKeyboard }
          );
        }
      } else {
        await bot.sendMessage(
          chatId,
          '‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏.',
          subscriptionPlansKeyboard
        );
      }
      return;
    }

    if (text === '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–ª–∞–Ω–∞–º') {
      userStates.delete(user.id);
      const basicPrice = process.env.BASIC_PRICE || '150';
      const standardPrice = process.env.STANDARD_PRICE || '300';
      const premiumPrice = process.env.PREMIUM_PRICE || '450';
      
      await bot.sendMessage(
        chatId,
        `üíé –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏:\n\n` +
        `üíé **–ë–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω** - ${basicPrice}‚ÇΩ/–º–µ—Å\n` +
        `‚Ä¢ 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n\n` +
        `‚≠ê **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω** - ${standardPrice}‚ÇΩ/–º–µ—Å\n` +
        `‚Ä¢ 300 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n\n` +
        `üöÄ **–ü—Ä–µ–º–∏—É–º –ø–ª–∞–Ω** - ${premiumPrice}‚ÇΩ/–º–µ—Å\n` +
        `‚Ä¢ 600 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n\n` +
        `–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ:`,
        { parse_mode: 'Markdown', ...subscriptionPlansKeyboard }
      );
      return;
    }

    if (text === '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–æ–¥–ø–∏—Å–∫–µ') {
      userStates.delete(user.id);
      await bot.sendMessage(
        chatId,
        'üíé –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
        subscriptionKeyboard
      );
      return;
    }

    if (text === 'üìä –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å' || text.includes('–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å')) {
      await showUserProfile(bot, chatId, dbUser);
      return;
    }

    if (text === '‚ùì –ü–æ–º–æ—â—å' || text.includes('–ü–æ–º–æ—â—å')) {
      await bot.sendMessage(
        chatId,
        '‚ùì –°–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–º–æ—â—å\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å —Ä–∞–∑–¥–µ–ª:',
        helpKeyboard
      );
      return;
    }

    if (text === 'üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞' || text.includes('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞')) {
      await bot.sendMessage(
        chatId,
        'üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:',
        analyticsKeyboard
      );
      return;
    }

    if (text === '‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é') {
      userStates.delete(user.id); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      await bot.sendMessage(
        chatId,
        'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
        mainKeyboard
      );
      return;
    }

    if (text === 'üíé –ü–æ–¥–ø–∏—Å–∫–∞') {
      await showSubscriptionMenu(bot, chatId, dbUser.id);
      return;
    }

    if (text === 'üìä –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å') {
      await showUserProfile(bot, chatId, dbUser);
      return;
    }

    if (text === '‚ùì –ü–æ–º–æ—â—å') {
      await bot.sendMessage(
        chatId,
        '‚ùì –°–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–º–æ—â—å\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å —Ä–∞–∑–¥–µ–ª:',
        helpKeyboard
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–æ–º–æ—â–∏
    if (text === 'üí¨ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º?' || text.includes('–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º')) {
      await bot.sendMessage(
        chatId,
        'üí¨ **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º**\n\n' +
        'ü§ñ **–ò–ò-—Ç—Ä–µ–Ω–µ—Ä** - –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫:\n' +
        '‚Ä¢ –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ñ–∏—Ç–Ω–µ—Å–µ –∏ –ø–∏—Ç–∞–Ω–∏–∏\n' +
        '‚Ä¢ –°–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ –î–∞—ë—Ç —Å–æ–≤–µ—Ç—ã –ø–æ –∑–¥–æ—Ä–æ–≤–æ–º—É –æ–±—Ä–∞–∑—É –∂–∏–∑–Ω–∏\n\n' +
        'üß¨ **–ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã** - —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n' +
        '‚Ä¢ `/training_program` - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n' +
        '‚Ä¢ `/nutrition_plan` - –ø–ª–∞–Ω—ã –ø–∏—Ç–∞–Ω–∏—è\n' +
        '‚Ä¢ `/deepresearch` - –Ω–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è\n' +
        '‚Ä¢ `/composition_analysis` - –∞–Ω–∞–ª–∏–∑ –¥–æ–±–∞–≤–æ–∫\n\n' +
        'üéØ **–ú–æ–∏ –¥–∞–Ω–Ω—ã–µ** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:\n' +
        '‚Ä¢ –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –≤–µ—Å –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n' +
        '‚Ä¢ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —Ü–µ–ª–∏\n' +
        '‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é\n\n' +
        'üìä **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –æ—Ç—á—ë—Ç—ã:\n' +
        '‚Ä¢ –ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞\n' +
        '‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ –û–±—â–∏–π –æ—Ç—á—ë—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n\n' +
        'üíé **–ü–æ–¥–ø–∏—Å–∫–∞** - –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏—è–º',
        { parse_mode: 'Markdown', ...helpKeyboard }
      );
      return;
    }

    if (text === '‚ö° –ß—Ç–æ —É–º–µ–µ—Ç –ò–ò-—Ç—Ä–µ–Ω–µ—Ä?' || text.includes('–ß—Ç–æ —É–º–µ–µ—Ç –ò–ò-—Ç—Ä–µ–Ω–µ—Ä')) {
      await bot.sendMessage(
        chatId,
        '‚ö° **–ß—Ç–æ —É–º–µ–µ—Ç –ò–ò-—Ç—Ä–µ–Ω–µ—Ä**\n\n' +
        'üèãÔ∏è‚Äç‚ôÇÔ∏è **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:**\n' +
        '‚Ä¢ –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º\n' +
        '‚Ä¢ –ü–æ–¥–±–æ—Ä —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø–æ–¥ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å\n' +
        '‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è\n' +
        '‚Ä¢ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏–∏\n\n' +
        'ü•ó **–ü–∏—Ç–∞–Ω–∏–µ:**\n' +
        '‚Ä¢ –†–∞—Å—á—ë—Ç –∫–∞–ª–æ—Ä–∏–π –∏ –ë–ñ–£\n' +
        '‚Ä¢ –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Ü–∏–æ–Ω–æ–≤\n' +
        '‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–º—É –ø–∏—Ç–∞–Ω–∏—é\n' +
        '‚Ä¢ –ê–Ω–∞–ª–∏–∑ –¥–∏–µ—Ç –∏ –∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n\n' +
        'üéØ **–¶–µ–ª–∏:**\n' +
        '‚Ä¢ –ü–æ—Ö—É–¥–µ–Ω–∏–µ –∏ —Å—É—à–∫–∞\n' +
        '‚Ä¢ –ù–∞–±–æ—Ä –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã\n' +
        '‚Ä¢ –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å–∏–ª—ã –∏ –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏\n' +
        '‚Ä¢ –†–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ\n\n' +
        'üß™ **–ù–∞—É—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**\n' +
        '‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π\n' +
        '‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö –¥–æ–±–∞–≤–æ–∫\n' +
        '‚Ä¢ –†–∞–∑–≤–µ–Ω—á–∞–Ω–∏–µ –º–∏—Ñ–æ–≤\n' +
        '‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n\n' +
        'üí° –ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "ü§ñ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä"!',
        { parse_mode: 'Markdown', ...helpKeyboard }
      );
      return;
    }

    if (text === ' –ê–Ω–∞–ª–∏—Ç–∏–∫–∞') {
      await bot.sendMessage(
        chatId,
        'üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:',
        analyticsKeyboard
      );
      return;
    }

    if (text === 'ü§ñ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä') {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
      const requestStatus = await canUserMakeRequest(dbUser.id);
      
      if (!requestStatus.canMake) {
        await bot.sendMessage(
          chatId,
          'üíé –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É.\n\n' +
          'üÜì –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç 7 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n' +
          'üí™ –î–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É!',
          noSubscriptionKeyboard
        );
        return;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
      let requestInfo = '';
      if (requestStatus.type === 'free') {
        requestInfo = `\n\nüÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: ${requestStatus.remaining}/7`;
      } else if (requestStatus.type === 'subscription') {
        requestInfo = `\n\nüíé –ó–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ: ${requestStatus.remaining}/${requestStatus.total}`;
      }

      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å –ò–ò
      userStates.set(user.id, 'chatting_with_ai');
      
      // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ Coze
      try {
        const accessToken = await getUserAccessToken(dbUser.id);
        if (accessToken) {
          // –£–¥–∞–ª—è–µ–º getCozeInstructions —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
          // const instructions = await getCozeInstructions(accessToken);
          await bot.sendMessage(chatId, instructions.message + requestInfo, { parse_mode: 'Markdown' });
        } else {
          await bot.sendMessage(
            chatId,
            'ü§ñ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä!*\n\n' +
            '–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å:\n' +
            '‚Ä¢ –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–∞–º–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
            '‚Ä¢ –°–æ–≤–µ—Ç–∞–º–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é\n' +
            '‚Ä¢ –í–æ–ø—Ä–æ—Å–∞–º–∏ –æ –∑–¥–æ—Ä–æ–≤—å–µ –∏ —Ñ–∏—Ç–Ω–µ—Å–µ\n\n' +
            '–ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã!' + requestInfo,
            { parse_mode: 'Markdown' }
          );
        }
      } catch (error) {
        await bot.sendMessage(
          chatId,
          'ü§ñ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä!*\n\n' +
          '–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å:\n' +
          '‚Ä¢ –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–∞–º–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
          '‚Ä¢ –°–æ–≤–µ—Ç–∞–º–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é\n' +
          '‚Ä¢ –í–æ–ø—Ä–æ—Å–∞–º–∏ –æ –∑–¥–æ—Ä–æ–≤—å–µ –∏ —Ñ–∏—Ç–Ω–µ—Å–µ\n\n' +
          '–ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã!' + requestInfo,
          { parse_mode: 'Markdown' }
        );
      }
      return;
    }

    if (text === 'üß¨ –ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã') {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const subscription = await getActiveSubscription(dbUser.id);
      
      if (!subscription) {
        await bot.sendMessage(
          chatId,
          'üîí **–ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π**\n\n' +
          'üß¨ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–∫–ª—é—á–∞—é—Ç:\n' +
          '‚Ä¢ üî¨ –ì–ª—É–±–æ–∫–∏–π –Ω–∞—É—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑\n' +
          '‚Ä¢ üèãÔ∏è‚Äç‚ôÇÔ∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
          '‚Ä¢ ü•ó –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–∏—Ç–∞–Ω–∏—è\n' +
          '‚Ä¢ üß™ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–±–∞–≤–æ–∫\n\n' +
          'üíé –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º!',
          { parse_mode: 'Markdown', ...noSubscriptionKeyboard }
        );
        return;
      }
      
      await bot.sendMessage(
        chatId,
        'üß¨ **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã**\n\n' +
        '–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:\n\n' +
        'üî¨ **–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑** - –î–µ—Ç–∞–ª—å–Ω–æ–µ –Ω–∞—É—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ª—é–±–æ–π —Ç–µ–º—ã\n' +
        'üèãÔ∏è‚Äç‚ôÇÔ∏è **–ü–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫** - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–¥ –≤–∞—à–∏ —Ü–µ–ª–∏\n' +
        'ü•ó **–ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è** - –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ä–∞—Ü–∏–æ–Ω —Å —Ä–∞—Å—á–µ—Ç–æ–º –ö–ë–ñ–£\n' +
        'üß™ **–ê–Ω–∞–ª–∏–∑ –¥–æ–±–∞–≤–æ–∫** - –≠–∫—Å–ø–µ—Ä—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–∞–≤–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
        { parse_mode: 'Markdown', ...aiToolsKeyboard }
      );
      return;
    }

    if (text === 'üîÑ –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥') {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      userStates.delete(user.id);
      
      // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç workflow
      userWorkflowContext.delete(user.id);
      console.log(`üóëÔ∏è –û—á–∏—â–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç workflow –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}`);
      
      // –û—á–∏—â–∞–µ–º conversation_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      clearConversation(dbUser.id);
      
      await bot.sendMessage(
        chatId,
        'üîÑ –î–∏–∞–ª–æ–≥ —Å–±—Ä–æ—à–µ–Ω!\n\n–¢–µ–ø–µ—Ä—å –ò–ò-—Ç—Ä–µ–Ω–µ—Ä –Ω–µ –ø–æ–º–Ω–∏—Ç –≤–∞—à—É –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–æ–≤. –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä.',
        mainKeyboard
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if (text === 'üìà –ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞') {
      await handleWeightChart(bot, chatId, dbUser.id);
      return;
    }

    if (text === 'üèãÔ∏è‚Äç‚ôÇÔ∏è –ì—Ä–∞—Ñ–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫') {
      await handleWorkoutChart(bot, chatId, dbUser.id);
      return;
    }

    if (text === 'üìä –û–±—â–∏–π –æ—Ç—á–µ—Ç') {
      await handleProgressReport(bot, chatId, dbUser.id);
      return;
    }

    if (text === 'üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è') {
      await handleAchievements(bot, chatId, dbUser.id);
      return;
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î –£–ü–†–ê–í–õ–ï–ù–ò–Ø –î–ê–ù–ù–´–ú–ò ===
    
    // –ó–∞–ø–∏—Å—å –≤–µ—Å–∞
    if (text === '‚öñÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å') {
      userStates.set(user.id, { action: 'waiting_weight' });
      await bot.sendMessage(
        chatId,
        '‚öñÔ∏è **–ó–∞–ø–∏—Å—å –≤–µ—Å–∞**\n\n' +
        '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—É—â–∏–π –≤–µ—Å –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö.\n\n' +
        'üí° –ü—Ä–∏–º–µ—Ä—ã:\n' +
        '‚Ä¢ `75.5`\n' +
        '‚Ä¢ `68`\n' +
        '‚Ä¢ `82.3`',
        { parse_mode: 'Markdown' }
      );
      return;
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–∏
    if (text === 'üéØ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–ª—å') {
      await bot.sendMessage(
        chatId,
        'üéØ **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–∏**\n\n' +
        '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ü–µ–ª–∏:',
        { parse_mode: 'Markdown', ...goalTypesKeyboard }
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–æ–≤ —Ü–µ–ª–µ–π
    if (['üèãÔ∏è‚Äç‚ôÇÔ∏è –ù–∞–±—Ä–∞—Ç—å –º—ã—à–µ—á–Ω—É—é –º–∞—Å—Å—É', '‚öñÔ∏è –°–Ω–∏–∑–∏—Ç—å –≤–µ—Å', 'üí™ –£–≤–µ–ª–∏—á–∏—Ç—å —Å–∏–ª—É', 'üèÉ‚Äç‚ôÇÔ∏è –£–ª—É—á—à–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å', 'ü§∏‚Äç‚ôÇÔ∏è –ü–æ–≤—ã—Å–∏—Ç—å –≥–∏–±–∫–æ—Å—Ç—å', '‚ö° –û–±—â–∞—è —Ñ–∏–∑–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞'].includes(text)) {
      const goalType = text.split(' ').slice(1).join(' ').toLowerCase();
      userStates.set(user.id, { action: 'waiting_goal_value', goalType: goalType });
      
      let prompt = 'üéØ **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–∏: ' + text + '**\n\n';
      if (text === '‚öñÔ∏è –°–Ω–∏–∑–∏—Ç—å –≤–µ—Å') {
        prompt += '–í–≤–µ–¥–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π –≤–µ—Å –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö:\n\nüí° –ü—Ä–∏–º–µ—Ä: `70`';
      } else {
        prompt += '–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ü–µ–ª—å –ø–æ–¥—Ä–æ–±–Ω–æ:\n\nüí° –ü—Ä–∏–º–µ—Ä—ã:\n‚Ä¢ `–£–≤–µ–ª–∏—á–∏—Ç—å –∂–∏–º –ª–µ–∂–∞ –¥–æ 100 –∫–≥`\n‚Ä¢ `–ü—Ä–æ–±–µ–∂–∞—Ç—å 10 –∫–º –∑–∞ 45 –º–∏–Ω—É—Ç`\n‚Ä¢ `–ù–∞–±—Ä–∞—Ç—å 5 –∫–≥ –º—ã—à–µ—á–Ω–æ–π –º–∞—Å—Å—ã`';
      }
      
      await bot.sendMessage(chatId, prompt, { parse_mode: 'Markdown' });
      return;
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    if (text === 'üèãÔ∏è‚Äç‚ôÇÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É') {
      await bot.sendMessage(
        chatId,
        'üèãÔ∏è‚Äç‚ôÇÔ∏è **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏**\n\n' +
        '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:',
        { parse_mode: 'Markdown', ...workoutTypesKeyboard }
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    if (text === 'üí™ –°–∏–ª–æ–≤–∞—è') {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—É—é –¥–µ—Ç–∞–ª—å–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
      activeWorkouts.set(user.id, {
        type: 'strength',
        exercises: [],
        startTime: new Date(),
        moodBefore: 3 // –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      });
      
      await bot.sendMessage(
        chatId,
        'üí™ **–°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞—á–∞—Ç–∞!**\n\n' +
        'ÔøΩÔ∏è‚Äç‚ôÇÔ∏è –î–æ–±–∞–≤–ª—è–π—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –º–µ—Ä–µ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.\n' +
        '–î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤, –≤–µ—Å –æ—Ç—è–≥–æ—â–µ–Ω–∏—è, –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.',
        { parse_mode: 'Markdown', ...detailedWorkoutKeyboard }
      );
      
      return;
    }

    if (['üèÉ‚Äç‚ôÇÔ∏è –ö–∞—Ä–¥–∏–æ', 'üßò‚Äç‚ôÇÔ∏è –ô–æ–≥–∞/–†–∞—Å—Ç—è–∂–∫–∞', 'üèä‚Äç‚ôÇÔ∏è –ü–ª–∞–≤–∞–Ω–∏–µ', 'üö¥‚Äç‚ôÇÔ∏è –í–µ–ª–æ—Å–∏–ø–µ–¥', 'ü•ä –ï–¥–∏–Ω–æ–±–æ—Ä—Å—Ç–≤–∞', '‚öΩ –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã', 'üèÉ‚Äç‚ôÇÔ∏è –î—Ä—É–≥–æ–µ'].includes(text)) {
      const workoutType = text.split(' ').slice(1).join(' ');
      userStates.set(user.id, { action: 'waiting_workout_duration', workoutType: workoutType });
      
      await bot.sendMessage(
        chatId,
        '‚è±Ô∏è **–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏**\n\n' +
        `–¢–∏–ø: ${text}\n\n` +
        '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö:\n\n' +
        'üí° –ü—Ä–∏–º–µ—Ä—ã:\n' +
        '‚Ä¢ `45` (45 –º–∏–Ω—É—Ç)\n' +
        '‚Ä¢ `90` (1.5 —á–∞—Å–∞)\n' +
        '‚Ä¢ `30` (30 –º–∏–Ω—É—Ç)',
        { parse_mode: 'Markdown' }
      );
      return;
    }

    // –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø–∏—Å–µ–π
    if (text === 'üìä –ú–æ–∏ –∑–∞–ø–∏—Å–∏') {
      await bot.sendMessage(
        chatId,
        'üìä **–ú–æ–∏ –∑–∞–ø–∏—Å–∏**\n\n' +
        '–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?',
        { parse_mode: 'Markdown', ...viewRecordsKeyboard }
      );
      return;
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏
    if (text === 'üîß –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ') {
      await bot.sendMessage(
        chatId,
        'üîß **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**\n\n' +
        '–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?',
        { parse_mode: 'Markdown', ...manageRecordsKeyboard }
      );
      return;
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
    if (text === 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏') {
      await bot.sendMessage(
        chatId,
        'üóëÔ∏è **–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π**\n\n' +
        '‚ö†Ô∏è –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã! –£–¥–∞–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–ª—å–∑—è.\n\n' +
        '–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å?',
        { parse_mode: 'Markdown', ...deleteRecordsKeyboard }
      );
      return;
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –£–î–ê–õ–ï–ù–ò–Ø –ó–ê–ü–ò–°–ï–ô ===
    
    if (text === 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É') {
      await handleDeleteLastWorkout(bot, chatId, dbUser.id);
      return;
    }
    
    if (text === 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–µ—Å') {
      await handleDeleteLastWeight(bot, chatId, dbUser.id);
      return;
    }
    
    if (text === 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏') {
      await confirmDeleteAllWorkouts(bot, chatId, dbUser.id);
      return;
    }
    
    if (text === 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –≤–µ—Å–∞') {
      await confirmDeleteAllWeights(bot, chatId, dbUser.id);
      return;
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ü–†–û–°–ú–û–¢–†–ê –ó–ê–ü–ò–°–ï–ô ===
    
    if (text === '‚öñÔ∏è –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Å–∞') {
      await showWeightHistory(bot, chatId, dbUser.id);
      return;
    }

    if (text === 'üéØ –ú–æ–∏ —Ü–µ–ª–∏') {
      await showUserGoals(bot, chatId, dbUser.id);
      return;
    }

    if (text === 'üèãÔ∏è‚Äç‚ôÇÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫') {
      await showWorkoutHistory(bot, chatId, dbUser.id);
      return;
    }

    if (text === 'üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞') {
      await showUserStatistics(bot, chatId, dbUser.id);
      return;
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ó–ê–ü–ò–°–ï–ô ===
    
    if (text === '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–µ—Å') {
      const lastWeight = await getLastWeightRecord(dbUser.id);
      if (!lastWeight) {
        await bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤–µ—Å–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è.');
        return;
      }
      
      userStates.set(user.id, { action: 'waiting_weight_update' });
      await bot.sendMessage(
        chatId,
        `‚úèÔ∏è **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ –≤–µ—Å–∞**\n\n` +
        `–¢–µ–∫—É—â–∏–π –≤–µ—Å: **${lastWeight.value} ${lastWeight.unit}**\n` +
        `–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏: ${new Date(lastWeight.recorded_at).toLocaleDateString('ru-RU')}\n\n` +
        `–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –≤–µ—Å –≤ –∫–∏–ª–æ–≥—Ä–∞–º–º–∞—Ö:`,
        { parse_mode: 'Markdown' }
      );
      return;
    }

    if (text === '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å') {
      await bot.sendMessage(
        chatId,
        '‚úèÔ∏è **–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–ª–∏**\n\n' +
        '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ü–µ–ª–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:',
        { parse_mode: 'Markdown', ...goalTypesKeyboard }
      );
      return;
    }

    if (text === '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É') {
      const lastWorkout = await getLastWorkoutRecord(dbUser.id);
      if (!lastWorkout) {
        await bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è.');
        return;
      }
      
      userStates.set(user.id, { action: 'waiting_workout_update' });
      await bot.sendMessage(
        chatId,
        `‚úèÔ∏è **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏**\n\n` +
        `–¢–∏–ø: **${lastWorkout.workout_type}**\n` +
        `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: **${lastWorkout.duration_minutes} –º–∏–Ω**\n` +
        `–ö–∞–ª–æ—Ä–∏–∏: **${lastWorkout.calories_burned || 0}**\n` +
        `–î–∞—Ç–∞: ${new Date(lastWorkout.workout_date).toLocaleDateString('ru-RU')}\n\n` +
        `–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–∏–ø —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:`,
        { parse_mode: 'Markdown', ...workoutTypesKeyboard }
      );
      return;
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –£–î–ê–õ–ï–ù–ò–Ø –ó–ê–ü–ò–°–ï–ô ===
    
    if (text === 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–µ—Å') {
      const lastWeight = await getLastWeightRecord(dbUser.id);
      if (!lastWeight) {
        await bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤–µ—Å–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
        return;
      }
      
      const deleted = await deleteLastWeightRecord(dbUser.id);
      if (deleted) {
        await bot.sendMessage(
          chatId,
          `‚úÖ **–ó–∞–ø–∏—Å—å –≤–µ—Å–∞ —É–¥–∞–ª–µ–Ω–∞**\n\n` +
          `–£–¥–∞–ª–µ–Ω –≤–µ—Å: **${lastWeight.value} ${lastWeight.unit}**\n` +
          `–î–∞—Ç–∞: ${new Date(lastWeight.recorded_at).toLocaleDateString('ru-RU')}`,
          { parse_mode: 'Markdown', ...userDataKeyboard }
        );
      } else {
        await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –≤–µ—Å–∞.');
      }
      return;
    }

    if (text === 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å') {
      await bot.sendMessage(
        chatId,
        'üóëÔ∏è **–£–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–ª–∏**\n\n' +
        '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ü–µ–ª–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:',
        { parse_mode: 'Markdown', ...goalTypesKeyboard }
      );
      userStates.set(user.id, { action: 'delete_goal' });
      return;
    }

    if (text === 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É') {
      const lastWorkout = await getLastWorkoutRecord(dbUser.id);
      if (!lastWorkout) {
        await bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
        return;
      }
      
      const deleted = await deleteLastWorkoutRecord(dbUser.id);
      if (deleted) {
        await bot.sendMessage(
          chatId,
          `‚úÖ **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞**\n\n` +
          `–¢–∏–ø: **${lastWorkout.workout_type}**\n` +
          `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: **${lastWorkout.duration_minutes} –º–∏–Ω**\n` +
          `–î–∞—Ç–∞: ${new Date(lastWorkout.workout_date).toLocaleDateString('ru-RU')}`,
          { parse_mode: 'Markdown', ...userDataKeyboard }
        );
      } else {
        await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.');
      }
      return;
    }

    if (text === 'üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë') {
      userStates.set(user.id, { action: 'confirm_clear_all' });
      await bot.sendMessage(
        chatId,
        '‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï!**\n\n' +
        '–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –í–°–ï —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ:\n' +
        '‚Ä¢ –ó–∞–ø–∏—Å–∏ –≤–µ—Å–∞\n' +
        '‚Ä¢ –í—Å–µ —Ü–µ–ª–∏\n' +
        '‚Ä¢ –ò—Å—Ç–æ—Ä–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è\n\n' +
        '‚ùó –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!\n\n' +
        '–í–≤–µ–¥–∏—Ç–µ `–£–î–ê–õ–ò–¢–¨ –í–°–Å` –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–º–µ–Ω—ã.',
        { parse_mode: 'Markdown' }
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –¥–ª—è –ø–æ–¥–º–µ–Ω—é
    if (text === '‚¨ÖÔ∏è –ù–∞–∑–∞–¥') {
      const state = userStates.get(user.id);
      if (state && state.action === 'delete_goal') {
        userStates.delete(user.id);
      }
      await bot.sendMessage(
        chatId,
        'üéØ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
        { parse_mode: 'Markdown', ...userDataKeyboard }
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏–∑ –ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    if (text.includes('/deepresearch')) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
      const subscription = await getActiveSubscription(dbUser.id);
      if (!subscription) {
        await bot.sendMessage(chatId, 'üîí –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π!', noSubscriptionKeyboard);
        return;
      }
      
      userStates.set(user.id, 'waiting_for_research_topic');
      await bot.sendMessage(chatId, 
        'üî¨ **–ì–ª—É–±–æ–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ**\n\n' +
        '–£–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –Ω–∞—É—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.\n\n' +
        'üí° **–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–º:**\n' +
        '‚Ä¢ –í–ª–∏—è–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–Ω–∞ –Ω–∞ —Å–∏–ª–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏\n' +
        '‚Ä¢ –ì–µ–Ω–¥–µ—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –≤ —Å–∏–ª–æ–≤–æ–º —Ç—Ä–µ–Ω–∏–Ω–≥–µ\n' +
        '‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∫–∞—Ä–¥–∏–æ –∏ —Å–∏–ª–æ–≤—ã—Ö\n' +
        '‚Ä¢ –ü–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã\n' +
        '‚Ä¢ –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è\n\n' +
        'üìù –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ç–µ–º—É:'
      );
      return;
    }

    if (text.includes('/training_program')) {
      const subscription = await getActiveSubscription(dbUser.id);
      if (!subscription) {
        await bot.sendMessage(chatId, 'üîí –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π!', noSubscriptionKeyboard);
        return;
      }
      
      userStates.set(user.id, 'waiting_for_training_request');
      await bot.sendMessage(chatId, 
        'üèãÔ∏è‚Äç‚ôÇÔ∏è **–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã**\n\n' +
        '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ –æ –≤–∞—à–∏—Ö —Ü–µ–ª—è—Ö –∏ —É—Å–ª–æ–≤–∏—è—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:\n\n' +
        'üìã **–£–∫–∞–∂–∏—Ç–µ:**\n' +
        '‚Ä¢ –¶–µ–ª—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (–ø–æ—Ö—É–¥–µ–Ω–∏–µ, –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã, —Å–∏–ª–∞, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å)\n' +
        '‚Ä¢ –£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (–Ω–æ–≤–∏—á–æ–∫, —Å—Ä–µ–¥–Ω–∏–π, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)\n' +
        '‚Ä¢ –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é –≥–æ—Ç–æ–≤—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è\n' +
        '‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É\n' +
        '‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–∑–∞–ª, –¥–æ–º, –∫–∞–∫–∏–µ —Å–Ω–∞—Ä—è–¥—ã)\n' +
        '‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∑–¥–æ—Ä–æ–≤—å—é (–µ—Å–ª–∏ –µ—Å—Ç—å)\n\n' +
        'üìù –û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:'
      );
      return;
    }

    if (text.includes('/nutrition_plan')) {
      const subscription = await getActiveSubscription(dbUser.id);
      if (!subscription) {
        await bot.sendMessage(chatId, 'üîí –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π!', noSubscriptionKeyboard);
        return;
      }
      
      userStates.set(user.id, 'waiting_for_nutrition_request');
      await bot.sendMessage(chatId, 
        'ü•ó **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è**\n\n' +
        '–î–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è —É–∫–∞–∂–∏—Ç–µ:\n\n' +
        'üìä **–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**\n' +
        '‚Ä¢ –¶–µ–ª—å (–ø–æ—Ö—É–¥–µ–Ω–∏–µ, –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã, –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞)\n' +
        '‚Ä¢ –ü–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ—Å—Ç, —Ç–µ–∫—É—â–∏–π –≤–µ—Å\n' +
        '‚Ä¢ –£—Ä–æ–≤–µ–Ω—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n' +
        '‚Ä¢ –°–∫–æ–ª—å–∫–æ –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ\n\n' +
        'üçΩÔ∏è **–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è:**\n' +
        '‚Ä¢ –ê–ª–ª–µ—Ä–≥–∏–∏ –∏–ª–∏ –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n' +
        '‚Ä¢ –û—Å–æ–±—ã–π —Ç–∏–ø –ø–∏—Ç–∞–Ω–∏—è (–≤–µ–≥–∞–Ω, –∫–µ—Ç–æ, –±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞ –∏ —Ç.–¥.)\n' +
        '‚Ä¢ –ù–µ–ª—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã\n' +
        '‚Ä¢ –ë—é–¥–∂–µ—Ç –Ω–∞ –ø–∏—Ç–∞–Ω–∏–µ\n\n' +
        'üìù –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ:'
      );
      return;
    }

    if (text.includes('/composition_analysis')) {
      const subscription = await getActiveSubscription(dbUser.id);
      if (!subscription) {
        await bot.sendMessage(chatId, 'üîí –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π!', noSubscriptionKeyboard);
        return;
      }
      
      userStates.set(user.id, 'waiting_for_supplement_info');
      await bot.sendMessage(chatId, 
        'üß™ **–ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞ –¥–æ–±–∞–≤–∫–∏**\n\n' +
        '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–±–∞–≤–∫–µ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:\n\n' +
        'üì∑ **–°–ø–æ—Å–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∫–∏:**\n' +
        '‚Ä¢ –§–æ—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∏ —Å —Å–æ—Å—Ç–∞–≤–æ–º\n' +
        '‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–∫–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è\n' +
        '‚Ä¢ –°–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å –¥–æ–∑–∏—Ä–æ–≤–∫–∞–º–∏\n\n' +
        'üîç **–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é:**\n' +
        '‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤\n' +
        '‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–æ–∑–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ –ù–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è\n' +
        '‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é\n' +
        '‚Ä¢ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã\n\n' +
        'üìù –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–±–∞–≤–∫–µ:'
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–ø–∏—Å–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    if (['üí™ –°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', 'üèÉ‚Äç‚ôÇÔ∏è –ö–∞—Ä–¥–∏–æ', 'üßò‚Äç‚ôÄÔ∏è –ô–æ–≥–∞/–†–∞—Å—Ç—è–∂–∫–∞', 'üèãÔ∏è‚Äç‚ôÄÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è'].includes(text)) {
      await handleWorkoutType(bot, chatId, dbUser.id, text);
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–µ–∂–∏–º–æ–≤ –∑–∞–ø–∏—Å–∏ —Å–∏–ª–æ–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    if (text === 'üî• –î–µ—Ç–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å') {
      // –ù–∞—á–∏–Ω–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å–∏–ª–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
      activeWorkouts.set(user.id, {
        type: 'strength',
        startTime: Date.now(),
        exercises: []
      });
      
      await bot.sendMessage(
        chatId,
        'üí™ **–°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –Ω–∞—á–∞—Ç–∞!**\n\n' +
        'üèãÔ∏è‚Äç‚ôÇÔ∏è –î–æ–±–∞–≤–ª—è–π—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –º–µ—Ä–µ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.\n' +
        '–î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤, –≤–µ—Å –æ—Ç—è–≥–æ—â–µ–Ω–∏—è, –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.',
        { parse_mode: 'Markdown', ...detailedWorkoutKeyboard }
      );
      return;
    }

    if (text === '‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–ø–∏—Å—å') {
      // –ë—ã—Å—Ç—Ä–∞—è –∑–∞–ø–∏—Å—å —Å–∏–ª–æ–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      try {
        const duration = 60; // 60 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const calories = 300;
        const intensity = 3; // —Å—Ä–µ–¥–Ω—è—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
        const exercisesCount = 8;
        
        await addWorkout(dbUser.id, 'strength', duration, calories, intensity, exercisesCount, '–°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞');

        await bot.sendMessage(
          chatId,
          '‚úÖ –°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞!\n\n' +
          'üìä –î–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:\n' +
          '‚è± –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 60 –º–∏–Ω—É—Ç\n' +
          'üî• –ö–∞–ª–æ—Ä–∏–∏: 300 –∫–∫–∞–ª\n' +
          'üìà –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: 3/5\n' +
          'üèãÔ∏è‚Äç‚ôÇÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: 8\n\n' +
          'üí° –í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —É—á—ë—Ç–∞!',
          workoutKeyboard
        );
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –±—ã—Å—Ç—Ä–æ–π –∑–∞–ø–∏—Å–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
        await bot.sendMessage(
          chatId,
          '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
          workoutKeyboard
        );
      }
      return;
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–ï–¢–ê–õ–¨–ù–û–ô –°–ò–õ–û–í–û–ô –¢–†–ï–ù–ò–†–û–í–ö–ò ===
    
    if (text === '‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ') {
      console.log(`üèãÔ∏è‚Äç‚ôÇÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}`);
      if (!activeWorkouts.has(user.id)) {
        console.log(`‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id} –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏`);
        await bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é —Å–∏–ª–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É.');
        return;
      }
      
      console.log(`‚úÖ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id} –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è`);
      await bot.sendMessage(
        chatId,
        'üèãÔ∏è‚Äç‚ôÇÔ∏è **–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ**\n\n' +
        '–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ:',
        { parse_mode: 'Markdown', ...popularExercisesKeyboard }
      );
      userStates.set(user.id, { action: 'selecting_exercise' });
      return;
    }

    if (text === 'üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É') {
      const workout = activeWorkouts.get(user.id);
      if (!workout) {
        await bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.');
        return;
      }
      
      await showCurrentWorkout(bot, chatId, workout);
      return;
    }

    if (text === '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É') {
      const workout = activeWorkouts.get(user.id);
      if (!workout) {
        await bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.');
        return;
      }
      
      if (workout.exercises.length === 0) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ù–µ–ª—å–∑—è –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –±–µ–∑ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.\n\n–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É.',
          { parse_mode: 'Markdown', ...detailedWorkoutKeyboard }
        );
        return;
      }
      
      const moodKeyboard = {
        reply_markup: {
          inline_keyboard: [
            [
              { text: 'üòÑ –û—Ç–ª–∏—á–Ω–æ', callback_data: 'mood_5' },
              { text: 'üòä –•–æ—Ä–æ—à–æ', callback_data: 'mood_4' }
            ],
            [
              { text: 'üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ', callback_data: 'mood_3' },
              { text: 'üòï –ü–ª–æ—Ö–æ', callback_data: 'mood_2' }
            ],
            [
              { text: 'üòû –£–∂–∞—Å–Ω–æ', callback_data: 'mood_1' }
            ]
          ]
        }
      };
      
      await bot.sendMessage(
        chatId,
        'üéØ **–û—Ü–µ–Ω–∏—Ç–µ –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:**\n\n' +
        '–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–µ–π—á–∞—Å?',
        { parse_mode: 'Markdown', ...moodKeyboard }
      );
      userStates.set(user.id, { action: 'waiting_mood_after' });
      return;
    }

    if (text === '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É') {
      if (activeWorkouts.has(user.id)) {
        activeWorkouts.delete(user.id);
        userStates.delete(user.id);
        await bot.sendMessage(
          chatId,
          '‚ùå **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞**\n\n–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã.',
          { parse_mode: 'Markdown', ...userDataKeyboard }
        );
      } else {
        await bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.');
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
    if (['üèãÔ∏è‚Äç‚ôÇÔ∏è –ñ–∏–º –ª–µ–∂–∞', 'üèãÔ∏è‚Äç‚ôÇÔ∏è –ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è', 'üèãÔ∏è‚Äç‚ôÇÔ∏è –°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞', 'üèãÔ∏è‚Äç‚ôÇÔ∏è –ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è'].includes(text)) {
      const userState = userStates.get(user.id);
      if (userState && userState.action === 'selecting_exercise') {
        // –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        const exerciseName = text.replace('üèãÔ∏è‚Äç‚ôÇÔ∏è ', '');
        userStates.set(user.id, { action: 'waiting_sets_count', exerciseName: exerciseName });
        
        await bot.sendMessage(
          chatId,
          `üèãÔ∏è‚Äç‚ôÇÔ∏è **${exerciseName}**\n\n` +
          `–°–∫–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å?\n\n` +
          `üí° –ü—Ä–∏–º–µ—Ä—ã: 3, 4, 5`,
          { parse_mode: 'Markdown' }
        );
      }
      return;
    }

    if (text === 'üìù –î—Ä—É–≥–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ') {
      const userState = userStates.get(user.id);
      if (userState && userState.action === 'selecting_exercise') {
        userStates.set(user.id, { action: 'waiting_custom_exercise' });
        
        await bot.sendMessage(
          chatId,
          '‚úèÔ∏è **–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è**\n\n' +
          'üí° –ü—Ä–∏–º–µ—Ä—ã:\n' +
          '‚Ä¢ –ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π\n' +
          '‚Ä¢ –ú–∞—Ö–∏ –≥–∏—Ä–µ–π\n' +
          '‚Ä¢ –ü–ª–∞–Ω–∫–∞',
          { parse_mode: 'Markdown' }
        );
      }
      return;
    }

    // === –û–ë–†–ê–ë–û–¢–ö–ê –°–û–°–¢–û–Ø–ù–ò–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–• –î–ê–ù–ù–´–• ===
    
    const userState = userStates.get(user.id);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤–µ—Å–∞
    if (userState && userState.action === 'waiting_weight') {
      const weight = parseFloat(text.replace(',', '.'));
      if (isNaN(weight) || weight <= 0 || weight > 300) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å (—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 300).\n\nüí° –ü—Ä–∏–º–µ—Ä—ã: `75.5`, `68`, `82.3`',
          { parse_mode: 'Markdown' }
        );
        return;
      }

      try {
        await saveFitnessMetric(dbUser.id, 'weight', weight, 'kg');
        userStates.delete(user.id);
        
        await bot.sendMessage(
          chatId,
          `‚úÖ **–í–µ—Å –∑–∞–ø–∏—Å–∞–Ω!**\n\n` +
          `üìä –í–∞—à –≤–µ—Å: **${weight} –∫–≥**\n` +
          `üìÖ –î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}\n\n` +
          `–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –≤–µ—Å —Ä–µ–≥—É–ª—è—Ä–Ω–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞!`,
          { parse_mode: 'Markdown', ...userDataKeyboard }
        );
      } catch (error) {
        await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–µ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Ü–µ–ª–∏
    if (userState && userState.action === 'waiting_goal_value') {
      try {
        const goalType = userState.goalType;
        let targetValue = text.trim();
        
        // –î–ª—è –≤–µ—Å–∞ –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —á–∏—Å–ª–æ
        if (goalType === '—Å–Ω–∏–∑–∏—Ç—å –≤–µ—Å') {
          const weight = parseFloat(text.replace(',', '.'));
          if (isNaN(weight) || weight <= 0 || weight > 300) {
            await bot.sendMessage(
              chatId,
              '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ü–µ–ª–µ–≤–æ–π –≤–µ—Å (—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 300).\n\nüí° –ü—Ä–∏–º–µ—Ä: `70`',
              { parse_mode: 'Markdown' }
            );
            return;
          }
          targetValue = weight.toString();
        }

        await setUserGoal(dbUser.id, goalType, targetValue);
        userStates.delete(user.id);
        
        await bot.sendMessage(
          chatId,
          `‚úÖ **–¶–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!**\n\n` +
          `üéØ –¢–∏–ø: **${goalType}**\n` +
          `üìä –¶–µ–ª—å: **${targetValue}**\n` +
          `üìÖ –î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}\n\n` +
          `–£–¥–∞—á–∏ –≤ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–∏! üí™`,
          { parse_mode: 'Markdown', ...userDataKeyboard }
        );
      } catch (error) {
        await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ü–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    if (userState && userState.action === 'waiting_workout_duration') {
      const duration = parseInt(text);
      if (isNaN(duration) || duration <= 0 || duration > 600) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ—Ç 1 –¥–æ 600 –º–∏–Ω—É—Ç).\n\nüí° –ü—Ä–∏–º–µ—Ä—ã: `45`, `90`, `30`',
          { parse_mode: 'Markdown' }
        );
        return;
      }

      userStates.set(user.id, { 
        action: 'waiting_workout_calories', 
        workoutType: userState.workoutType, 
        duration: duration 
      });
      
      await bot.sendMessage(
        chatId,
        'üî• **–ü–æ—Ç—Ä–∞—á–µ–Ω–Ω—ã–µ –∫–∞–ª–æ—Ä–∏–∏**\n\n' +
        `–¢–∏–ø: **${userState.workoutType}**\n` +
        `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: **${duration} –º–∏–Ω**\n\n` +
        '–°–∫–æ–ª—å–∫–æ –∫–∞–ª–æ—Ä–∏–π –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏? (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)\n\n' +
        'üí° –ü—Ä–∏–º–µ—Ä—ã:\n' +
        '‚Ä¢ `300` (300 –∫–∞–ª–æ—Ä–∏–π)\n' +
        '‚Ä¢ `0` (–µ—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ)',
        { parse_mode: 'Markdown' }
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –∫–∞–ª–æ—Ä–∏–π –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    if (userState && userState.action === 'waiting_workout_calories') {
      const calories = parseInt(text) || 0;
      if (calories < 0 || calories > 2000) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π (–æ—Ç 0 –¥–æ 2000).\n\nüí° –ü—Ä–∏–º–µ—Ä—ã: `300`, `450`, `0`',
          { parse_mode: 'Markdown' }
        );
        return;
      }

      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ä–¥–∏–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        const workoutDetails = {
          type: userState.workoutType,
          duration: userState.duration,
          calories: calories,
          averageIntensity: 'medium',
          totalCalories: calories,
          exercises: [] // –î–ª—è –∫–∞—Ä–¥–∏–æ –Ω–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
        };
        
        await saveDetailedWorkout(
          dbUser.id, 
          'cardio', 
          userState.duration, 
          workoutDetails,
          null, // moodBefore
          null, // moodAfter
          `–ö–∞—Ä–¥–∏–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${userState.workoutType}` // notes
        );
        userStates.delete(user.id);
        
        await bot.sendMessage(
          chatId,
          `‚úÖ **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞!**\n\n` +
          `üèãÔ∏è‚Äç‚ôÇÔ∏è –¢–∏–ø: **${userState.workoutType}**\n` +
          `‚è±Ô∏è –í—Ä–µ–º—è: **${userState.duration} –º–∏–Ω**\n` +
          `üî• –ö–∞–ª–æ—Ä–∏–∏: **${calories}**\n` +
          `üìÖ –î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}\n\n` +
          `–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üí™`,
          { parse_mode: 'Markdown', ...userDataKeyboard }
        );
      } catch (error) {
        await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Å–∞
    if (userState && userState.action === 'waiting_weight_update') {
      const weight = parseFloat(text.replace(',', '.'));
      if (isNaN(weight) || weight <= 0 || weight > 300) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å (—á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 300).\n\nüí° –ü—Ä–∏–º–µ—Ä—ã: `75.5`, `68`, `82.3`',
          { parse_mode: 'Markdown' }
        );
        return;
      }

      try {
        const updated = await updateLastWeightRecord(dbUser.id, weight);
        userStates.delete(user.id);
        
        if (updated) {
          await bot.sendMessage(
            chatId,
            `‚úÖ **–í–µ—Å –æ–±–Ω–æ–≤–ª–µ–Ω!**\n\n` +
            `üìä –ù–æ–≤—ã–π –≤–µ—Å: **${weight} –∫–≥**\n` +
            `üìÖ –î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}`,
            { parse_mode: 'Markdown', ...userDataKeyboard }
          );
        } else {
          await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ—Å–∞.');
        }
      } catch (error) {
        await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
    if (userState && userState.action === 'confirm_clear_all') {
      if (text.trim().toUpperCase() === '–£–î–ê–õ–ò–¢–¨ –í–°–Å') {
        try {
          await clearAllUserData(dbUser.id);
          userStates.delete(user.id);
          
          await bot.sendMessage(
            chatId,
            `‚úÖ **–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã**\n\n` +
            `üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ:\n` +
            `‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Å–∞\n` +
            `‚Ä¢ –í—Å–µ —Ü–µ–ª–∏\n` +
            `‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n` +
            `‚Ä¢ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è\n\n` +
            `–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–Ω–æ–≤–æ.`,
            { parse_mode: 'Markdown', ...userDataKeyboard }
          );
        } catch (error) {
          await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.');
        }
      } else {
        userStates.delete(user.id);
        await bot.sendMessage(
          chatId,
          '‚ùå **–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ**\n\n–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.',
          { parse_mode: 'Markdown', ...userDataKeyboard }
        );
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ü–µ–ª–∏
    if (userState && userState.action === 'delete_goal') {
      if (['üéØ –¶–µ–ª–µ–≤–æ–π –≤–µ—Å', 'üí™ –ù–∞–±–æ—Ä –º—ã—à—Ü', 'üî• –°–∂–∏–≥–∞–Ω–∏–µ –∂–∏—Ä–∞', 'üèÉ‚Äç‚ôÇÔ∏è –£–ª—É—á—à–∏—Ç—å –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å', 'üèãÔ∏è‚Äç‚ôÇÔ∏è –£–≤–µ–ª–∏—á–∏—Ç—å —Å–∏–ª—É', 'üßò‚Äç‚ôÇÔ∏è –£–ª—É—á—à–∏—Ç—å –≥–∏–±–∫–æ—Å—Ç—å'].includes(text)) {
        const goalType = text.split(' ').slice(1).join(' ').toLowerCase();
        
        try {
          const deleted = await deleteUserGoal(dbUser.id, goalType);
          userStates.delete(user.id);
          
          if (deleted) {
            await bot.sendMessage(
              chatId,
              `‚úÖ **–¶–µ–ª—å —É–¥–∞–ª–µ–Ω–∞**\n\n` +
              `üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Ü–µ–ª—å: **${goalType}**`,
              { parse_mode: 'Markdown', ...userDataKeyboard }
            );
          } else {
            await bot.sendMessage(
              chatId,
              `‚ùå –¶–µ–ª—å "${goalType}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`,
              { parse_mode: 'Markdown', ...userDataKeyboard }
            );
          }
        } catch (error) {
          await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ü–µ–ª–∏.');
        }
        return;
      }
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–ï–¢–ê–õ–¨–ù–´–• –¢–†–ï–ù–ò–†–û–í–û–ö ===
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
    if (userState && userState.action === 'waiting_custom_exercise') {
      if (text.length < 2 || text.length > 50) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤.'
        );
        return;
      }

      userStates.set(user.id, { action: 'waiting_sets_count', exerciseName: text });
      
      await bot.sendMessage(
        chatId,
        `üèãÔ∏è‚Äç‚ôÇÔ∏è **${text}**\n\n` +
        `–°–∫–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å?\n\n` +
        `üí° –ü—Ä–∏–º–µ—Ä—ã: 3, 4, 5`,
        { parse_mode: 'Markdown' }
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–æ–≤
    if (userState && userState.action === 'waiting_sets_count') {
      const setsCount = parseInt(text);
      if (isNaN(setsCount) || setsCount < 1 || setsCount > 10) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –æ—Ç 1 –¥–æ 10.'
        );
        return;
      }

      const exercise = {
        name: userState.exerciseName,
        sets: [],
        totalSets: setsCount,
        currentSet: 1
      };

      const workout = activeWorkouts.get(user.id);
      if (workout) {
        workout.exercises.push(exercise);
        
        await bot.sendMessage(
          chatId,
          `üèãÔ∏è‚Äç‚ôÇÔ∏è **${exercise.name}**\n\n` +
          `üìä –ü–æ–¥—Ö–æ–¥ ${exercise.currentSet} –∏–∑ ${exercise.totalSets}\n\n` +
          `‚öñÔ∏è –í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –æ—Ç—è–≥–æ—â–µ–Ω–∏—è (–≤ –∫–≥):\n\n` +
          `üí° –ü—Ä–∏–º–µ—Ä—ã:\n` +
          `‚Ä¢ 50 - —à—Ç–∞–Ω–≥–∞ 50 –∫–≥\n` +
          `‚Ä¢ 20 - –≥–∞–Ω—Ç–µ–ª–∏ 20 –∫–≥\n` +
          `‚Ä¢ 0 - —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å (–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è, –æ—Ç–∂–∏–º–∞–Ω–∏—è)`,
          { parse_mode: 'Markdown' }
        );
        
        userStates.set(user.id, { 
          action: 'waiting_exercise_weight', 
          exerciseIndex: workout.exercises.length - 1 
        });
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ—Å–∞ –æ—Ç—è–≥–æ—â–µ–Ω–∏—è
    if (userState && userState.action === 'waiting_exercise_weight') {
      const weight = parseFloat(text);
      if (isNaN(weight) || weight < 0 || weight > 1000) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–µ—Å –æ—Ç—è–≥–æ—â–µ–Ω–∏—è –æ—Ç 0 –¥–æ 1000 –∫–≥.\n\n' +
          'üí° 0 = —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å (–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç—è–≥–æ—â–µ–Ω–∏—è)'
        );
        return;
      }

      const workout = activeWorkouts.get(user.id);
      const exercise = workout.exercises[userState.exerciseIndex];
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
      exercise.currentWeight = weight;
      
      await bot.sendMessage(
        chatId,
        `üèãÔ∏è‚Äç‚ôÇÔ∏è **${exercise.name}**\n\n` +
        `üìä –ü–æ–¥—Ö–æ–¥ ${exercise.currentSet} –∏–∑ ${exercise.totalSets}\n` +
        `‚öñÔ∏è –û—Ç—è–≥–æ—â–µ–Ω–∏–µ: ${weight === 0 ? '—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å' : weight + ' –∫–≥'}\n\n` +
        `–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π:\n\n` +
        `üí° –ü—Ä–∏–º–µ—Ä—ã: 10, 12, 8`,
        { parse_mode: 'Markdown' }
      );

      userStates.set(user.id, { 
        action: 'waiting_reps', 
        exerciseIndex: userState.exerciseIndex 
      });
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
    if (userState && userState.action === 'waiting_reps') {
      const reps = parseInt(text);
      if (isNaN(reps) || reps < 1 || reps > 100) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –æ—Ç 1 –¥–æ 100.'
        );
        return;
      }

      const workout = activeWorkouts.get(user.id);
      const exercise = workout.exercises[userState.exerciseIndex];
      
      exercise.sets.push({ 
        reps: reps, 
        weight: exercise.currentWeight || 0, 
        notes: null 
      });
      
      if (exercise.currentSet < exercise.totalSets) {
        exercise.currentSet++;
        
        await bot.sendMessage(
          chatId,
          `‚úÖ **–ü–æ–¥—Ö–æ–¥ ${exercise.currentSet - 1}: ${reps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π** ${exercise.currentWeight === 0 ? '(—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å)' : '(' + exercise.currentWeight + ' –∫–≥)'}\n\n` +
          `üèãÔ∏è‚Äç‚ôÇÔ∏è **${exercise.name}**\n` +
          `üìä –ü–æ–¥—Ö–æ–¥ ${exercise.currentSet} –∏–∑ ${exercise.totalSets}\n\n` +
          `‚öñÔ∏è –í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –æ—Ç—è–≥–æ—â–µ–Ω–∏—è (–≤ –∫–≥):`,
          { parse_mode: 'Markdown' }
        );

        userStates.set(user.id, { 
          action: 'waiting_exercise_weight', 
          exerciseIndex: userState.exerciseIndex 
        });
      } else {
        await bot.sendMessage(
          chatId,
          `‚úÖ **–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "${exercise.name}" –∑–∞–≤–µ—Ä—à–µ–Ω–æ!**\n\n` +
          `üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:\n` +
          exercise.sets.map((set, i) => 
            `–ü–æ–¥—Ö–æ–¥ ${i + 1}: ${set.reps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π ${set.weight === 0 ? '(—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å)' : '(' + set.weight + ' –∫–≥)'}`
          ).join('\n') + '\n\n' +
          `üí¨ –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —ç—Ç–æ–º—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é?\n` +
          `(–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ª–µ–≥–∫–æ", "–¥–æ –æ—Ç–∫–∞–∑–∞", "—Ç—è–∂–µ–ª–æ")\n\n` +
          `–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.`,
          { 
            parse_mode: 'Markdown',
            reply_markup: {
              keyboard: [
                [{ text: '‚è© –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å' }],
                [{ text: '‚ûï –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ' }, { text: '‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É' }]
              ],
              resize_keyboard: true,
              one_time_keyboard: false
            }
          }
        );
        
        userStates.set(user.id, { 
          action: 'waiting_exercise_notes', 
          exerciseIndex: userState.exerciseIndex 
        });
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é
    if (userState && userState.action === 'waiting_exercise_notes') {
      const workout = activeWorkouts.get(user.id);
      const exercise = workout.exercises[userState.exerciseIndex];
      
      if (text !== '‚è© –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å') {
        exercise.notes = text;
        await bot.sendMessage(
          chatId,
          `‚úÖ **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω:** "${text}"\n\n` +
          `–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É:`,
          { parse_mode: 'Markdown', ...detailedWorkoutKeyboard }
        );
      } else {
        await bot.sendMessage(
          chatId,
          `‚úÖ **–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ**\n\n` +
          `–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É:`,
          { parse_mode: 'Markdown', ...detailedWorkoutKeyboard }
        );
      }
      
      userStates.delete(user.id);
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    if (userState && userState.action === 'waiting_mood_after') {
      const moodValue = parseMoodValue(text);
      const moodKeyboard = {
        reply_markup: {
          inline_keyboard: [
            [
              { text: 'üòÑ –û—Ç–ª–∏—á–Ω–æ', callback_data: 'mood_5' },
              { text: 'üòä –•–æ—Ä–æ—à–æ', callback_data: 'mood_4' }
            ],
            [
              { text: 'üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ', callback_data: 'mood_3' },
              { text: 'üòï –ü–ª–æ—Ö–æ', callback_data: 'mood_2' }
            ],
            [
              { text: 'üòû –£–∂–∞—Å–Ω–æ', callback_data: 'mood_1' }
            ]
          ]
        }
      };
      
      if (moodValue === null) {
        await bot.sendMessage(
          chatId,
          '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.',
          { parse_mode: 'Markdown', ...moodKeyboard }
        );
        return;
      }

      const workout = activeWorkouts.get(user.id);
      if (workout) {
        workout.moodAfter = moodValue;
        
        await bot.sendMessage(
          chatId,
          'üìù **–§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**\n\n' +
          '–î–æ–±–∞–≤—å—Ç–µ –æ–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ:\n' +
          '‚Ä¢ –ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?\n' +
          '‚Ä¢ –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ö–æ—Ä–æ—à–æ?\n' +
          '‚Ä¢ –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å?\n\n' +
          '–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å":',
          { 
            parse_mode: 'Markdown',
            reply_markup: {
              keyboard: [
                [{ text: '‚è© –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å' }]
              ],
              resize_keyboard: true,
              one_time_keyboard: true
            }
          }
        );
        
        userStates.set(user.id, { action: 'waiting_workout_notes' });
      }
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ
    if (userState && userState.action === 'waiting_workout_notes') {
      const workout = activeWorkouts.get(user.id);
      if (workout) {
        const workoutNotes = text === '‚è© –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å' ? null : text;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        try {
          const workoutDetails = {
            exercises: workout.exercises,
            totalExercises: workout.exercises.length,
            totalSets: workout.exercises.reduce((sum, ex) => sum + ex.sets.length, 0),
            totalReps: workout.exercises.reduce((sum, ex) => 
              sum + ex.sets.reduce((setSum, set) => setSum + set.reps, 0), 0
            ),
            totalWeight: workout.exercises.reduce((sum, ex) => 
              sum + ex.sets.reduce((setSum, set) => setSum + (set.weight * set.reps), 0), 0
            ),
            averageIntensity: 'medium',
            duration: Math.round((new Date() - workout.startTime) / (1000 * 60)) // –≤ –º–∏–Ω—É—Ç–∞—Ö
          };

          await saveDetailedWorkout(
            dbUser.id,
            'strength',
            workoutDetails.duration,
            workoutDetails,
            workout.moodBefore,
            workout.moodAfter,
            workoutNotes
          );

          // –û—á–∏—â–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
          activeWorkouts.delete(user.id);
          userStates.delete(user.id);

          await bot.sendMessage(
            chatId,
            `üéâ **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!**\n\n` +
            `üí™ **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**\n` +
            `‚Ä¢ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: ${workoutDetails.totalExercises}\n` +
            `‚Ä¢ –ü–æ–¥—Ö–æ–¥–æ–≤: ${workoutDetails.totalSets}\n` +
            `‚Ä¢ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–π: ${workoutDetails.totalReps}\n` +
            `‚Ä¢ –ü–æ–¥–Ω—è—Ç–æ —Å –æ—Ç—è–≥–æ—â–µ–Ω–∏–µ–º: ${workoutDetails.totalWeight} –∫–≥\n` +
            `‚Ä¢ –í—Ä–µ–º—è: ${workoutDetails.duration} –º–∏–Ω\n` +
            `‚Ä¢ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${getMoodEmoji(workout.moodBefore)} ‚Üí ${getMoodEmoji(workout.moodAfter)}\n\n` +
            `–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üí™`,
            { parse_mode: 'Markdown', ...userDataKeyboard }
          );

        } catch (error) {
          await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
        }
      }
      return;
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥–∞ —Ç–µ–º—ã –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
    if (userStates.get(user.id) === 'waiting_for_research_topic') {
      await handleSpecialAIRequest(bot, chatId, user, dbUser, text, 'üî¨ –ó–∞–ø—É—Å–∫–∞—é –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑', 'deep_research');
      return;
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
    if (userStates.get(user.id) === 'waiting_for_training_request') {
      await handleSpecialAIRequest(bot, chatId, user, dbUser, text, 'üèãÔ∏è‚Äç‚ôÇÔ∏è –°–æ–∑–¥–∞—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', 'training_program');
      return;
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è
    if (userStates.get(user.id) === 'waiting_for_nutrition_request') {
      await handleSpecialAIRequest(bot, chatId, user, dbUser, text, 'ü•ó –°–æ—Å—Ç–∞–≤–ª—è—é –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è', 'nutrition_plan');
      return;
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ–±–∞–≤–∫–µ
    if (userStates.get(user.id) === 'waiting_for_supplement_info') {
      await handleSpecialAIRequest(bot, chatId, user, dbUser, text, 'üß™ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–æ—Å—Ç–∞–≤ –¥–æ–±–∞–≤–∫–∏', 'composition_analysis');
      return;
    }

    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ —á–∞—Ç–∞ —Å –ò–ò
    if (userStates.get(user.id) === 'chatting_with_ai') {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
      const requestStatus = await canUserMakeRequest(dbUser.id);
      
      if (!requestStatus.canMake) {
        userStates.delete(user.id);
        await bot.sendMessage(
          chatId,
          '‚ùå –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É.\n\n' +
          'üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: 0/7\n' +
          'üíé –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è!',
          noSubscriptionKeyboard
        );
        return;
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Coze
      await bot.sendChatAction(chatId, 'typing');
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –±–æ—Ç –¥—É–º–∞–µ—Ç
      const thinkingMessage = await bot.sendMessage(chatId, 'ü§î –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à –≤–æ–ø—Ä–æ—Å...');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ workflow
      const workflowContext = userWorkflowContext.get(user.id);
      let messageWithContext = text;
      
      if (workflowContext && (Date.now() - workflowContext.timestamp) < 600000) { // 10 –º–∏–Ω—É—Ç
        messageWithContext = `–ö–û–ù–¢–ï–ö–°–¢ –ü–†–ï–î–´–î–£–©–ï–ì–û –ê–ù–ê–õ–ò–ó–ê:
–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞: ${workflowContext.type}
–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${workflowContext.query}"
–ü–æ–ª—É—á–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "${workflowContext.result.substring(0, 1000)}..."

–ù–û–í–´–ô –í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: ${text}`;
        
        console.log(`üìã –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç workflow –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}`);
      }
      
  const aiResponse = await runCozeChat(user.access_token, messageWithContext, user.id, '–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å‚Äë—Ç—Ä–µ–Ω–µ—Ä: –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã —Å–ø–∏—Å–∫–∞–º–∏, –∏–∑–±–µ–≥–∞–π –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.');
      
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–¥—É–º–∞–µ—Ç"
      try {
        await bot.deleteMessage(chatId, thinkingMessage.message_id);
      } catch (deleteError) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
      }
      
      if (aiResponse.success) {
        // –°–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
        if (requestStatus.type === 'free') {
          await useFreeRequest(dbUser.id);
          const freeRequests = await getUserFreeRequests(dbUser.id);
          await bot.sendMessage(
            chatId, 
            aiResponse.message + `\n\nüÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: ${freeRequests.remaining}/7`
          );
        } else if (requestStatus.type === 'subscription') {
          await incrementRequestUsage(dbUser.id);
          await bot.sendMessage(chatId, aiResponse.message);
        } else {
          await bot.sendMessage(chatId, aiResponse.message);
        }
      } else {
        await bot.sendMessage(chatId, aiResponse.message);
      }
      return;
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø ===
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    if (userStates.get(user.id) === 'waiting_confirm_delete_all_workouts') {
      if (text === '–£–î–ê–õ–ò–¢–¨ –í–°–ï –¢–†–ï–ù–ò–†–û–í–ö–ò') {
        userStates.delete(user.id);
        await processDeleteAllWorkouts(bot, chatId, dbUser.id);
        return;
      } else {
        userStates.delete(user.id);
        await bot.sendMessage(
          chatId,
          '‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\n\n–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω—É–∂–Ω–æ –±—ã–ª–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–æ—á–Ω–æ: `–£–î–ê–õ–ò–¢–¨ –í–°–ï –¢–†–ï–ù–ò–†–û–í–ö–ò`',
          { parse_mode: 'Markdown', ...mainKeyboard }
        );
        return;
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –≤–µ—Å–∞
    if (userStates.get(user.id) === 'waiting_confirm_delete_all_weights') {
      if (text === '–£–î–ê–õ–ò–¢–¨ –í–°–ï –í–ï–°–ê') {
        userStates.delete(user.id);
        await processDeleteAllWeights(bot, chatId, dbUser.id);
        return;
      } else {
        userStates.delete(user.id);
        await bot.sendMessage(
          chatId,
          '‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\n\n–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω—É–∂–Ω–æ –±—ã–ª–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–æ—á–Ω–æ: `–£–î–ê–õ–ò–¢–¨ –í–°–ï –í–ï–°–ê`',
          { parse_mode: 'Markdown', ...mainKeyboard }
        );
        return;
      }
    }

    // –ö–æ–º–∞–Ω–¥–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    if (text === '/menu') {
      userStates.delete(user.id);
      await bot.sendMessage(
        chatId,
        'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é',
        mainKeyboard
      );
      return;
    }

    // –ö–æ–º–∞–Ω–¥–∞ —Å–±—Ä–æ—Å–∞ –¥–∏–∞–ª–æ–≥–∞ —Å –ò–ò
    if (text === '/reset' || text === '/—Å–±—Ä–æ—Å') {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      userStates.delete(user.id);
      
      // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const accessToken = await getUserAccessToken(dbUser.id);
      clearConversation(dbUser.id);
      
      await bot.sendMessage(
        chatId,
        'üîÑ –î–∏–∞–ª–æ–≥ —Å –ò–ò —Å–±—Ä–æ—à–µ–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤–æ–µ –æ–±—â–µ–Ω–∏–µ —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.\n\nüí° –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—á–∏—â–µ–Ω—ã.',
        mainKeyboard
      );
      return;
    }

    // === –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===
    const currentState = userStates.get(user.id);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞—é—Ç –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–í–ï–°, –¶–ï–õ–ò –∏ —Ç.–¥.)
    if (currentState) {
      await handleUserState(bot, chatId, user, dbUser, text, currentState);
      return;
    }
    
    // === –ü–†–û–í–ï–†–ö–ê –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–• WORKFLOW ===
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow
    const activeWorkflow = userInteractiveWorkflow.get(user.id);
    if (activeWorkflow && (Date.now() - activeWorkflow.timestamp) < 600000) { // 10 –º–∏–Ω—É—Ç
      console.log(`üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.id} –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow: ${activeWorkflow.type}`);
      
      // –≠—Ç–æ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow
      await handleInteractiveWorkflowResponse(bot, chatId, user, dbUser, text, activeWorkflow);
      return;
    }
    
    // === –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î –ò–ò-–¢–†–ï–ù–ï–†–ê ===
    // –¢–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ "ü§ñ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä" –¥–æ–ª–∂–Ω–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å AI, –∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ 'chatting_with_ai' –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∏–∂–µ
    if (text === 'ü§ñ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä') {
      await handleAITrainerConversation(bot, chatId, user, dbUser, text);
      return;
    }
    
    // === –ü–†–û–í–ï–†–ö–ê –ü–û–î–ü–ò–°–ö–ò –î–õ–Ø AI –§–£–ù–ö–¶–ò–ô ===
    const subscription = await getActiveSubscription(dbUser.id);
    console.log(`User ${user.id} subscription status:`, subscription ? 'active' : 'none');

    // === –û–ë–†–ê–ë–û–¢–ö–ê WORKFLOW –ö–û–ú–ê–ù–î ===
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥ Coze (–Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å /)
    if (text.startsWith('/')) {
      console.log(`üîß –ö–æ–º–∞–Ω–¥–∞ Coze –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}:`, text);
      
      if (!subscription) {
        await bot.sendMessage(
          chatId,
          'ÔøΩ **–ò–ò-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å –ø–æ–¥–ø–∏—Å–∫–æ–π**\n\n' +
          'ÔøΩ –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º!',
          { parse_mode: 'Markdown', ...noSubscriptionKeyboard }
        );
        return;
      }
      
      await handleWorkflowCommands(bot, chatId, user, dbUser, text);
      return;
    }
    
    // === –û–ë–†–ê–ë–û–¢–ö–ê –†–ï–ñ–ò–ú–ê –ò–ò-–¢–†–ï–ù–ï–†–ê ===
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –æ–±—â–µ–Ω–∏—è —Å –ò–ò
    if (currentState === 'chatting_with_ai') {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
      const requestStatus = await canUserMakeRequest(dbUser.id);
      
      if (!requestStatus.canMake) {
        userStates.delete(user.id);
        await bot.sendMessage(
          chatId,
          '‚ùå –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É.\n\n' +
          'üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: 0/7\n' +
          'üíé –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è!',
          noSubscriptionKeyboard
        );
        return;
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ Coze
      await bot.sendChatAction(chatId, 'typing');
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –±–æ—Ç –¥—É–º–∞–µ—Ç
      const thinkingMessage = await bot.sendMessage(chatId, 'ü§î –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à –≤–æ–ø—Ä–æ—Å...');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ workflow
      const workflowContext = userWorkflowContext.get(user.id);
      let messageWithContext = text;
      
      if (workflowContext && (Date.now() - workflowContext.timestamp) < 600000) { // 10 –º–∏–Ω—É—Ç
        messageWithContext = `–ö–û–ù–¢–ï–ö–°–¢ –ü–†–ï–î–´–î–£–©–ï–ì–û –ê–ù–ê–õ–ò–ó–ê:
–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞: ${workflowContext.type}
–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${workflowContext.query}"
–ü–æ–ª—É—á–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "${workflowContext.result.substring(0, 1000)}..."

–ù–û–í–´–ô –í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: ${text}`;
        
        console.log(`üìã –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç workflow –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}`);
      }
      
      const aiResponse = await runCozeChat(user.access_token, messageWithContext, user.id, '–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å‚Äë—Ç—Ä–µ–Ω–µ—Ä: –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã —Å–ø–∏—Å–∫–∞–º–∏, –∏–∑–±–µ–≥–∞–π –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.');
      
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–¥—É–º–∞–µ—Ç"
      try {
        await bot.deleteMessage(chatId, thinkingMessage.message_id);
      } catch (deleteError) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
      }
      
      if (aiResponse.success) {
        // –°–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
        if (requestStatus.type === 'free') {
          await useFreeRequest(dbUser.id);
          const freeRequests = await getUserFreeRequests(dbUser.id);
          await bot.sendMessage(
            chatId, 
            aiResponse.message + `\n\nüÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: ${freeRequests.remaining}/7`
          );
        } else if (requestStatus.type === 'subscription') {
          await incrementRequestUsage(dbUser.id);
          await bot.sendMessage(chatId, aiResponse.message);
        } else {
          await bot.sendMessage(chatId, aiResponse.message);
        }
      } else {
        await bot.sendMessage(chatId, aiResponse.message);
      }
      return;
    }
    
    // === –£–¢–û–ß–ù–Ø–Æ–©–ò–ï –í–û–ü–†–û–°–´ –ö WORKFLOW ===
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ workflow –¥–ª—è —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    const workflowContext = userWorkflowContext.get(user.id);
    if (workflowContext && (Date.now() - workflowContext.timestamp) < 600000) { // 10 –º–∏–Ω—É—Ç
      console.log(`üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç workflow –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å`);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
      const requestStatus = await canUserMakeRequest(dbUser.id);
      if (!requestStatus.canMake) {
        if (requestStatus.type === 'free') {
          await bot.sendMessage(
            chatId, 
            `üÜì –ò—Å—á–µ—Ä–ø–∞–Ω –ª–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (${requestStatus.used}/${requestStatus.limit}).\n\nüíé –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É!`,
            subscriptionKeyboard
          );
        } else {
          await bot.sendMessage(
            chatId, 
            `üìä –ò—Å—á–µ—Ä–ø–∞–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (${requestStatus.used}/${requestStatus.limit}).\n\nüí≥ –ü—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã!`,
            subscriptionKeyboard
          );
        }
        return;
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –≤ Coze API —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
      await bot.sendChatAction(chatId, 'typing');
      const thinkingMessage = await bot.sendMessage(chatId, 'ü§î –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à –≤–æ–ø—Ä–æ—Å —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...');

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
      const messageWithContext = `–ö–û–ù–¢–ï–ö–°–¢ –ü–†–ï–î–´–î–£–©–ï–ì–û –ê–ù–ê–õ–ò–ó–ê:
–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞: ${workflowContext.type}
–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${workflowContext.userQuestion}"
–ü–æ–ª—É—á–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "${workflowContext.workflowResponse.substring(0, 1500)}..."

–£–¢–û–ß–ù–Ø–Æ–©–ò–ô –í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: ${text}

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.`;

      console.log(`üîç –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –≤ Coze API –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}`);
      
      const aiResponse = await runCozeChat(user.access_token, messageWithContext, user.id, '–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å‚Äë—Ç—Ä–µ–Ω–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–∏—Ç–∞–Ω–∏—é: –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã —Å–ø–∏—Å–∫–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.');

      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–¥—É–º–∞–µ—Ç"
      try {
        await bot.deleteMessage(chatId, thinkingMessage.message_id);
      } catch (deleteError) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
      }

      if (aiResponse.success) {
        // –û–±–Ω–æ–≤–ª—è–µ–º timestamp –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π
        workflowContext.timestamp = Date.now();
        
        // –°–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
        if (requestStatus.type === 'free') {
          await useFreeRequest(dbUser.id);
          const freeRequests = await getUserFreeRequests(dbUser.id);
          await bot.sendMessage(
            chatId, 
            aiResponse.message + `\n\nüÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: ${freeRequests.remaining}/7`
          );
        } else if (requestStatus.type === 'subscription') {
          await incrementRequestUsage(dbUser.id);
          await bot.sendMessage(chatId, aiResponse.message);
        } else {
          await bot.sendMessage(chatId, aiResponse.message);
        }
      } else {
        await bot.sendMessage(chatId, '‚ùå –ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      }
      return;
    }
    
    // === –ù–ï–û–ü–û–ó–ù–ê–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ===
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞ –∏ —ç—Ç–æ –Ω–µ –∫–Ω–æ–ø–∫–∞/–∫–æ–º–∞–Ω–¥–∞
    console.log(`User ${user.id} sent unrecognized message, showing main menu`);
    await bot.sendMessage(
      chatId,
      'ü§î –ù–µ –ø–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.\n\n' +
      'üí° –î–ª—è –æ–±—â–µ–Ω–∏—è —Å –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–æ–º –Ω–∞–∂–º–∏—Ç–µ "ü§ñ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä"',
      mainKeyboard
    );

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    await bot.sendMessage(chatId, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  }
}

async function handleCallbackQuery(bot, callbackQuery) {
  const chatId = callbackQuery.message.chat.id;
  const messageId = callbackQuery.message.message_id;
  const data = callbackQuery.data;
  const user = callbackQuery.from;

  try {
    await bot.answerCallbackQuery(callbackQuery.id);
    
    const dbUser = await getUserByTelegramId(user.id);

    switch (data) {
      case 'accept_agreement':
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–≥–ª–∞—Å–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        await updateUserAgreement(user.id, true);
        
        // –°–Ω–∞—á–∞–ª–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        await bot.editMessageText(
          '‚úÖ **–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ —É—Å–ª–æ–≤–∏–π!**\n\n' +
          'üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FitnessBotAI!\n\n' +
          'ü§ñ –Ø –≤–∞—à –ª–∏—á–Ω—ã–π –ò–ò-—Ç—Ä–µ–Ω–µ—Ä, –≥–æ—Ç–æ–≤—ã–π –ø–æ–º–æ—á—å –≤–∞–º –¥–æ—Å—Ç–∏—á—å –≤–∞—à–∏—Ö —Ñ–∏—Ç–Ω–µ—Å-—Ü–µ–ª–µ–π!\n\n' +
          '‚ú® –ß—Ç–æ —è —É–º–µ—é:\n' +
          '‚Ä¢ –°–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
          '‚Ä¢ –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é\n' +
          '‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å\n' +
          '‚Ä¢ –ú–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n\n' +
          'üí° –î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É!\n\n' +
          'üöÄ –ù–∞—á–Ω–µ–º –≤–∞—à –ø—É—Ç—å –∫ –∏–¥–µ–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ?',
          {
            chat_id: chatId,
            message_id: messageId,
            parse_mode: 'Markdown'
          }
        );
        
        // –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
        await bot.sendMessage(
          chatId,
          '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:',
          mainKeyboard
        );
        break;

      case 'decline_agreement':
        await bot.editMessageText(
          '‚ùå **–£—Å–ª–æ–≤–∏—è –Ω–µ –ø—Ä–∏–Ω—è—Ç—ã**\n\n' +
          '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –±–µ–∑ –ø—Ä–∏–Ω—è—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞–º –¥–æ—Å—Ç—É–ø –∫ –Ω–∞—à–µ–º—É —Å–µ—Ä–≤–∏—Å—É.\n\n' +
          '–ï—Å–ª–∏ –≤—ã –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è —Å —É—Å–ª–æ–≤–∏—è–º–∏.',
          {
            chat_id: chatId,
            message_id: messageId,
            parse_mode: 'Markdown'
          }
        );
        break;

      case 'show_subscription_plans':
        await bot.editMessageText(
          'üíé –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –ø–æ–¥–ø–∏—Å–∫–∏:\n\nüìÖ –ú–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - 999‚ÇΩ\n‚Ä¢ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é\n\nüìÖ –ì–æ–¥–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - 9990‚ÇΩ\n‚Ä¢ –í—Å—ë –∏–∑ –º–µ—Å—è—á–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏\n‚Ä¢ –°–∫–∏–¥–∫–∞ 17%\n‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
          {
            chat_id: chatId,
            message_id: messageId,
            ...subscriptionKeyboard
          }
        );
        break;

      case 'buy_basic':
        await showPaymentConfirmation(bot, chatId, messageId, 'basic');
        break;

      case 'buy_standard':
        await showPaymentConfirmation(bot, chatId, messageId, 'standard');
        break;

      case 'buy_premium':
        await showPaymentConfirmation(bot, chatId, messageId, 'premium');
        break;

      case 'confirm_payment_basic':
        await processPayment(bot, chatId, messageId, user.id, 'basic');
        break;

      case 'confirm_payment_standard':
        await processPayment(bot, chatId, messageId, user.id, 'standard');
        break;

      case 'confirm_payment_premium':
        await processPayment(bot, chatId, messageId, user.id, 'premium');
        break;

      case 'subscription_status':
        await showSubscriptionStatus(bot, chatId, messageId, dbUser.id);
        break;

      case 'extend_subscription':
        await bot.editMessageText(
          'üíé –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω:',
          {
            chat_id: chatId,
            message_id: messageId,
            ...subscriptionKeyboard
          }
        );
        break;

      case 'cancel_payment':
        await bot.editMessageText(
          '‚ùå –û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.\n\n–í—ã –º–æ–∂–µ—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.',
          {
            chat_id: chatId,
            message_id: messageId,
            ...noSubscriptionKeyboard
          }
        );
        break;

      case 'back_to_main':
        await bot.deleteMessage(chatId, messageId);
        await bot.sendMessage(chatId, 'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é', mainKeyboard);
        break;

      case 'help_ai':
        await bot.editMessageText(
          'ü§ñ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–æ–º:\n\n1. –ù–∞–∂–º–∏—Ç–µ "–ß–∞—Ç —Å –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–æ–º"\n2. –ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ —Ñ–∏—Ç–Ω–µ—Å–µ\n3. –ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç\n\nüí° –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:\n‚Ä¢ "–°–æ—Å—Ç–∞–≤—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –Ω–æ–≤–∏—á–∫–∞"\n‚Ä¢ "–ß—Ç–æ –µ—Å—Ç—å –ø–µ—Ä–µ–¥ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π?"\n‚Ä¢ "–ö–∞–∫ –Ω–∞–∫–∞—á–∞—Ç—å –ø—Ä–µ—Å—Å –¥–æ–º–∞?"',
          {
            chat_id: chatId,
            message_id: messageId,
            ...helpKeyboard
          }
        );
        break;

      case 'help_payment':
        await bot.editMessageText(
          'üí≥ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ:\n\n‚Ä¢ –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –Æ–ö–∞—Å—Å—É (–±–µ–∑–æ–ø–∞—Å–Ω–æ)\n‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã\n‚Ä¢ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n‚Ä¢ –í–æ–∑–º–æ–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π\n\nüìû –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–ø–ª–∞—Ç–æ–π? –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.',
          {
            chat_id: chatId,
            message_id: messageId,
            ...helpKeyboard
          }
        );
        break;

      case 'help_support':
        await bot.editMessageText(
          'üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞:\n\nüìß Email: support@fitnessbot.ai\nüì± Telegram: @fitness_support\n‚è∞ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 9:00-21:00 –ú–°–ö\n\nüïê –û–±—ã—á–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 2-4 —á–∞—Å–æ–≤.',
          {
            chat_id: chatId,
            message_id: messageId,
            ...helpKeyboard
          }
        );
        break;

      case 'mood_1':
      case 'mood_2':
      case 'mood_3':
      case 'mood_4':
      case 'mood_5':
        const moodValue = parseInt(data.split('_')[1]);
        const userState = userStates.get(user.id);
        
        if (userState && userState.action === 'waiting_mood_after') {
          const workout = activeWorkouts.get(user.id);
          if (workout) {
            workout.moodAfter = moodValue;
            
            await bot.editMessageText(
              'üìù **–§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**\n\n' +
              '–î–æ–±–∞–≤—å—Ç–µ –æ–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ:\n' +
              '‚Ä¢ –ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞?\n' +
              '‚Ä¢ –ö–∞–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?\n' +
              '‚Ä¢ –ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑?\n\n' +
              '‚úèÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å":',
              {
                chat_id: chatId,
                message_id: messageId,
                parse_mode: 'Markdown',
                reply_markup: {
                  inline_keyboard: [
                    [{ text: '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å', callback_data: 'skip_comment' }]
                  ]
                }
              }
            );
            userStates.set(user.id, { action: 'waiting_workout_notes' });
          }
        }
        break;

      case 'skip_comment':
        const skipUserState = userStates.get(user.id);
        if (skipUserState && skipUserState.action === 'waiting_workout_notes') {
          const workout = activeWorkouts.get(user.id);
          if (workout) {
            // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
            await completeWorkout(user.id, workout);
            activeWorkouts.delete(user.id);
            userStates.delete(user.id);
            
            await bot.editMessageText(
              '‚úÖ **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!**\n\n' +
              'üéâ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í–∞—à–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω–∞.\n\n' +
              'üìä –í—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ "üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞".',
              {
                chat_id: chatId,
                message_id: messageId,
                parse_mode: 'Markdown'
              }
            );
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            setTimeout(async () => {
              await bot.sendMessage(chatId, 'üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:', mainKeyboard);
            }, 2000);
          }
        }
        break;

      default:
        console.log('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π callback:', data);
    }

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback:', error);
    await bot.answerCallbackQuery(callbackQuery.id, {
      text: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.',
      show_alert: true
    });
  }
}

async function showSubscriptionMenu(bot, chatId, userId) {
  const subscription = await getActiveSubscription(userId);
  
  if (subscription) {
    const endDate = new Date(subscription.end_date);
    const daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
    
    const planNames = {
      'basic': '–ë–∞–∑–æ–≤—ã–π (100 –∑–∞–ø—Ä–æ—Å–æ–≤)',
      'standard': '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (300 –∑–∞–ø—Ä–æ—Å–æ–≤)', 
      'premium': '–ü—Ä–µ–º–∏—É–º (600 –∑–∞–ø—Ä–æ—Å–æ–≤)'
    };
    const remaining = subscription.requests_limit - subscription.requests_used;
    const message = `üíé –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞!\n\nüìÖ –ü–ª–∞–Ω: ${planNames[subscription.plan_type] || subscription.plan_type}\nüìà –ó–∞–ø—Ä–æ—Å—ã: ${subscription.requests_used}/${subscription.requests_limit} (–æ—Å—Ç–∞–ª–æ—Å—å: ${remaining})\n‚è∞ –î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${daysLeft} –¥–Ω–µ–π\nüìä –°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–Ω–∞`;
    
    await bot.sendMessage(chatId, message, manageSubscriptionKeyboard);
  } else {
    await bot.sendMessage(
      chatId,
      'üíé –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏\n\n–ü–æ–¥–ø–∏—Å–∫–∞ –¥–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫:\n‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–º—É –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É\n‚Ä¢ –ü—Ä–æ–≥—Ä–∞–º–º–∞–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n‚Ä¢ –°–æ–≤–µ—Ç–∞–º –ø–æ –ø–∏—Ç–∞–Ω–∏—é\n‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–µ',
      noSubscriptionKeyboard
    );
  }
}

async function showUserProfile(bot, chatId, user) {
  const subscription = await getActiveSubscription(user.id);
  const freeRequests = await getUserFreeRequests(user.id);
  
  let message = `üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å\n\n`;
  message += `üìõ –ò–º—è: ${user.first_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n`;
  message += `üÜî ID: ${user.telegram_id}\n`;
  message += `üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${new Date(user.created_at).toLocaleDateString('ru-RU')}\n\n`;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
  message += `üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: ${freeRequests.used}/${freeRequests.total} (–æ—Å—Ç–∞–ª–æ—Å—å: ${freeRequests.remaining})\n\n`;
  
  if (subscription) {
    const endDate = new Date(subscription.end_date);
    const daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
    const planNames = {
      'basic': '–ë–∞–∑–æ–≤—ã–π (100 –∑–∞–ø—Ä–æ—Å–æ–≤)',
      'standard': '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (300 –∑–∞–ø—Ä–æ—Å–æ–≤)', 
      'premium': '–ü—Ä–µ–º–∏—É–º (600 –∑–∞–ø—Ä–æ—Å–æ–≤)'
    };
    const remaining = subscription.requests_limit - subscription.requests_used;
    message += `üíé –ü–æ–¥–ø–∏—Å–∫–∞: –ê–∫—Ç–∏–≤–Ω–∞\n`;
    message += `üìä –ü–ª–∞–Ω: ${planNames[subscription.plan_type] || subscription.plan_type}\n`;
    message += `üìà –ó–∞–ø—Ä–æ—Å—ã: ${subscription.requests_used}/${subscription.requests_limit} (–æ—Å—Ç–∞–ª–æ—Å—å: ${remaining})\n`;
    message += `‚è∞ –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: ${daysLeft}`;
  } else {
    message += `üíé –ü–æ–¥–ø–∏—Å–∫–∞: –ù–µ –∞–∫—Ç–∏–≤–Ω–∞`;
  }

  await bot.sendMessage(chatId, message, mainKeyboard);
}

async function showPaymentConfirmation(bot, chatId, messageId, planType) {
  const plans = {
    'basic': { price: '150‚ÇΩ', requests: '100 –∑–∞–ø—Ä–æ—Å–æ–≤', name: '–ë–∞–∑–æ–≤—ã–π' },
    'standard': { price: '300‚ÇΩ', requests: '300 –∑–∞–ø—Ä–æ—Å–æ–≤', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π' },
    'premium': { price: '450‚ÇΩ', requests: '600 –∑–∞–ø—Ä–æ—Å–æ–≤', name: '–ü—Ä–µ–º–∏—É–º' }
  };
  
  const plan = plans[planType];
  const message = `üí≥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞\n\nüì¶ –ü–ª–∞–Ω: ${plan.name}\nüìä –õ–∏–º–∏—Ç: ${plan.requests} –≤ –º–µ—Å—è—Ü\nüí∞ –ö –æ–ø–ª–∞—Ç–µ: ${plan.price}\n\n‚úÖ –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`;
  
  await bot.editMessageText(message, {
    chat_id: chatId,
    message_id: messageId,
    ...confirmPaymentKeyboard(planType)
  });
}

async function processPayment(bot, chatId, messageId, telegramId, planType) {
  try {
    await bot.editMessageText('‚è≥ –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã...', {
      chat_id: chatId,
      message_id: messageId
    });

    const paymentResult = await createSubscriptionPayment(telegramId, planType);
    
    if (paymentResult.success) {
      const plans = {
        'basic': { price: '150‚ÇΩ', requests: '100 –∑–∞–ø—Ä–æ—Å–æ–≤', name: '–ë–∞–∑–æ–≤—ã–π' },
        'standard': { price: '300‚ÇΩ', requests: '300 –∑–∞–ø—Ä–æ—Å–æ–≤', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π' },
        'premium': { price: '450‚ÇΩ', requests: '600 –∑–∞–ø—Ä–æ—Å–æ–≤', name: '–ü—Ä–µ–º–∏—É–º' }
      };
      const plan = plans[planType];
      
      await bot.editMessageText(
        `üí≥ –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏\n\nüì¶ –ü–ª–∞–Ω: ${plan.name}\nüìä –õ–∏–º–∏—Ç: ${plan.requests} –≤ –º–µ—Å—è—Ü\nüí∞ –°—É–º–º–∞: ${plan.price}\n\nüîí –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –Æ–ö–∞—Å—Å–∞.\n\nüëÜ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ:`,
        {
          chat_id: chatId,
          message_id: messageId,
          ...paymentLinkKeyboard(paymentResult.paymentUrl)
        }
      );
    } else {
      await bot.editMessageText(
        `‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: ${paymentResult.error}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.`,
        {
          chat_id: chatId,
          message_id: messageId,
          ...subscriptionKeyboard
        }
      );
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞:', error);
    await bot.editMessageText(
      '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.',
      {
        chat_id: chatId,
        message_id: messageId,
        ...subscriptionKeyboard
      }
    );
  }
}

async function showSubscriptionStatus(bot, chatId, messageId, userId) {
  const subscription = await getActiveSubscription(userId);
  
  if (subscription) {
    const startDate = new Date(subscription.start_date);
    const endDate = new Date(subscription.end_date);
    const daysLeft = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
    
    const planNames = {
      'basic': '–ë–∞–∑–æ–≤—ã–π (100 –∑–∞–ø—Ä–æ—Å–æ–≤)',
      'standard': '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (300 –∑–∞–ø—Ä–æ—Å–æ–≤)', 
      'premium': '–ü—Ä–µ–º–∏—É–º (600 –∑–∞–ø—Ä–æ—Å–æ–≤)'
    };
    
    const remaining = subscription.requests_limit - subscription.requests_used;
    const message = `üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏\n\n‚úÖ –°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–Ω–∞\nüìÖ –ü–ª–∞–Ω: ${planNames[subscription.plan_type] || subscription.plan_type}\nüìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤: ${subscription.requests_used}/${subscription.requests_limit}\nüìä –û—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤: ${remaining}\nüóì –ù–∞—á–∞–ª–æ: ${startDate.toLocaleDateString('ru-RU')}\nüìÜ –û–∫–æ–Ω—á–∞–Ω–∏–µ: ${endDate.toLocaleDateString('ru-RU')}\n‚è∞ –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: ${daysLeft}\nüí∞ –°—É–º–º–∞: ${subscription.amount}‚ÇΩ`;
    
    if (messageId) {
      // –ï—Å–ª–∏ –µ—Å—Ç—å messageId, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      await bot.editMessageText(message, {
        chat_id: chatId,
        message_id: messageId,
        ...manageSubscriptionKeyboard
      });
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Ç messageId, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      await bot.sendMessage(chatId, message, manageSubscriptionKeyboard);
    }
  } else {
    const noSubMessage = '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏';
    
    if (messageId) {
      // –ï—Å–ª–∏ –µ—Å—Ç—å messageId, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      await bot.editMessageText(noSubMessage, {
        chat_id: chatId,
        message_id: messageId,
        ...noSubscriptionKeyboard
      });
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Ç messageId, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      await bot.sendMessage(chatId, noSubMessage, noSubscriptionKeyboard);
    }
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
async function handleWeightChart(bot, chatId, userId) {
  try {
    await bot.sendMessage(chatId, '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≥—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞...');
    
    console.log(`–ó–∞–ø—Ä–æ—Å –º–µ—Ç—Ä–∏–∫ –≤–µ—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
    const metrics = await getUserMetrics(userId, 'weight');
    console.log(`–ù–∞–π–¥–µ–Ω–æ –º–µ—Ç—Ä–∏–∫ –≤–µ—Å–∞: ${metrics.length}`);
    
    if (metrics.length === 0) {
      await bot.sendMessage(
        chatId,
        'üìä –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ.\n\n–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–æ–±–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—ã –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞ –∏–ª–∏ –∑–∞–ø–∏—à–∏—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É.',
        analyticsKeyboard
      );
      return;
    }

    console.log(`–ì–µ–Ω–µ—Ä–∏—Ä—É—é –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –º–µ—Ç—Ä–∏–∫:`, metrics.slice(0, 2));
    const chartPath = await generateWeightChart(metrics, userId);
    console.log(`–ü—É—Ç—å –∫ –≥—Ä–∞—Ñ–∏–∫—É: ${chartPath}`);
    
    if (!chartPath) {
      await bot.sendMessage(
        chatId,
        '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
        analyticsKeyboard
      );
      return;
    }

    await bot.sendPhoto(chatId, chartPath, {
      caption: 'üìà –í–∞—à –≥—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞\n\n–î–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Å–∏—Å—Ç–µ–º–µ.',
      ...analyticsKeyboard
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ –≤–µ—Å–∞:', error);
    await bot.sendMessage(
      chatId,
      '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
      analyticsKeyboard
    );
  }
}

async function handleWorkoutChart(bot, chatId, userId) {
  try {
    await bot.sendMessage(chatId, '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≥—Ä–∞—Ñ–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫...');
    
    const workouts = await getUserWorkouts(userId);
    
    if (workouts.length === 0) {
      await bot.sendMessage(
        chatId,
        'üèãÔ∏è‚Äç‚ôÇÔ∏è –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–ø–∏—Å–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É" –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.',
        analyticsKeyboard
      );
      return;
    }

    const chartPath = await generateWorkoutChart(workouts, userId);
    
    await bot.sendPhoto(chatId, chartPath, {
      caption: 'üèãÔ∏è‚Äç‚ôÇÔ∏è –í–∞—à –≥—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n\n–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ —Ç–∏–ø–∞–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥.',
      ...analyticsKeyboard
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:', error);
    await bot.sendMessage(
      chatId,
      '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
      analyticsKeyboard
    );
  }
}

async function handleProgressReport(bot, chatId, userId) {
  try {
    await bot.sendMessage(chatId, '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ...');
    
    const metrics = await getUserMetrics(userId);
    const workouts = await getUserWorkouts(userId);
    
    if (metrics.length === 0 && workouts.length === 0) {
      await bot.sendMessage(
        chatId,
        'üìä –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞.\n\n–î–æ–±–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –≤–µ—Å–µ –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞.',
        analyticsKeyboard
      );
      return;
    }

    const chartPath = await generateProgressChart(metrics, workouts, userId);
    const textReport = await generateTextReport(userId);
    
    await bot.sendPhoto(chatId, chartPath, {
      caption: `üìä –û–±—â–∏–π –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ\n\n${textReport}`,
      ...analyticsKeyboard
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞:', error);
    await bot.sendMessage(
      chatId,
      '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
      analyticsKeyboard
    );
  }
}

async function handleAchievements(bot, chatId, userId) {
  try {
    const achievements = await getUserAchievements(userId);
    
    if (achievements.length === 0) {
      await bot.sendMessage(
        chatId,
        'üèÜ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π.\n\n–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º - –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–µ –∑–∞—Å—Ç–∞–≤—è—Ç —Å–µ–±—è –∂–¥–∞—Ç—å!',
        analyticsKeyboard
      );
      return;
    }

    let message = 'üèÜ –í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:\n\n';
    achievements.forEach((achievement, index) => {
      const date = new Date(achievement.earned_date).toLocaleDateString('ru-RU');
      message += `${index + 1}. ${achievement.title}\n`;
      message += `   üìù ${achievement.description}\n`;
      message += `   üìÖ –ü–æ–ª—É—á–µ–Ω–æ: ${date}\n\n`;
    });

    await bot.sendMessage(chatId, message, analyticsKeyboard);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:', error);
    await bot.sendMessage(
      chatId,
      '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
      analyticsKeyboard
    );
  }
}

async function handleWorkoutType(bot, chatId, userId, workoutType) {
  const workoutTypeMap = {
    'üí™ –°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞': 'strength',
    'üèÉ‚Äç‚ôÇÔ∏è –ö–∞—Ä–¥–∏–æ': 'cardio',
    'üßò‚Äç‚ôÄÔ∏è –ô–æ–≥–∞/–†–∞—Å—Ç—è–∂–∫–∞': 'yoga',
    'üèãÔ∏è‚Äç‚ôÄÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è': 'functional'
  };

  const type = workoutTypeMap[workoutType];
  
  if (type === 'strength') {
    // –î–ª—è —Å–∏–ª–æ–≤–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
    await bot.sendMessage(
      chatId,
      'üí™ **–°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞**\n\n' +
      '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∑–∞–ø–∏—Å–∏:\n\n' +
      'üî• **–î–µ—Ç–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å** - –¥–æ–±–∞–≤–ª—è–π—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –ø–æ –º–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å –ø–æ–¥—Ö–æ–¥–∞–º–∏, –≤–µ—Å–∞–º–∏ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏\n\n' +
      '‚ö° **–ë—ã—Å—Ç—Ä–∞—è –∑–∞–ø–∏—Å—å** - –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∂–∏—Ç–µ –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ',
      {
        parse_mode: 'Markdown',
        reply_markup: {
          keyboard: [
            ['üî• –î–µ—Ç–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å'],
            ['‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–ø–∏—Å—å'],
            ['‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é']
          ],
          resize_keyboard: true,
          one_time_keyboard: false
        }
      }
    );
    return;
  }
  
  // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º
  try {
    // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É —Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    const duration = 60; // 60 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const calories = type === 'cardio' ? 400 : type === 'yoga' ? 200 : 300;
    const intensity = 3; // —Å—Ä–µ–¥–Ω—è—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
    const exercisesCount = type === 'functional' ? 6 : 4;
    
    await addWorkout(userId, type, duration, calories, intensity, exercisesCount, `–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞: ${workoutType}`);

    await bot.sendMessage(
      chatId,
      `‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ "${workoutType}" –∑–∞–ø–∏—Å–∞–Ω–∞!\n\n` +
      `üìä –î–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:\n` +
      `‚è± –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${duration} –º–∏–Ω—É—Ç\n` +
      `üî• –ö–∞–ª–æ—Ä–∏–∏: ${calories} –∫–∫–∞–ª\n` +
      `üìà –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: ${intensity}/5\n` +
      `üèãÔ∏è‚Äç‚ôÇÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–π: ${exercisesCount}\n\n` +
      `üí° –î–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤—ã–±–µ—Ä–∏—Ç–µ "üî• –î–µ—Ç–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å".`,
      workoutKeyboard
    );
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
    await bot.sendMessage(
      chatId,
      '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
      workoutKeyboard
    );
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ä–∞–∑–±–∏–≤–∫–æ–π
async function sendLongMessage(bot, chatId, message) {
  const MAX_MESSAGE_LENGTH = 4000; // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å –¥–ª—è Telegram –ª–∏–º–∏—Ç–∞ 4096
  
  if (message.length <= MAX_MESSAGE_LENGTH) {
    await bot.sendMessage(chatId, message + '\n\nüè† –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é: /menu');
  } else {
    // –†–∞–∑–±–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏
    const messageParts = [];
    let currentPart = '';
    const sentences = message.split(/(?<=[.!?])\s+/);
    
    for (const sentence of sentences) {
      if ((currentPart + sentence).length > MAX_MESSAGE_LENGTH) {
        if (currentPart.trim()) {
          messageParts.push(currentPart.trim());
        }
        currentPart = sentence + ' ';
      } else {
        currentPart += sentence + ' ';
      }
    }
    
    if (currentPart.trim()) {
      messageParts.push(currentPart.trim());
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
    for (let i = 0; i < messageParts.length; i++) {
      const part = messageParts[i];
      const isLast = i === messageParts.length - 1;
      const messageToSend = part + (isLast ? '\n\nüè† –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é: /menu' : `\n\nüìÑ –ß–∞—Å—Ç—å ${i + 1} –∏–∑ ${messageParts.length}`);
      
      await bot.sendMessage(chatId, messageToSend);
      
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
      if (!isLast) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ò–ò-–∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ Workflow API
async function handleSpecialAIRequest(bot, chatId, user, dbUser, text, processingMessage, requestType) {
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  userStates.delete(user.id);
  
  // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const subscription = await getActiveSubscription(dbUser.id);
  
  await bot.sendChatAction(chatId, 'typing');
  const thinkingMessage = await bot.sendMessage(chatId, `${processingMessage} –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"...`);
  
  try {
    // –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π workflow ID –¥–ª—è —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
    let workflowId = '';
    
    switch (requestType) {
      case 'training_program':
        workflowId = process.env.COZE_TRAINING_PROGRAM_WORKFLOW_ID;
        break;
      case 'nutrition_plan':
        workflowId = process.env.COZE_NUTRITION_PLAN_WORKFLOW_ID;
        break;
      case 'composition_analysis':
        workflowId = process.env.COZE_COMPOSITION_ANALYSIS_WORKFLOW_ID;
        break;
      case 'deep_research':
        workflowId = process.env.COZE_DEEP_RESEARCH_WORKFLOW_ID;
        break;
      default:
        workflowId = process.env.COZE_WORKFLOW_ID; // fallback
    }
    
    if (!workflowId) {
      throw new Error(`Workflow ID –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —Ç–∏–ø–∞: ${requestType}`);
    }
    
    console.log(`üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º ${requestType} workflow: ${workflowId}`);
    console.log(`üìù –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${text}"`);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è workflow
    const workflowParameters = {
      input: text,
      user_id: user.id.toString(),
      request_type: requestType
    };
    
    console.log(`üì¶ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã workflow:`, workflowParameters);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º workflow
    const workflowResponse = await runWorkflow(workflowId, workflowParameters);
    
    await bot.deleteMessage(chatId, thinkingMessage.message_id).catch(() => {});
    
    if (workflowResponse.success && workflowResponse.message) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º workflow
      const isInteractive = requestType === 'training_program' || requestType === 'nutrition_plan';
      
      if (isInteractive) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ workflow
        userInteractiveWorkflow.set(user.id, {
          type: requestType,
          workflowId: workflowId,
          initialMessage: text,
          eventId: workflowResponse.eventId, // –°–æ—Ö—Ä–∞–Ω—è–µ–º event_id –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
          timestamp: Date.now()
        });
        console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ workflow –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}: ${requestType}, eventId: ${workflowResponse.eventId}`);
      }
      
      await sendLongMessage(bot, chatId, workflowResponse.message);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç workflow –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞–≤–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
      if (!isInteractive) {
        userWorkflowContext.set(user.id, {
          type: requestType,
          userQuestion: text,
          workflowResponse: workflowResponse.message,
          timestamp: Date.now()
        });
        console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç workflow –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}: ${requestType}`);
      }
      
      // –£—á–∏—Ç—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
      await incrementRequestUsage(dbUser.id);
      console.log(`‚úÖ ${requestType} workflow –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ`);
    } else {
      console.error(`‚ùå –û—à–∏–±–∫–∞ ${requestType} workflow:`, workflowResponse.error);
      await bot.sendMessage(chatId, `‚ùå –ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò: ${workflowResponse.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
    }
    
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ${requestType} –∑–∞–ø—Ä–æ—Å–∞:`, error);
    await bot.deleteMessage(chatId, thinkingMessage.message_id).catch(() => {});
    await bot.sendMessage(chatId, '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ workflow –∑–∞–ø—Ä–æ—Å–æ–≤
async function handleWorkflowRequest(bot, chatId, user, dbUser, text, workflowEnvKey, processingMessage) {
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  userStates.delete(user.id);
  
  // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const subscription = await getActiveSubscription(dbUser.id);
  
  await bot.sendChatAction(chatId, 'typing');
  const thinkingMessage = await bot.sendMessage(chatId, `${processingMessage} –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"...`);
  
  const workflowId = process.env[workflowEnvKey];
  
  // –í—Å–µ workflow –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é input
  const workflowParameters = {
    input: text,
    user_id: user.id.toString(),
    user_profile: `User ID: ${user.id}, Subscription: ${subscription?.plan_type || 'none'}`
  };
  
  console.log('üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è workflow:', { workflowEnvKey, parameters: workflowParameters });
  
  const workflowResponse = await runWorkflow(
    workflowId,
    workflowParameters
  );
  
  // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–¥—É–º–∞–µ—Ç"
  try {
    await bot.deleteMessage(chatId, thinkingMessage.message_id);
  } catch (deleteError) {
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
  }
  
  if (workflowResponse.success) {
    // –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç –∏–∑ workflow
    let resultMessage = workflowResponse.message;
    try {
      const parsedData = JSON.parse(workflowResponse.data);
      if (parsedData.output_final) {
        resultMessage = parsedData.output_final;
      }
    } catch (parseError) {
      console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç workflow:', parseError.message);
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    let resultIcon = 'üìã';
    let workflowType = '–ê–Ω–∞–ª–∏–∑';
    if (workflowEnvKey.includes('DEEP_RESEARCH')) {
      resultIcon = 'üî¨';
      workflowType = '–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑';
    } else if (workflowEnvKey.includes('TRAINING_PROGRAM')) {
      resultIcon = 'üèãÔ∏è‚Äç‚ôÇÔ∏è';
      workflowType = '–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫';
    } else if (workflowEnvKey.includes('NUTRITION_PLAN')) {
      resultIcon = 'ü•ó';
      workflowType = '–ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è';
    } else if (workflowEnvKey.includes('COMPOSITION_ANALYSIS')) {
      resultIcon = 'üß™';
      workflowType = '–ê–Ω–∞–ª–∏–∑ –¥–æ–±–∞–≤–∫–∏';
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ workflow –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    userWorkflowContext.set(user.id, {
      type: workflowType,
      query: text,
      result: resultMessage,
      timestamp: Date.now()
    });
    
    console.log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç workflow –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}:`, {
      type: workflowType,
      query: text.substring(0, 100) + '...'
    });
    
    // –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏ (Telegram –ª–∏–º–∏—Ç 4096 —Å–∏–º–≤–æ–ª–æ–≤)
    const MAX_MESSAGE_LENGTH = 4000; // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å
    const fullMessage = `${resultIcon} **–†–µ–∑—É–ª—å—Ç–∞—Ç:**\n\n${resultMessage}`;
    
    if (fullMessage.length <= MAX_MESSAGE_LENGTH) {
      await bot.sendMessage(chatId, fullMessage + '\n\nüè† –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é: /menu');
    } else {
      // –†–∞–∑–±–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —á–∞—Å—Ç–∏
      const messageParts = [];
      let currentPart = `${resultIcon} **–†–µ–∑—É–ª—å—Ç–∞—Ç:**\n\n`;
      const sentences = resultMessage.split(/(?<=[.!?])\s+/);
      
      for (const sentence of sentences) {
        if ((currentPart + sentence).length > MAX_MESSAGE_LENGTH) {
          messageParts.push(currentPart.trim());
          currentPart = sentence + ' ';
        } else {
          currentPart += sentence + ' ';
        }
      }
      
      if (currentPart.trim()) {
        messageParts.push(currentPart.trim());
      }
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
      for (let i = 0; i < messageParts.length; i++) {
        const part = messageParts[i];
        const isLast = i === messageParts.length - 1;
        const messageToSend = part + (isLast ? '\n\nüè† –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é: /menu' : `\n\nüìÑ –ß–∞—Å—Ç—å ${i + 1} –∏–∑ ${messageParts.length}`);
        
        await bot.sendMessage(chatId, messageToSend);
        
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        if (!isLast) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }
    
    // –£—á–∏—Ç—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    await incrementRequestUsage(dbUser.id);
    
  } else {
    await bot.sendMessage(chatId, `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ${workflowResponse.error}\n\nüè† –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é: /menu`);
  }
}

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–• –î–ê–ù–ù–´–• ===

async function showWeightHistory(bot, chatId, userId) {
  try {
    const weightHistory = await getUserMetrics(userId, 'weight', 10);
    
    if (weightHistory.length === 0) {
      await bot.sendMessage(
        chatId,
        'üìä **–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Å–∞**\n\n‚ùå –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤–µ—Å–∞.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "‚öñÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å" –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏.',
        { parse_mode: 'Markdown', ...viewRecordsKeyboard }
      );
      return;
    }

    let message = 'üìä **–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Å–∞** (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π)\n\n';
    weightHistory.forEach((record, index) => {
      const date = new Date(record.recorded_at).toLocaleDateString('ru-RU');
      const isLatest = index === 0 ? ' ‚≠ê' : '';
      message += `üìÖ ${date}: **${record.value} ${record.unit}**${isLatest}\n`;
    });

    message += '\n‚≠ê - –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å';

    await bot.sendMessage(chatId, message, { parse_mode: 'Markdown', ...viewRecordsKeyboard });
  } catch (error) {
    await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –≤–µ—Å–∞.');
  }
}

async function showUserGoals(bot, chatId, userId) {
  try {
    const goals = await getUserGoals(userId);
    
    if (goals.length === 0) {
      await bot.sendMessage(
        chatId,
        'üéØ **–ú–æ–∏ —Ü–µ–ª–∏**\n\n‚ùå –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "üéØ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–ª—å" –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π —Ü–µ–ª–∏.',
        { parse_mode: 'Markdown', ...viewRecordsKeyboard }
      );
      return;
    }

    let message = 'üéØ **–ú–æ–∏ —Ü–µ–ª–∏**\n\n';
    goals.forEach((goal, index) => {
      const date = new Date(goal.created_at).toLocaleDateString('ru-RU');
      message += `${index + 1}. **${goal.goal_type}**\n`;
      message += `   üìä –¶–µ–ª—å: ${goal.target_value}\n`;
      message += `   üìÖ –°–æ–∑–¥–∞–Ω–∞: ${date}\n\n`;
    });

    await bot.sendMessage(chatId, message, { parse_mode: 'Markdown', ...viewRecordsKeyboard });
  } catch (error) {
    await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–µ–ª–µ–π.');
  }
}

async function showWorkoutHistory(bot, chatId, userId) {
  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º getUserDetailedWorkouts –≤–º–µ—Å—Ç–æ getUserWorkouts
    const workouts = await getUserDetailedWorkouts(userId, 10);
    
    if (workouts.length === 0) {
      await bot.sendMessage(
        chatId,
        'üèãÔ∏è‚Äç‚ôÇÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n\n' +
        'üìù –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.\n\n' +
        'üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "üèãÔ∏è‚Äç‚ôÇÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏!',
        { ...viewRecordsKeyboard }
      );
      return;
    }

    let message = 'üèãÔ∏è‚Äç‚ôÇÔ∏è –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)\n\n';
    workouts.forEach((workout, index) => {
      const date = new Date(workout.completed_at).toLocaleDateString('ru-RU');
      const time = new Date(workout.completed_at).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      const isLatest = index === 0 ? ' üåü' : '';
      
      message += `üìÖ ${date} –≤ ${time}${isLatest}\n`;
      message += `üí™ –¢–∏–ø: ${workout.workout_type === 'strength' ? '–°–∏–ª–æ–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞' : workout.workout_type}\n`;
      
      if (workout.duration_minutes > 0) {
        message += `‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${workout.duration_minutes} –º–∏–Ω\n`;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ –¥–æ –∏ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
      if (workout.mood_before || workout.mood_after) {
        message += `üòä –°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ: `;
        if (workout.mood_before) {
          message += `–¥–æ ${workout.mood_before}/10`;
        }
        if (workout.mood_before && workout.mood_after) {
          message += ` ‚Üí `;
        }
        if (workout.mood_after) {
          message += `–ø–æ—Å–ª–µ ${workout.mood_after}/10`;
        }
        message += `\n`;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
      if (workout.notes && workout.notes.trim()) {
        message += `üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${workout.notes}\n`;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ö
      if (workout.workout_details && workout.workout_details.exercises) {
        const details = workout.workout_details;
        const exerciseCount = details.exercises.length;
        const totalSets = details.exercises.reduce((sum, ex) => sum + ex.sets.length, 0);
        const totalReps = details.exercises.reduce((sum, ex) => 
          sum + ex.sets.reduce((setSum, set) => setSum + set.reps, 0), 0);
        const totalWeight = details.exercises.reduce((sum, ex) => 
          sum + ex.sets.reduce((setSum, set) => setSum + ((set.weight || 0) * set.reps), 0), 0);
        
        message += `üìä ${exerciseCount} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π ‚Ä¢ ${totalSets} –ø–æ–¥—Ö–æ–¥–æ–≤ ‚Ä¢ ${totalReps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π\n`;
        if (totalWeight > 0) {
          message += `‚öñÔ∏è –ü–æ–¥–Ω—è—Ç–æ —Å –æ—Ç—è–≥–æ—â–µ–Ω–∏–µ–º: ${totalWeight} –∫–≥\n`;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
        message += `\nüéØ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:\n`;
        details.exercises.forEach((ex, i) => {
          const exerciseTotalReps = ex.sets.reduce((sum, set) => sum + set.reps, 0);
          const exerciseWeight = ex.sets.length > 0 ? (ex.sets[0].weight || 0) : 0;
          const weightText = exerciseWeight === 0 ? '—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–µ—Å' : `${exerciseWeight} –∫–≥`;
          const avgReps = exerciseTotalReps > 0 ? Math.round(exerciseTotalReps / ex.sets.length) : 0;
          message += `   ${i + 1}. ${ex.name}: ${ex.sets.length}√ó${avgReps} (${weightText})\n`;
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ –∏–∑ –¥–µ—Ç–∞–ª–µ–π
        if (details.comments && details.comments.trim()) {
          message += `\nüí≠ –ó–∞–º–µ—Ç–∫–∏ –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ: ${details.comments}\n`;
        }
      }
      
      message += '\n' + '‚îÄ'.repeat(25) + '\n\n';
    });

    message += 'üåü - –ø–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞\n';
    message += 'üí° –§–æ—Ä–º–∞—Ç: –ø–æ–¥—Ö–æ–¥—ã√ó—Å—Ä–µ–¥–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è';

    await bot.sendMessage(chatId, message, { ...viewRecordsKeyboard });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:', error);
    await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.');
  }
}

async function showUserStatistics(bot, chatId, userId) {
  try {
    const summary = await getUserDataSummary(userId);
    const weightHistory = await getUserMetrics(userId, 'weight', 2); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 –∑–∞–ø–∏—Å–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    const workouts = await getUserWorkouts(userId, 30); // –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü
    
    let message = 'üìà **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**\n\n';
    
    // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    message += `üìä **–û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ:**\n`;
    message += `‚Ä¢ –ó–∞–ø–∏—Å–µ–π –≤–µ—Å–∞: **${summary.weightRecords}**\n`;
    message += `‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫: **${summary.workoutRecords}**\n`;
    message += `‚Ä¢ –¶–µ–ª–µ–π: **${summary.goalRecords}**\n\n`;
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–µ—Å–∞
    if (weightHistory.length >= 2) {
      const currentWeight = weightHistory[0].value;
      const previousWeight = weightHistory[1].value;
      const weightChange = currentWeight - previousWeight;
      const changeDirection = weightChange > 0 ? 'üìà' : weightChange < 0 ? 'üìâ' : '‚û°Ô∏è';
      
      message += `‚öñÔ∏è **–í–µ—Å:**\n`;
      message += `‚Ä¢ –¢–µ–∫—É—â–∏–π: **${currentWeight} –∫–≥**\n`;
      message += `‚Ä¢ –ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${changeDirection} **${Math.abs(weightChange).toFixed(1)} –∫–≥**\n\n`;
    } else if (weightHistory.length === 1) {
      message += `‚öñÔ∏è **–í–µ—Å:** **${weightHistory[0].value} –∫–≥**\n\n`;
    }
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –º–µ—Å—è—Ü
    if (workouts.length > 0) {
      const totalMinutes = workouts.reduce((sum, w) => sum + w.duration_minutes, 0);
      const totalCalories = workouts.reduce((sum, w) => sum + (w.calories_burned || 0), 0);
      const avgPerWeek = (workouts.length / 4).toFixed(1);
      
      message += `üèãÔ∏è‚Äç‚ôÇÔ∏è **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (30 –¥–Ω–µ–π):**\n`;
      message += `‚Ä¢ –í—Å–µ–≥–æ: **${workouts.length}**\n`;
      message += `‚Ä¢ –í—Ä–µ–º—è: **${Math.round(totalMinutes / 60)} —á ${totalMinutes % 60} –º–∏–Ω**\n`;
      if (totalCalories > 0) {
        message += `‚Ä¢ –ö–∞–ª–æ—Ä–∏–∏: **${totalCalories}**\n`;
      }
      message += `‚Ä¢ –í —Å—Ä–µ–¥–Ω–µ–º/–Ω–µ–¥–µ–ª—é: **${avgPerWeek}**\n`;
    }

    await bot.sendMessage(chatId, message, { parse_mode: 'Markdown', ...viewRecordsKeyboard });
  } catch (error) {
    await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.');
  }
}

// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ —á–∏—Å–ª–∞
function safeParseInt(str, min = 1, max = 100, fallback = null) {
  const num = parseInt(str);
  return (isNaN(num) || num < min || num > max) ? fallback : num;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
function parseMoodValue(text) {
  const moodMap = {
    'üò§ –ó–ª–æ–π': 1,
    'üòû –ì—Ä—É—Å—Ç–Ω—ã–π': 2,
    'üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ': 3,
    'üòä –•–æ—Ä–æ—à–æ': 4,
    'ü§© –û—Ç–ª–∏—á–Ω–æ': 5
  };
  return moodMap[text] || null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
function getMoodEmoji(value) {
  const moodEmojis = {
    1: 'üò§',
    2: 'üòû',
    3: 'üòê',
    4: 'üòä',
    5: 'ü§©'
  };
  return moodEmojis[value] || 'üòê';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
function formatWorkoutTime(minutes) {
  if (minutes < 60) {
    return `${minutes} –º–∏–Ω`;
  }
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return mins > 0 ? `${hours}—á ${mins}–º–∏–Ω` : `${hours}—á`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
async function completeWorkout(userId, workout) {
  try {
    // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –ø–æ telegram_id
    const dbUser = await getUserByTelegramId(userId);
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    const workoutDetails = {
      exercises: workout.exercises || [],
      totalExercises: (workout.exercises || []).length,
      totalSets: (workout.exercises || []).reduce((sum, ex) => sum + (ex.sets || []).length, 0),
      totalReps: (workout.exercises || []).reduce((sum, ex) => 
        sum + (ex.sets || []).reduce((setSum, set) => setSum + (set.reps || 0), 0), 0
      ),
      averageIntensity: 'medium',
      totalCalories: 0, // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç –∫–∞–ª–æ—Ä–∏–π –≤ –±—É–¥—É—â–µ–º
      duration: Math.round((Date.now() - workout.startTime) / 60000) // –≤ –º–∏–Ω—É—Ç–∞—Ö
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await saveDetailedWorkout(
      dbUser.id,
      workout.type || 'strength',
      workoutDetails.duration,
      workoutDetails,
      workout.moodBefore || 3,
      workout.moodAfter || 3,
      workout.generalComment || null
    );
    
    console.log(`‚úÖ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
    throw error;
  }
}

// === –§–£–ù–ö–¶–ò–ò –£–î–ê–õ–ï–ù–ò–Ø –ó–ê–ü–ò–°–ï–ô ===

async function handleDeleteLastWorkout(bot, chatId, userId) {
  try {
    const result = await deleteLastWorkout(userId);
    
    if (result.success) {
      const date = new Date(result.deletedAt).toLocaleDateString('ru-RU');
      const time = new Date(result.deletedAt).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      
      await bot.sendMessage(
        chatId,
        `‚úÖ **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞**\n\n` +
        `üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –æ—Ç ${date} –≤ ${time}`,
        { parse_mode: 'Markdown', ...mainKeyboard }
      );
    } else {
      await bot.sendMessage(
        chatId,
        `‚ùå **–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è**\n\n` +
        `${result.message}`,
        { parse_mode: 'Markdown', ...mainKeyboard }
      );
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
    await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.', { ...mainKeyboard });
  }
}

async function handleDeleteLastWeight(bot, chatId, userId) {
  try {
    const result = await deleteLastWeight(userId);
    
    if (result.success) {
      const date = new Date(result.deletedAt).toLocaleDateString('ru-RU');
      
      await bot.sendMessage(
        chatId,
        `‚úÖ **–ó–∞–ø–∏—Å—å –≤–µ—Å–∞ —É–¥–∞–ª–µ–Ω–∞**\n\n` +
        `üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å –≤–µ—Å–∞ ${result.value} –∫–≥ –æ—Ç ${date}`,
        { parse_mode: 'Markdown', ...mainKeyboard }
      );
    } else {
      await bot.sendMessage(
        chatId,
        `‚ùå **–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è**\n\n` +
        `${result.message}`,
        { parse_mode: 'Markdown', ...mainKeyboard }
      );
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ –≤–µ—Å–∞:', error);
    await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –≤–µ—Å–∞.', { ...mainKeyboard });
  }
}

async function confirmDeleteAllWorkouts(bot, chatId, userId) {
  await bot.sendMessage(
    chatId,
    '‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï!**\n\n' +
    'üóëÔ∏è –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å **–í–°–ï** —Å–≤–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏?\n\n' +
    '‚ùå –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ **–ù–ï–û–ë–†–ê–¢–ò–ú–û**!\n\n' +
    '–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞–ø–∏—à–∏—Ç–µ: `–£–î–ê–õ–ò–¢–¨ –í–°–ï –¢–†–ï–ù–ò–†–û–í–ö–ò`',
    { parse_mode: 'Markdown', ...mainKeyboard }
  );
  
  userStates.set(chatId, 'waiting_confirm_delete_all_workouts');
}

async function confirmDeleteAllWeights(bot, chatId, userId) {
  await bot.sendMessage(
    chatId,
    '‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï!**\n\n' +
    'üóëÔ∏è –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å **–í–°–ï** –∑–∞–ø–∏—Å–∏ –≤–µ—Å–∞?\n\n' +
    '‚ùå –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ **–ù–ï–û–ë–†–ê–¢–ò–ú–û**!\n\n' +
    '–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞–ø–∏—à–∏—Ç–µ: `–£–î–ê–õ–ò–¢–¨ –í–°–ï –í–ï–°–ê`',
    { parse_mode: 'Markdown', ...mainKeyboard }
  );
  
  userStates.set(chatId, 'waiting_confirm_delete_all_weights');
}

async function processDeleteAllWorkouts(bot, chatId, userId) {
  try {
    const result = await deleteAllWorkouts(userId);
    
    if (result.success) {
      await bot.sendMessage(
        chatId,
        `‚úÖ **–í—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —É–¥–∞–ª–µ–Ω—ã**\n\n` +
        `üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ: ${result.count} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫`,
        { parse_mode: 'Markdown', ...mainKeyboard }
      );
    } else {
      await bot.sendMessage(
        chatId,
        `‚ùå **–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è**\n\n` +
        `${result.message}`,
        { parse_mode: 'Markdown', ...mainKeyboard }
      );
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Å–µ—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:', error);
    await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.', { ...mainKeyboard });
  }
}

async function processDeleteAllWeights(bot, chatId, userId) {
  try {
    const result = await deleteAllWeights(userId);
    
    if (result.success) {
      await bot.sendMessage(
        chatId,
        `‚úÖ **–í—Å–µ –∑–∞–ø–∏—Å–∏ –≤–µ—Å–∞ —É–¥–∞–ª–µ–Ω—ã**\n\n` +
        `üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ: ${result.count} –∑–∞–ø–∏—Å–µ–π`,
        { parse_mode: 'Markdown', ...mainKeyboard }
      );
    } else {
      await bot.sendMessage(
        chatId,
        `‚ùå **–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è**\n\n` +
        `${result.message}`,
        { parse_mode: 'Markdown', ...mainKeyboard }
      );
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –≤–µ—Å–∞:', error);
    await bot.sendMessage(chatId, '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π –≤–µ—Å–∞.', { ...mainKeyboard });
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ workflow
async function handleInteractiveWorkflowResponse(bot, chatId, user, dbUser, userResponse, activeWorkflow) {
  try {
    console.log(`üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow: ${activeWorkflow.type}`);
    
    await bot.sendChatAction(chatId, 'typing');
    const thinkingMessage = await bot.sendMessage(chatId, 'ü§ñ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –≤–∞—à –æ—Ç–≤–µ—Ç...');

    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow —Å –æ—Ç–≤–µ—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const continueResponse = await continueInteractiveWorkflow(activeWorkflow.eventId, userResponse, activeWorkflow.type, user.id);

    await bot.deleteMessage(chatId, thinkingMessage.message_id).catch(() => {});

    if (continueResponse.success && continueResponse.message) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–π eventId (–æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –µ—Å—Ç—å –µ—â–µ –≤–æ–ø—Ä–æ—Å—ã)
      if (continueResponse.eventId) {
        // –≠—Ç–æ –µ—â–µ –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å - –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        activeWorkflow.eventId = continueResponse.eventId;
        activeWorkflow.timestamp = Date.now();
        userInteractiveWorkflow.set(user.id, activeWorkflow);
        console.log(`‚ùì –ü–æ–ª—É—á–µ–Ω —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –Ω–æ–≤—ã–π eventId: ${continueResponse.eventId}`);
      } else {
        // –≠—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç - —É–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ workflow
        userInteractiveWorkflow.delete(user.id);
        console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ workflow`);
        
        // –£—á–∏—Ç—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        await incrementRequestUsage(dbUser.id);
      }

      await sendLongMessage(bot, chatId, continueResponse.message);
      console.log(`‚úÖ –û—Ç–≤–µ—Ç –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow ${activeWorkflow.type} –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ`);
    } else {
      console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ workflow:`, continueResponse.error);
      
      // –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      userInteractiveWorkflow.delete(user.id);
      
      await bot.sendMessage(chatId, `‚ùå –ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É: ${continueResponse.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
    }

  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π workflow:`, error);
    
    // –£–¥–∞–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    userInteractiveWorkflow.delete(user.id);
    
    await bot.deleteMessage(chatId, thinkingMessage.message_id).catch(() => {});
    await bot.sendMessage(chatId, '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
}

// === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function handleUserState(bot, chatId, user, dbUser, text, currentState) {
  // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—Å—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
  // –û–Ω–∞ —É–∂–µ –µ—Å—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ handleTextMessage, –ø–æ—ç—Ç–æ–º—É –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É
  console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentState);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∂–∏–º–∞ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
async function handleAITrainerConversation(bot, chatId, user, dbUser, text) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
    const requestStatus = await canUserMakeRequest(dbUser.id);
    
    if (!requestStatus.canMake) {
      await bot.sendMessage(
        chatId,
        'üíé –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä—É.\n\n' +
        'üÜì –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç 7 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\n' +
        'üí™ –î–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É!',
        noSubscriptionKeyboard
      );
      return;
    }
    
    if (text === 'ü§ñ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä') {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
      let requestInfo = '';
      if (requestStatus.type === 'free') {
        requestInfo = `\n\nüÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: ${requestStatus.remaining}/7`;
      } else if (requestStatus.type === 'subscription') {
        requestInfo = `\n\nüíé –ó–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ: ${requestStatus.remaining}/${requestStatus.total}`;
      }

      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å –ò–ò
      userStates.set(user.id, 'chatting_with_ai');
      
      await bot.sendMessage(
        chatId,
        'ü§ñ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä!*\n\n' +
        '–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å:\n' +
        '‚Ä¢ –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–∞–º–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ –°–æ–≤–µ—Ç–∞–º–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é\n' +
        '‚Ä¢ –í–æ–ø—Ä–æ—Å–∞–º–∏ –æ –∑–¥–æ—Ä–æ–≤—å–µ –∏ —Ñ–∏—Ç–Ω–µ—Å–µ\n\n' +
        '–ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã!' + requestInfo,
        { parse_mode: 'Markdown' }
      );
      return;
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–µ–∂–∏–º–µ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–∞
    await bot.sendChatAction(chatId, 'typing');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –±–æ—Ç –¥—É–º–∞–µ—Ç
    const thinkingMessage = await bot.sendMessage(chatId, 'ü§ñ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ workflow
    const workflowContext = userWorkflowContext.get(user.id);
    let messageWithContext = text;
    
    if (workflowContext && (Date.now() - workflowContext.timestamp) < 600000) { // 10 –º–∏–Ω—É—Ç
      messageWithContext = `–ö–û–ù–¢–ï–ö–°–¢ –ü–†–ï–î–´–î–£–©–ï–ì–û –ê–ù–ê–õ–ò–ó–ê:
–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞: ${workflowContext.type}
–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${workflowContext.query}"
–ü–æ–ª—É—á–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "${workflowContext.result.substring(0, 1000)}..."

–ù–û–í–´–ô –í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: ${text}`;
      
      console.log(`üìã –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç workflow –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}`);
    }
    
    const aiResponse = await runCozeChat(user.access_token, messageWithContext, user.id, '–û—Ç–≤–µ—á–∞–π –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å‚Äë—Ç—Ä–µ–Ω–µ—Ä: –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã —Å–ø–∏—Å–∫–∞–º–∏, –∏–∑–±–µ–≥–∞–π –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.');
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–¥—É–º–∞–µ—Ç"
    try {
      await bot.deleteMessage(chatId, thinkingMessage.message_id);
    } catch (deleteError) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    }
    
    if (aiResponse.success) {
      await bot.sendMessage(chatId, aiResponse.message + '\n\nüè† –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é: /menu');
      // –£—á–∏—Ç—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
      await incrementRequestUsage(dbUser.id);
    } else {
      await bot.sendMessage(chatId, aiResponse.message);
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–µ:', error);
    await bot.sendMessage(chatId, '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ workflow –∫–æ–º–∞–Ω–¥
async function handleWorkflowCommands(bot, chatId, user, dbUser, text) {
  try {
    console.log(`üîß –ö–æ–º–∞–Ω–¥–∞ Coze –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}:`, text);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /deepresearch —á–µ—Ä–µ–∑ workflow
    if (text.toLowerCase().startsWith('/deepresearch')) {
      console.log('üî¨ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /deepresearch, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è');
      userStates.set(user.id, 'waiting_for_research_topic');
      
      await bot.sendMessage(chatId, 
        'üî¨ **–ì–ª—É–±–æ–∫–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ**\n\n' +
        '–£–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –Ω–∞—É—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.\n\n' +
        'üí° **–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–º:**\n' +
        '‚Ä¢ –í–ª–∏—è–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–Ω–∞ –Ω–∞ —Å–∏–ª–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏\n' +
        '‚Ä¢ –ì–µ–Ω–¥–µ—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –≤ —Å–∏–ª–æ–≤–æ–º —Ç—Ä–µ–Ω–∏–Ω–≥–µ\n' +
        '‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∫–∞—Ä–¥–∏–æ –∏ —Å–∏–ª–æ–≤—ã—Ö\n' +
        '‚Ä¢ –ü–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã\n' +
        '‚Ä¢ –°–ø–æ—Ä—Ç–∏–≤–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è\n\n' +
        'üìù –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ç–µ–º—É:'
      );
      console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏');
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /training_program —á–µ—Ä–µ–∑ workflow
    if (text.toLowerCase().startsWith('/training_program')) {
      console.log('üèãÔ∏è‚Äç‚ôÇÔ∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /training_program, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è');
      userStates.set(user.id, 'waiting_for_training_request');
      
      await bot.sendMessage(chatId, 
        'üèãÔ∏è‚Äç‚ôÇÔ∏è **–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã**\n\n' +
        '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ –æ –≤–∞—à–∏—Ö —Ü–µ–ª—è—Ö –∏ —É—Å–ª–æ–≤–∏—è—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:\n\n' +
        'üìã **–£–∫–∞–∂–∏—Ç–µ:**\n' +
        '‚Ä¢ –¶–µ–ª—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (–ø–æ—Ö—É–¥–µ–Ω–∏–µ, –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã, —Å–∏–ª–∞, –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å)\n' +
        '‚Ä¢ –£—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (–Ω–æ–≤–∏—á–æ–∫, —Å—Ä–µ–¥–Ω–∏–π, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)\n' +
        '‚Ä¢ –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é –≥–æ—Ç–æ–≤—ã —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è\n' +
        '‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É\n' +
        '‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–∑–∞–ª, –¥–æ–º, –∫–∞–∫–∏–µ —Å–Ω–∞—Ä—è–¥—ã)\n' +
        '‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∑–¥–æ—Ä–æ–≤—å—é (–µ—Å–ª–∏ –µ—Å—Ç—å)\n\n' +
        'üìù –û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:'
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /nutrition_plan —á–µ—Ä–µ–∑ workflow
    if (text.toLowerCase().startsWith('/nutrition_plan')) {
      console.log('ü•ó –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /nutrition_plan, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è');
      userStates.set(user.id, 'waiting_for_nutrition_request');
      
      await bot.sendMessage(chatId, 
        'ü•ó **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è**\n\n' +
        '–î–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è —É–∫–∞–∂–∏—Ç–µ:\n\n' +
        'üìä **–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**\n' +
        '‚Ä¢ –¶–µ–ª—å (–ø–æ—Ö—É–¥–µ–Ω–∏–µ, –Ω–∞–±–æ—Ä –º–∞—Å—Å—ã, –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞)\n' +
        '‚Ä¢ –ü–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ—Å—Ç, —Ç–µ–∫—É—â–∏–π –≤–µ—Å\n' +
        '‚Ä¢ –£—Ä–æ–≤–µ–Ω—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n' +
        '‚Ä¢ –°–∫–æ–ª—å–∫–æ –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ\n\n' +
        'üçΩÔ∏è **–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è:**\n' +
        '‚Ä¢ –ê–ª–ª–µ—Ä–≥–∏–∏ –∏–ª–∏ –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n' +
        '‚Ä¢ –û—Å–æ–±—ã–π —Ç–∏–ø –ø–∏—Ç–∞–Ω–∏—è (–≤–µ–≥–∞–Ω, –∫–µ—Ç–æ, –±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞ –∏ —Ç.–¥.)\n' +
        '‚Ä¢ –ù–µ–ª—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã\n' +
        '‚Ä¢ –ë—é–¥–∂–µ—Ç –Ω–∞ –ø–∏—Ç–∞–Ω–∏–µ\n\n' +
        'üìù –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ:'
      );
      return;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /composition_analysis —á–µ—Ä–µ–∑ workflow
    if (text.toLowerCase().startsWith('/composition_analysis')) {
      console.log('üß™ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /composition_analysis, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è');
      userStates.set(user.id, 'waiting_for_supplement_info');
      
      await bot.sendMessage(chatId, 
        'üß™ **–ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–∞–≤–∞ –¥–æ–±–∞–≤–∫–∏**\n\n' +
        '–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–±–∞–≤–∫–µ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:\n\n' +
        'üì∑ **–°–ø–æ—Å–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∫–∏:**\n' +
        '‚Ä¢ –§–æ—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∏ —Å —Å–æ—Å—Ç–∞–≤–æ–º\n' +
        '‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–∫–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è\n' +
        '‚Ä¢ –°–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å –¥–æ–∑–∏—Ä–æ–≤–∫–∞–º–∏\n\n' +
        'üîç **–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é:**\n' +
        '‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤\n' +
        '‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–æ–∑–∏—Ä–æ–≤–æ–∫\n' +
        '‚Ä¢ –ù–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è\n' +
        '‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é\n' +
        '‚Ä¢ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã\n\n' +
        'üìù –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–±–∞–≤–∫–µ:'
      );
      return;
    }
    
    // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
    await bot.sendMessage(
      chatId,
      '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n\n' +
      '‚Ä¢ `/deepresearch` - –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑\n' +
      '‚Ä¢ `/training_program` - –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n' +
      '‚Ä¢ `/nutrition_plan` - –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è\n' +
      '‚Ä¢ `/composition_analysis` - –∞–Ω–∞–ª–∏–∑ –¥–æ–±–∞–≤–æ–∫',
      mainKeyboard
    );
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ workflow –∫–æ–º–∞–Ω–¥—ã:', error);
    await bot.sendMessage(chatId, '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
async function showPaymentHistory(bot, chatId, userId) {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤–∫–ª—é—á–∞—è –∏—Å—Ç–µ–∫—à–∏–µ)
    const { getAllUserSubscriptions } = await import('../services/database.js');
    const subscriptions = await getAllUserSubscriptions(userId);
    
    if (subscriptions.length === 0) {
      await bot.sendMessage(
        chatId,
        'üìä **–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π**\n\n' +
        '‚ùå –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π.\n\n' +
        'üí° –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–µ—Ä–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –ò–ò-—Ç—Ä–µ–Ω–µ—Ä–æ–º!',
        { parse_mode: 'Markdown', ...subscriptionKeyboard }
      );
      return;
    }

    let message = 'üìä **–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π**\n\n';
    
    subscriptions.forEach((subscription, index) => {
      const startDate = new Date(subscription.start_date).toLocaleDateString('ru-RU');
      const endDate = new Date(subscription.end_date).toLocaleDateString('ru-RU');
      const createdDate = new Date(subscription.created_at).toLocaleDateString('ru-RU');
      
      const planNames = {
        'basic': '–ë–∞–∑–æ–≤—ã–π',
        'standard': '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π', 
        'premium': '–ü—Ä–µ–º–∏—É–º',
        'monthly': '–ú–µ—Å—è—á–Ω—ã–π'
      };
      
      const statusEmoji = subscription.status === 'active' ? '‚úÖ' : subscription.status === 'expired' ? '‚è∞' : '‚ùå';
      
      message += `${index + 1}. ${statusEmoji} **${planNames[subscription.plan_type] || subscription.plan_type}**\n`;
      message += `   üí∞ –°—É–º–º–∞: ${subscription.amount}‚ÇΩ\n`;
      message += `   üìÖ –ü–µ—Ä–∏–æ–¥: ${startDate} - ${endDate}\n`;
      message += `   üìä –°—Ç–∞—Ç—É—Å: ${subscription.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–∞' : subscription.status === 'expired' ? '–ò—Å—Ç–µ–∫–ª–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}\n`;
      message += `   üóì –û–ø–ª–∞—á–µ–Ω–∞: ${createdDate}\n`;
      if (subscription.status === 'active') {
        message += `   üìà –ó–∞–ø—Ä–æ—Å–æ–≤: ${subscription.requests_used}/${subscription.requests_limit}\n`;
      }
      message += '\n';
    });

    message += 'üí° –î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞–∂–º–∏—Ç–µ "üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"';

    await bot.sendMessage(chatId, message, { parse_mode: 'Markdown', ...subscriptionKeyboard });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π:', error);
    await bot.sendMessage(
      chatId,
      '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
      subscriptionKeyboard
    );
  }
}

